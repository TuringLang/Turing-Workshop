<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>More Julia and some Bayesian Inference</title>
<meta name="author" content="Tor Erlend Fjelde"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.1.0/reveal.css"/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.1.0/theme/white.css" id="theme"/>

<link rel="stylesheet" href="assets/css/custom.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><div><div style="margin: -200px auto; opacity: 0.2;"><p><object data="assets/images/turing-logo-wide.svg"></object></p></div><h1>More Julia and some Bayesian Inference</h1><h2>with the TuringLang ecosystem</h2><p><a href="https://github.com/TuringLang">https://github.com/TuringLang</a></p><p><a href="https://github.com/TuringLang/Turing-Workshop/tree/main/2023-Geilo-Winter-School/Part-2-Turing-and-other-things">The workshop is found here</a></p></div>
</section>

<section>
<section id="slide-org50c19ca">
<h2 id="org50c19ca">Aim of these two days</h2>
<p>
<i>Ideally</i>, you walk away from this workshop with the ability to <span class="underline">solve whatever research problem you have with Julia and Turing.jl</span><br />
</p>

<div class="fragment (appear)>"
<p>
<i>Likely</i>, you walk away from this workshop with <span class="underline">slightly</span> better understanding of how to solve your research problems with Julia and Turing.jl + <span class="underline">a whole lot of questions</span>.<br />
</p>
</div>

<div class="fragment (appear)>"
<p>
But we will do our best<br />
</p>
</div>

</section>
</section>
<section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy">
<h2 id="2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy">The story of a little Norwegian boy</h2>
</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
There once was a little Norwegian boy<br />
</p>


<div id="org7e12aa6" class="figure">
<p><img src="assets/attachments/2023-01-18_14-49-24_471337_3317365246956_1262712540_o.jpg" alt="2023-01-18_14-49-24_471337_3317365246956_1262712540_o.jpg" height="400px" /><br />
</p>
</div>


</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
When this little boy was 20 years old, he was working as a parking guard near Preikestolen/Pulpit rock<br />
</p>



<div id="org952eb96" class="figure">
<p><img src="assets/attachments/2023-01-18_14-57-08_Preikestolen-plateau-Go-Fjords-Bob-Engelsen-P1026771_kljg5o.jpeg" alt="2023-01-18_14-57-08_Preikestolen-plateau-Go-Fjords-Bob-Engelsen-P1026771_kljg5o.jpeg" height="400px" /><br />
</p>
</div>


</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
One day it was raining and there was nobody hiking, and so there was no cars in sight for the little boy to point<br />
</p>

<div class="fragment (appear)">

<p>
When his boss wasn't looking, the little 20 year-old boy had an amazing idea<br />
</p>

<blockquote >
<p>
Maybe I can use this method of Mr. Bayes I learned a bit about yesterday to model football / Premier League?<br />
</p>
</blockquote>

</div>

<p class="fragment (appear)">
The little boy got very excited and started looking for stuff on the big interwebs<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
The little boy came across this<br />
</p>


<div id="orgb6e44d9" class="figure">
<p><img src="assets/attachments/2023-01-18_14-46-02_Screenshot_20230118_144454.png" alt="2023-01-18_14-46-02_Screenshot_20230118_144454.png" /><br />
</p>
</div>

<p>
And got <span class="underline">very</span> excited<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
But at the time, the little boy knew next to <span class="underline">nothing</span> about programming<br />
</p>

<p>
The little boy couldn't write the code to do the inference<br />
</p>

<p class="fragment (appear)">
Whence the little boy became a <span class="underline">sad</span> little boy :(<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
But time heals all wounds, and at some point the little boy learned Python<br />
</p>

<p>
And in Python, the boy found the <i>probabilistic programming language</i> <code>pymc3</code><br />
</p>

<div class="fragment (appear)">
<blockquote >
<p>
Maybe I can use <code>pymc3</code> to perform inference in that football / Premier League model?<br />
</p>
</blockquote>

<p>
And so the sad boy once more became an <span class="underline">excited</span> little boy :)<br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
But there was a problem<br />
</p>

<p>
The boy wanted to write a for-loop in his model, but the model didn't want it to be so and complained!<br />
</p>

<p class="fragment (appear)">
The boy got frustrated and gave up, once more becoming a <span class="underline">sad</span> little boy :(<br />
</p>

<div class="small-text">

<p class="fragment (appear)">
The boy should have known that the computational backend <code>theano</code> that was used by <code>pymc3</code> at the time couldn't handle a for-loop, and instead he should have used <code>scan</code>. But the boy was only 20-something years old; he didn't know.<br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-The-story-of-a-little-Norwegian-boy-split">

<p>
Some years later the boy discovers a programming language called <span class="underline">Julia</span><br />
</p>

<div class="fragment (appear)">
<p>
Julia makes a few promises<br />
</p>
<ol>
<li class="fragment appear">It's fast. Like <i>really</i> fast.<br /></li>
<li class="fragment appear">It's interactive; doesn't require full compilation for you to play with it.<br /></li>
<li class="fragment appear">You don't have to specify types everywhere.<br /></li>

</ol>
</div>

<div class="fragment (appear)">
<p>
The boy thinks<br />
</p>

<blockquote >
<p>
Wait, but this sounds like Python but the only difference is that&#x2026;I CAN WRITE FOR-LOOPS WITHOUT FEELING BAD ABOUT IT?!<br />
</p>
</blockquote>

<p>
Yes, yes he could<br />
</p>

<p class="fragment (appear)">
And 3.5 years later, he's still writing for-loops. Well, sort of.<br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-But-it-really-is-fast">
<h3 id="2023-01-29-16-57-28-But-it-really-is-fast">But it really is fast</h3>

<div id="orgd11f526" class="figure">
<p><img src="assets/attachments/2023-01-18_15-31-28_Screenshot_20230118_153122.png" alt="2023-01-18_15-31-28_Screenshot_20230118_153122.png" height="400px" /><br />
</p>
<p><span class="figure-number">Figure 1: </span><a href="https://julialang.org/benchmarks/">https://julialang.org/benchmarks/</a> (2023-01-18)</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-But-it-really-is-fast-split">

<p>
And the consequences are<br />
</p>
<ul>
<li class="fragment appear">Even a naive implementation will be fairly fast!<br />
<ul>
<li>If you want to go faster, you just optimize the code <i>in Julia</i>!<br /></li>
<li>No need to drop down to C(++)<br /></li>

</ul></li>
<li class="fragment appear">⟹ "Every" package is written in Julia!<br />
<ul>
<li>Encountered a bug? Have to debug the <span class="underline">Julia</span> code<br /></li>
<li>Same language as you're writing in!<br /></li>

</ul></li>
<li class="fragment appear">⟹ Same for <i>extending</i> packages!<br />
<ul>
<li>Can change functions to experiment with code you don't even own!<br /></li>

</ul></li>

</ul>


<div class="fragment (appear)"
<p>
So all in all, it can be quite nice<br />
</p>
</div>

</section>
</section>
<section>
<section id="slide-2023-01-29-16-57-28-Before-we-begin">
<h2 id="2023-01-29-16-57-28-Before-we-begin">Before we begin</h2>
<p>
Make sure you're in the correct directory<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>pwd()
</code></pre>
</div>

<pre class="example">
"/drive-2/Projects/public/Turing-Workshop/2023-MRC-BSU-and-UKHSA/Part-2-More-Julia-and-some-Bayesian-inference"
</pre>


<p>
Then run something like (depending on which OS you are on)<br />
</p>

<div class="org-src-container">

<pre  class="src src-sh"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Add `-t N` to start Julia with N threads</span>
julia --project
</code></pre>
</div>

<p>
or if you're already in a REPL, do<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>]activate .
</code></pre>
</div>

<pre class="example">
Activating project at `/drive-2/Projects/public/Turing-Workshop/2023-MRC-BSU-and-UKHSA/Part-2-More-Julia-and-some-Bayesian-inference`
</pre>


<p>
to activate the project<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Before-we-begin-split">

<p>
And just to check that you're in the correct one<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>]status
</code></pre>
</div>

<pre class="example" id="org589a332">
Project Part2 v0.1.0
Status `/drive-2/Projects/public/Turing-Workshop/2023-MRC-BSU-and-UKHSA/Part-2-More-Julia-and-some-Bayesian-inference/Project.toml`
  [336ed68f] CSV v0.10.11
⌃ [052768ef] CUDA v4.4.1
  [124859b0] DataDeps v0.7.11
  [a93c6f00] DataFrames v1.6.1
  [2b5f629d] DiffEqBase v6.129.0
  [0c46a032] DifferentialEquations v7.9.1
  [31c24e10] Distributions v0.25.100
  [7073ff75] IJulia v1.24.2
  [7f7a1694] Optimization v3.17.0
  [36348300] OptimizationOptimJL v0.1.9
  [91a5bcdd] Plots v1.39.0
  [37e2e3b7] ReverseDiff v1.15.1
  [1ed8b502] SciMLSensitivity v7.39.0
  [4c63d2b9] StatsFuns v1.3.0
  [f3b207a7] StatsPlots v0.15.6
  [fce5fe82] Turing v0.29.1
  [0db1332d] TuringBenchmarking v0.3.2
  [ea0860ee] TuringCallbacks v0.4.0
  [0004c1f4] TuringGLM v2.8.1
  [ade2ca70] Dates
Info Packages marked with ⌃ have new versions available and may be upgradable.
</pre>

<p>
Download and install dependencies<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>]instantiate
</code></pre>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Before-we-begin-split">

<p>
And finally, do<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Part2
</code></pre>
</div>

<p>
to get some functionality I've implemented for the occasion<br />
</p>

</section>
</section>
<section>
<section id="slide-org3e1ffa5">
<h2 id="org3e1ffa5">Base &amp; Standard library</h2>
<p>
Julia is mainly a programing language for scientific computing<br />
</p>

<p>
⟹ Julia comes with tons of useful functionality built-in<br />
</p>
</section>
<section id="slide-org6b49a40">
<h3 id="org6b49a40"><code>Base</code></h3>
<p>
<a href="https://docs.julialang.org/en/v1/base/base/"><code>Base</code></a> is the only module which is <i>always</i> imported<br />
</p>

<p>
It contains the most fundamental functionality of the language, e.g.<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@which</span> map
</code></pre>
</div>

<pre class="example">
Base
</pre>


</section>
<section id="slide-org6b49a40-split">

<p>
Relevant modules you'll find in <code>Base</code><br />
</p>

<ul>
<li><a href="https://docs.julialang.org/en/v1/base/file/">Filesystem</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/base/io-network/">I/O and Network</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/base/iterators/">Iterators</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/base/multi-threading/">Threads</a><br /></li>

</ul>

</section>
<section id="slide-org0684476">
<h4 id="org0684476">Filesystem</h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>pwd()  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current working directory</span>
</code></pre>
</div>

<pre class="example">
"/drive-2/Projects/public/Turing-Workshop/2023-MRC-BSU-and-UKHSA/Part-2-More-Julia-and-some-Bayesian-inference"
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@which</span> pwd
</code></pre>
</div>

<pre class="example">
Base.Filesystem
</pre>


<p>
<a href="https://docs.julialang.org/en/v1/base/file/">https://docs.julialang.org/en/v1/base/file/</a><br />
</p>

</section>
<section id="slide-org0684476-split">

<p>
While we're at it, let's make ourselves a directory for the outputs<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #006699;">outputdir</span>(args...) = joinpath(<span style="color: #008000;">"assets"</span>, <span style="color: #008000;">"outputs"</span>, <span style="color: #008000;">"more-julia"</span>, args...)
</code></pre>
</div>

<pre class="example">
outputdir (generic function with 1 method)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>outputdir()
</code></pre>
</div>

<pre class="example">
"assets/outputs/more-julia"
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create it, if it doesn't exist</span>
mkpath(outputdir())
</code></pre>
</div>

<pre class="example">
"assets/outputs/more-julia"
</pre>

</section>
<section id="slide-orgeea6d0d">
<h4 id="orgeea6d0d">Multi-threading</h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>Threads
</code></pre>
</div>

<pre class="example">
Base.Threads
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>Threads.nthreads()
</code></pre>
</div>

<pre class="example">
4
</pre>


<p>
Or we can call <code>using Threads</code> so so we don't have to write <code>Threads.</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Base.Threads
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>nthreads()
</code></pre>
</div>

<pre class="example">
4
</pre>


</section>
<section id="slide-orgeea6d0d-split">

<p>
Making use of the threads is trivial<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>Threads.<span style="color: #808080;">@threads</span> <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> 1:10
    println(<span style="color: #008000;">"Thread $(Threads.threadid()): $i"</span>)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
Thread 1: 1
Thread 4: 2
Thread 4: 3
Thread 4: 9
Thread 4: 10
Thread 3: 7
Thread 3: 8
Thread 2: 4
Thread 2: 5
Thread 2: 6
</pre>


<p>
<a href="https://docs.julialang.org/en/v1/base/multi-threading/">https://docs.julialang.org/en/v1/base/multi-threading/</a><br />
</p>

</section>
<section id="slide-org59ba7ed">
<h3 id="org59ba7ed">Standard library</h3>
<p>
These are all the packages that come with Julia but you explicitly have to load with <code>using</code><br />
</p>

<div class="side-by-side">
<ul>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Pkg/">Pkg</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/LinearAlgebra/">LinearAlgebra</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/SparseArrays/">SparseArrays</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Statistics/">Statistics</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Random/">Random</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Distributed/">Distributed</a><br /></li>

</ul>
</div>

<div class="side-by-side">
<ul>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Logging/">Logging</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Dates/">Dates</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Serialization/">Serialization</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Downloads/">Downloads</a><br /></li>
<li><a href="https://docs.julialang.org/en/v1/stdlib/Test/">Unit testing</a><br /></li>

</ul>
</div>

</section>
<section id="slide-org77bccf5">
<h4 id="org77bccf5"><code>Dates</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Dates
before = Dates.now()
</code></pre>
</div>

<pre class="example">
2023-09-20T23:59:36.753
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>Dates.now() - before
</code></pre>
</div>

<pre class="example">
781 milliseconds
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>dump(before)
</code></pre>
</div>

<pre class="example">
DateTime
  instant: Dates.UTInstant{Millisecond}
    periods: Millisecond
      value: Int64 63830937576753
</pre>


<p>
<a href="https://docs.julialang.org/en/v1/stdlib/Dates/">https://docs.julialang.org/en/v1/stdlib/Dates/</a><br />
</p>

</section>
<section id="slide-orgeadbf2b">
<h4 id="orgeadbf2b"><code>Random</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Random
</code></pre>
</div>

<p>
We can set the "global" seed<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>Random.seed!(1234)
</code></pre>
</div>

<pre class="example">
TaskLocalRNG()
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>rand()
</code></pre>
</div>

<pre class="example">
0.32597672886359486
</pre>


<div class="fragment (appear)>"
<p>
Or provide the RNG explicitly<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Xoshiro is what Julia uses by default</span>
rng = Random.Xoshiro(1234)
rand(rng) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">&lt;= same as before</span>
</code></pre>
</div>

<pre class="example">
0.32597672886359486
</pre>

</div>

<div class="fragment (appear)>"
<p>
Most functions using RNGs follow this pattern of optionally accepting an RNG as the first argument<br />
</p>
</div>

</section>
<section id="slide-orgeadbf2b-split">

<p>
To sample multiple values, we just specify how many we want<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>rand(3)
</code></pre>
</div>

<pre class="example">
3-element Vector{Float64}:
 0.5490511363155669
 0.21858665481883066
 0.8942454282009883
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>rand(3, 3)
</code></pre>
</div>

<pre class="example">
3×3 Matrix{Float64}:
 0.520355  0.967143  0.951162
 0.639562  0.205168  0.0739957
 0.839622  0.527184  0.571586
</pre>


<div class="fragment (appear)>"
<p>
And we can also specify the type of the output<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>rand(Float32)
</code></pre>
</div>

<pre class="example">
0.07271612f0
</pre>

</div>

</section>
<section id="slide-orgeadbf2b-split">

<p>
And of course other standard sampling functions are available<br />
</p>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>randn()
</code></pre>
</div>

<pre class="example">
1.724189934074888
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>randexp()
</code></pre>
</div>

<pre class="example">
0.04221258127478853
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Sample uniformly from a vector</span>
rand([1, 2, 3])
</code></pre>
</div>

<pre class="example">
3
</pre>


<p>
And more: <a href="https://docs.julialang.org/en/v1/stdlib/Random/">https://docs.julialang.org/en/v1/stdlib/Random/</a><br />
</p>

</section>
<section id="slide-org8900f80">
<h4 id="org8900f80"><code>LinearAlgebra</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>A = [1 2 3; 4 1 6; 7 8 1]
</code></pre>
</div>

<pre class="example">
3×3 Matrix{Int64}:
 1  2  3
 4  1  6
 7  8  1
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> LinearAlgebra

norm(A), dot(A[:, 1], A[:, 3])
</code></pre>
</div>

<pre class="example">
(13.45362404707371, 34)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@which</span> norm
</code></pre>
</div>

<pre class="example">
LinearAlgebra
</pre>


<p>
Other functions are <code>det</code>, <code>dot</code>, <code>cholesky</code>, and much, much more.<br />
</p>

<p>
<a href="https://docs.julialang.org/en/v1/stdlib/LinearAlgebra/">https://docs.julialang.org/en/v1/stdlib/LinearAlgebra/</a><br />
</p>

</section>
<section id="slide-orgbf52d21">
<h4 id="orgbf52d21"><code>SparseArrays</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> SparseArrays
A_sparse = sparse([1, 1, 2, 3], [1, 3, 2, 3], [0, 1, 2, 0])
</code></pre>
</div>

<pre class="example">
3×3 SparseMatrixCSC{Int64, Int64} with 4 stored entries:
 0  ⋅  1
 ⋅  2  ⋅
 ⋅  ⋅  0
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>dropzeros(A_sparse)
</code></pre>
</div>

<pre class="example">
3×3 SparseMatrixCSC{Int64, Int64} with 2 stored entries:
 ⋅  ⋅  1
 ⋅  2  ⋅
 ⋅  ⋅  ⋅
</pre>


<p>
And standard array methods are applicable<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`A` is the dense array from earlier</span>
A * A_sparse
</code></pre>
</div>

<pre class="example">
3×3 Matrix{Int64}:
 0   4  1
 0   2  4
 0  16  7
</pre>


<p>
<a href="https://docs.julialang.org/en/v1/stdlib/SparseArrays/">https://docs.julialang.org/en/v1/stdlib/SparseArrays/</a><br />
</p>

</section>
<section id="slide-org1ecc49f">
<h4 id="org1ecc49f"><code>Statistics</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Statistics
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>mean(A), std(A)
</code></pre>
</div>

<pre class="example">
(3.6666666666666665, 2.7386127875258306)
</pre>


<p>
<a href="https://docs.julialang.org/en/v1/stdlib/Statistics/">https://docs.julialang.org/en/v1/stdlib/Statistics/</a><br />
</p>

</section>
<section id="slide-org867899f">
<h4 id="org867899f"><code>Distributed</code></h4>
<p>
Functionality for parallel computation across workers (either local or remote)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Distributed
nprocs()
</code></pre>
</div>

<pre class="example">
1
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Spawn a local worker</span>
addprocs(1)
</code></pre>
</div>

<pre class="example">
1-element Vector{Int64}:
 2
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Spawn a remote worker (this machine won't work on your computer)</span>
addprocs([<span style="color: #008000;">"tor@beastly"</span>], tunnel=<span style="color: #D0372D;">true</span>, dir=<span style="color: #008000;">"/tmp/"</span>)
</code></pre>
</div>

<pre class="example">
1-element Vector{Int64}:
 3
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>nprocs()
</code></pre>
</div>

<pre class="example">
3
</pre>


</section>
<section id="slide-org867899f-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Define something on all workers</span>
<span style="color: #808080;">@everywhere</span> <span style="color: #0000FF;">function</span> hostname_and_number(i)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Execute shell command on worker to get hostname.</span>
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Using `...` syntax for shell commands.</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This creates a `Cmd`, which is run once we call `read on it.</span>
    hostname = read(<span style="color: #008000;">`hostname`</span>, String)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Return a tuple of worker ID, hostname and the number.</span>
    <span style="color: #0000FF;">return</span> (myid(), i, chomp(hostname))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Run the function on all workers</span>
pmap(hostname_and_number, 1:12)
</code></pre>
</div>

<pre class="example" id="org9b8fea8">
12-element Vector{Tuple{Int64, Int64, SubString{String}}}:
 (2, 1, "tor-Prestige-15-A10SC")
 (3, 2, "beastly")
 (2, 3, "tor-Prestige-15-A10SC")
 (3, 4, "beastly")
 (2, 5, "tor-Prestige-15-A10SC")
 (2, 6, "tor-Prestige-15-A10SC")
 (2, 7, "tor-Prestige-15-A10SC")
 (2, 8, "tor-Prestige-15-A10SC")
 (2, 9, "tor-Prestige-15-A10SC")
 (2, 10, "tor-Prestige-15-A10SC")
 (2, 11, "tor-Prestige-15-A10SC")
 (2, 12, "tor-Prestige-15-A10SC")
</pre>

<p>
<a href="https://docs.julialang.org/en/v1/stdlib/Distributed/">https://docs.julialang.org/en/v1/stdlib/Distributed/</a><br />
</p>

</section>
<section id="slide-org4b70855">
<h4 id="org4b70855"><code>Logging</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>A = ones(Int, 4, 4)
v = ones(100)
<span style="color: #808080;">@info</span> <span style="color: #008000;">"Some variables"</span>  A  s=sum(v)
</code></pre>
</div>

<pre class="example">
┌ Info: Some variables
│   A =
│    4×4 Matrix{Int64}:
│     1  1  1  1
│     1  1  1  1
│     1  1  1  1
│     1  1  1  1
└   s = 100.0
</pre>


<p>
We can also change the logger for a particular block of code<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Logging
with_logger(NullLogger()) <span style="color: #0000FF;">do</span>
    <span style="color: #808080;">@info</span> <span style="color: #008000;">"Some variables"</span>  A  s=sum(v)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<p>
<a href="https://docs.julialang.org/en/v1/stdlib/Logging/">https://docs.julialang.org/en/v1/stdlib/Logging/</a><br />
</p>

</section>
<section id="slide-orgfe2f44a">
<h3 id="orgfe2f44a"><span class="todo TASK">TASK</span> Estimate \(\pi\)</h3>

<div id="orga1cd259" class="figure">
<p><img src="./assets/outputs/more-julia/pi.gif" alt="pi.gif" /><br />
</p>
</div>

<p>
<b>Extra:</b> Parallelize it.<br />
</p>


</section>
<section id="slide-orgcd5a917">
<h3 id="orgcd5a917"><span class="done SOLUTION">SOLUTION</span> Estimate \(\pi\)</h3>
<p>
Well, Julia has irrational numbers built-in<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>&#960;
</code></pre>
</div>

<pre class="example">
π = 3.1415926535897...
</pre>


<p>
So you could just do<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>Float64(&#960;)
</code></pre>
</div>

<pre class="example">
3.141592653589793
</pre>


<p>
But that's not fair.<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>num_within = 0; num_total = 1_000_000
<span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> 1:num_total
    x = 2 .* rand(2) .- 1
    <span style="color: #0000FF;">if</span> norm(x) &lt; 1
        num_within += 1
    <span style="color: #0000FF;">end</span>
<span style="color: #0000FF;">end</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Area of a circle = &#960;r^2 = &#960; * (1/2)^2 = &#960;/4</span>
4 * num_within / num_total
</code></pre>
</div>

<pre class="example">
3.143988
</pre>



<div id="orgf988669" class="figure">
<p><img src="./assets/outputs/more-julia/pi.gif" alt="pi.gif" /><br />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgbae0967">
<h2 id="orgbae0967">Scientific computing ecosystem</h2>
<div class="side-by-side">
<ul>
<li><a href="https://dataframes.juliadata.org/stable/">DataFrames.jl</a>, etc.<br /></li>
<li><a href="https://docs.juliaplots.org/stable/">Plots.jl</a>, etc.<br /></li>
<li><a href="https://juliastats.org/Distributions.jl/stable/">Distributions.jl</a>, etc.<br /></li>
<li><a href="https://docs.sciml.ai/Optimization/stable/">Optimization.jl</a> and all it contains<br /></li>

</ul>
</div>

<div class="side-by-side">
<ul>
<li><a href="https://docs.sciml.ai/DiffEqDocs/stable/">DifferentialEquations.jl</a><br /></li>
<li>Deep learning, e.g. <a href="https://fluxml.ai/Flux.jl/stable/">Flux.jl</a><br /></li>
<li>Automatic Differentiation<br /></li>
<li>BenchmarkTools.jl<br /></li>

</ul>
</div>

<p>
And more, of course<br />
</p>

</section>
</section>
<section>
<section id="slide-orgc298b1e">
<h2 id="orgc298b1e">Running example</h2>
<p>
An outbreak of influenza A (H1N1) in 1978 at a British boarding school<br />
</p>

<ul>
<li>763 male students -&gt; 512 of which became ill<br /></li>
<li>Reported that one infected boy started the epidemic<br /></li>
<li>Observations are number of boys in bed over 14 days<br /></li>

</ul>

<p>
Data are freely available in the R package <code>outbreaks</code>, maintained as part of the <a href="http://www.repidemicsconsortium.org/">R Epidemics Consortium</a><br />
</p>

</section>
</section>
<section>
<section id="slide-org92f68f3">
<h2 id="org92f68f3">DataFrames.jl</h2>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> DataFrames
</code></pre>
</div>

<p>
In Julia, the go-to for working with datasets is <code>DataFrames.jl</code><br />
</p>

<div class="small-text">

<p>
If you don't want to let go of the <code>tidyverse</code> and you don't mind a bunch of magic, you can use <a href="https://github.com/TidierOrg/Tidier.jl">https://github.com/TidierOrg/Tidier.jl</a><br />
</p>

</div>

</section>
<section id="slide-org92f68f3-split">

<p>
If you're already familiar with equivalents in R or Python, the following is a great reference: <a href="https://dataframes.juliadata.org/stable/man/comparisons/">https://dataframes.juliadata.org/stable/man/comparisons/</a><br />
</p>


<div id="orgad05af4" class="figure">
<p><img src=".more-julia/attachments/2023-09-15_11-49-35_Screenshot_20230915_114925.png" alt="2023-09-15_11-49-35_Screenshot_20230915_114925.png" /><br />
</p>
</div>

</section>
<section id="slide-org92f68f3-split">

<p>
There are many different ways to construct a <code>DataFrame</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df = DataFrame(A=1:3, B=5:7, fixed=1)
</code></pre>
</div>

<pre class="example">
3×3 DataFrame
 Row │ A      B      fixed 
     │ Int64  Int64  Int64 
─────┼─────────────────────
   1 │     1      5      1
   2 │     2      6      1
   3 │     3      7      1
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(Dict(<span style="color: #008000;">"A"</span> =&gt; 1:3, <span style="color: #008000;">"B"</span> =&gt; 5:7, <span style="color: #008000;">"fixed"</span> =&gt; 1))
</code></pre>
</div>

<pre class="example">
3×3 DataFrame
 Row │ A      B      fixed 
     │ Int64  Int64  Int64 
─────┼─────────────────────
   1 │     1      5      1
   2 │     2      6      1
   3 │     3      7      1
</pre>


<p>
Notice that columns are typed<br />
</p>

</section>
<section id="slide-org92f68f3-split">

<p>
Then we can interact with the <code>DataFrame</code> in a variety of ways<br />
</p>

</section>
<section id="slide-org92f68f3-split">

<p>
For example: indexing<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df.A
</code></pre>
</div>

<pre class="example">
3-element Vector{Int64}:
 1
 2
 3
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df.<span style="color: #008000;">"A"</span>  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">useful when column-names aren't valid Julia symbols</span>
</code></pre>
</div>

<pre class="example">
3-element Vector{Int64}:
 1
 2
 3
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df[:, <span style="color: #008000;">"A"</span>]
</code></pre>
</div>

<pre class="example">
3-element Vector{Int64}:
 1
 2
 3
</pre>


</section>
<section id="slide-org92f68f3-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df[:, [<span style="color: #D0372D;">:A</span>, <span style="color: #D0372D;">:B</span>]]
</code></pre>
</div>

<pre class="example">
3×2 DataFrame
 Row │ A      B     
     │ Int64  Int64 
─────┼──────────────
   1 │     1      5
   2 │     2      6
   3 │     3      7
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df[:, Not(<span style="color: #D0372D;">:fixed</span>)]
</code></pre>
</div>

<pre class="example">
3×2 DataFrame
 Row │ A      B     
     │ Int64  Int64 
─────┼──────────────
   1 │     1      5
   2 │     2      6
   3 │     3      7
</pre>


</section>
<section id="slide-org92f68f3-split">

<p>
All the standard functions are available, e.g.<br />
</p>
<ul>
<li><code>select</code><br /></li>
<li><code>transform</code><br /></li>
<li><code>groupby</code><br /></li>
<li>Different forms of <code>join</code><br /></li>
<li>Etc.<br /></li>

</ul>

<p>
There are too many functions to go through<br />
</p>

<p>
See the docs <a href="https://dataframes.juliadata.org/stable/">https://dataframes.juliadata.org/stable/</a> for a thorough overview<br />
</p>

</section>
<section id="slide-org213d5d7">
<h3 id="org213d5d7">Actual data</h3>
<p>
Let's load the actual data<br />
</p>

<p>
Our data is a CSV file<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>readdir(<span style="color: #008000;">"data"</span>)
</code></pre>
</div>

<pre class="example">
3-element Vector{String}:
 "influenza_england_1978_school.csv"
 "pest_data.csv"
 "time-series.csv"
</pre>


<p>
Functionality for different file formats is usually provided by separate packages:<br />
</p>
<ul>
<li><a href="https://github.com/JuliaData/CSV.jl">CSV.jl</a><br /></li>
<li><a href="https://github.com/JuliaData/Arrow.jl">Arrow.jl</a> (Apache Arrow)<br /></li>
<li><a href="https://github.com/JuliaData/RData.jl">RData.jl</a> (R data files)<br /></li>
<li><a href="https://felipenoris.github.io/XLSX.jl/stable/">XLSX.jl</a> (Excel files)<br /></li>
<li>And more.<br /></li>

</ul>

</section>
<section id="slide-org213d5d7-split">

<p>
In our case, we're working with a CSV file, so we'll use <code>CSV.jl</code>:<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> CSV
datafile = CSV.File(joinpath(<span style="color: #008000;">"data"</span>, <span style="color: #008000;">"influenza_england_1978_school.csv"</span>));
</code></pre>
</div>

<p>
And then we can convert this <code>CSV.File</code> into a <code>DataFrame</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>data = DataFrame(datafile)
</code></pre>
</div>

<pre class="example" id="org61cdf2d">
14×4 DataFrame
 Row │ Column1  date        in_bed  convalescent 
     │ Int64    Date        Int64   Int64        
─────┼───────────────────────────────────────────
   1 │       1  1978-01-22       3             0
   2 │       2  1978-01-23       8             0
   3 │       3  1978-01-24      26             0
   4 │       4  1978-01-25      76             0
   5 │       5  1978-01-26     225             9
   6 │       6  1978-01-27     298            17
   7 │       7  1978-01-28     258           105
   8 │       8  1978-01-29     233           162
   9 │       9  1978-01-30     189           176
  10 │      10  1978-01-31     128           166
  11 │      11  1978-02-01      68           150
  12 │      12  1978-02-02      29            85
  13 │      13  1978-02-03      14            47
  14 │      14  1978-02-04       4            20
</pre>

</section>
<section id="slide-org213d5d7-split">

<blockquote >
<p>
Woah, how does this work? We just passed a <code>CSV.File</code> to <code>DataFrames.DataFrame</code>, and <span class="underline">it just works</span>?!<br />
</p>
</blockquote>

<p>
Aye, that's right<br />
</p>

<p>
This is thanks to <a href="https://tables.juliadata.org/stable/">Tables.jl</a>, a simple interface for tabular data<br />
</p>

<p>
Such light-weight interface packages allow modules to seemlessly interact with each other without explicit dependencies<br />
</p>

<p>
This is a very typical pattern in Julia<br />
</p>

</section>
</section>
<section>
<section id="slide-orga162f9e">
<h2 id="orga162f9e">Distributions.jl</h2>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Distributions
</code></pre>
</div>

<p>
In Julia, the go-to for working with distributions is <a href="https://juliastats.org/Distributions.jl/stable/"><code>Distributions.jl</code></a><br />
</p>

<p>
This package provides a large number of distributions<br />
</p>

<p>
Used throughout the Julia community, e.g. <code>Turing</code> uses this<br />
</p>

</section>
<section id="slide-orga162f9e-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>dist = Normal()
</code></pre>
</div>

<pre class="example">
Normal{Float64}(μ=0.0, σ=1.0)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>mean(dist), var(dist)
</code></pre>
</div>

<pre class="example">
(0.0, 1.0)
</pre>


<p>
Remeber the <code>Random.rand</code> function from earlier? This now also accepts a <code>Distribution</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>x = rand(dist)
</code></pre>
</div>

<pre class="example">
0.7638013704669433
</pre>


</section>
<section id="slide-orga162f9e-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>logpdf(dist, x)
</code></pre>
</div>

<pre class="example">
-1.2106347999682632
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>cdf(dist, 0.5)
</code></pre>
</div>

<pre class="example">
0.6914624612740131
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>quantile.(Normal(), [0.05, 0.5, 0.95])
</code></pre>
</div>

<pre class="example">
3-element Vector{Float64}:
 -1.6448536269514724
  0.0
  1.6448536269514717
</pre>


<p>
There is also maximum likelihood estimation (MLE)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>xs = rand(Normal(1, 2), 100)
fit(Normal, xs)
</code></pre>
</div>

<pre class="example">
Normal{Float64}(μ=1.0397121670324303, σ=1.8650444781860653)
</pre>


</section>
<section id="slide-orga162f9e-split">

<p>
But exactly what distributions are there?<br />
</p>

<p>
Well, we can just check by inspecting the subtypes of <code>Distribution</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Filter away abstract types.</span>
nonabstract_dist_subtypes = filter(!isabstracttype, subtypes(Distribution))
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Filter away types which are not found in Distributions.jl.</span>
dist_types_from_distributions = filter(
    Base.Fix1(hasproperty, Distributions) &#8728; Symbol,
    nonabstract_dist_subtypes
)
</code></pre>
</div>

<pre class="example" id="org16bcaac">
84-element Vector{Any}:
 Arcsine
 Bernoulli
 BernoulliLogit
 Beta
 BetaBinomial
 BetaPrime
 Binomial
 Biweight
 Cauchy
 Chernoff
 Chi
 Chisq
 Cosine
 ⋮
 Soliton
 StudentizedRange
 SymTriangularDist
 TDist
 TriangularDist
 Triweight
 Truncated
 Uniform
 VonMises
 VonMisesFisher
 Weibull
 Wishart
</pre>

</section>
<section id="slide-orga162f9e-split">

<p>
Okay, there are a bit too many<br />
</p>

<p>
Let's separate between different variate types<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>filter(x -&gt; x &lt;: <span style="color: #6434A3;">UnivariateDistribution</span>, dist_types_from_distributions)
</code></pre>
</div>

<pre class="example" id="org7c10b5d">
70-element Vector{Any}:
 Arcsine
 Bernoulli
 BernoulliLogit
 Beta
 BetaBinomial
 BetaPrime
 Binomial
 Biweight
 Cauchy
 Chernoff
 Chi
 Chisq
 Cosine
 ⋮
 SkewNormal
 SkewedExponentialPower
 Soliton
 StudentizedRange
 SymTriangularDist
 TDist
 TriangularDist
 Triweight
 Truncated
 Uniform
 VonMises
 Weibull
</pre>

</section>
<section id="slide-orga162f9e-split">

<p>
Too many<br />
</p>

<p>
Let's convert it into a <code>Matrix</code> and force Julia to show all columns<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>show(
    IOContext(stdout, <span style="color: #D0372D;">:limit</span> =&gt; <span style="color: #D0372D;">false</span>),
    <span style="color: #008000;">"text/plain"</span>,
    reshape(filter(x -&gt; x &lt;: <span style="color: #6434A3;">UnivariateDistribution</span>, dist_types_from_distributions), 10, :)
)
</code></pre>
</div>

<pre class="example" id="orge3e59b2">
10×7 Matrix{Any}:
 Arcsine         Chi                    Frechet                  KSDist       LogitNormal            PGeneralizedGaussian    Soliton
 Bernoulli       Chisq                  Gamma                    KSOneSided   NegativeBinomial       Pareto                  StudentizedRange
 BernoulliLogit  Cosine                 GeneralizedExtremeValue  Kolmogorov   NoncentralBeta         Poisson                 SymTriangularDist
 Beta            Dirac                  GeneralizedPareto        Kumaraswamy  NoncentralChisq        PoissonBinomial         TDist
 BetaBinomial    DiscreteNonParametric  Geometric                Laplace      NoncentralF            Rayleigh                TriangularDist
 BetaPrime       DiscreteUniform        Gumbel                   Levy         NoncentralT            Rician                  Triweight
 Binomial        Epanechnikov           Hypergeometric           Lindley      Normal                 Semicircle              Truncated
 Biweight        Erlang                 InverseGamma             LogNormal    NormalCanon            Skellam                 Uniform
 Cauchy          Exponential            InverseGaussian          LogUniform   NormalInverseGaussian  SkewNormal              VonMises
 Chernoff        FDist                  JohnsonSU                Logistic     OrderStatistic         SkewedExponentialPower  Weibull
</pre>

</section>
<section id="slide-orga162f9e-split">

<p>
Now for multivariate distributions<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>filter(x -&gt; x &lt;: <span style="color: #6434A3;">MultivariateDistribution</span>, dist_types_from_distributions)
</code></pre>
</div>

<pre class="example">
6-element Vector{Any}:
 Dirichlet
 DirichletMultinomial
 JointOrderStatistics
 Multinomial
 Product
 VonMisesFisher
</pre>


<div class="fragment (appear)>"
<p>
And matrix distributions<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>filter(x -&gt; x &lt;: <span style="color: #6434A3;">MatrixDistribution</span>, dist_types_from_distributions)
</code></pre>
</div>

<pre class="example">
7-element Vector{Any}:
 InverseWishart
 LKJ
 MatrixBeta
 MatrixFDist
 MatrixNormal
 MatrixTDist
 Wishart
</pre>

</div>

</section>
</section>
<section>
<section id="slide-org835d2f9">
<h2 id="org835d2f9">Plots.jl</h2>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Plots
</code></pre>
</div>

<p>
The most commonly used plotting library is <a href="https://docs.juliaplots.org/stable/">Plots.jl</a><br />
</p>

</section>
<section id="slide-org835d2f9-split">

<p>
Has many backends, including:<br />
</p>
<ul>
<li>GR<br /></li>
<li>PyPlot<br /></li>
<li>Plotly<br /></li>
<li>Unicode<br /></li>
<li>PGFPlots<br /></li>
<li>And more<br /></li>

</ul>

<p>
<span class="underline">But</span> the code is the same for all backends<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GR is used by default</span>
Plots.backend()
</code></pre>
</div>

<pre class="example">
Plots.GRBackend()
</pre>


</section>
<section id="slide-org835d2f9-split">

<div class="side-by-side">

<div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>p1 = plot(1:10, rand(10), size=(450, 200))
</code></pre>
</div>


<div id="org2560471" class="figure">
<p><img src="assets/outputs/more-julia/16d623348c3f18f48e1304d2e2300b5e289e1b86.svg" alt="16d623348c3f18f48e1304d2e2300b5e289e1b86.svg" class="org-svg" /><br />
</p>
</div>

</div>

<div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>p2 = scatter(1:10, rand(10), size=(450, 200))
</code></pre>
</div>


<div id="org9a2fb5e" class="figure">
<p><img src="assets/outputs/more-julia/7cc0dffb8818815a0ac1bd1a2ed82b37365dceba.svg" alt="7cc0dffb8818815a0ac1bd1a2ed82b37365dceba.svg" class="org-svg" /><br />
</p>
</div>

</div>

</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(p1, p2, layout=(1, 2), size=(800, 200))
</code></pre>
</div>


<div id="orgb50f16a" class="figure">
<p><img src="assets/outputs/more-julia/98e1cf87a13e33c358badda9dd87043e02cc227a.svg" alt="98e1cf87a13e33c358badda9dd87043e02cc227a.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-org835d2f9-split">

<p>
A neat example from <a href="https://docs.juliaplots.org/stable/#simple-is-beautiful">the docs</a><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Define the Lorenz attractor</span>
Base.<span style="color: #808080;">@kwdef</span> <span style="color: #0000FF;">mutable struct</span> <span style="color: #6434A3;">Lorenz</span>
    dt::<span style="color: #6434A3;">Float64</span> = 0.02
    &#963;::<span style="color: #6434A3;">Float64</span> = 10
    &#961;::<span style="color: #6434A3;">Float64</span> = 28
    &#946;::<span style="color: #6434A3;">Float64</span> = 8/3
    x::<span style="color: #6434A3;">Float64</span> = 1
    y::<span style="color: #6434A3;">Float64</span> = 1
    z::<span style="color: #6434A3;">Float64</span> = 1
<span style="color: #0000FF;">end</span>

<span style="color: #0000FF;">function</span> <span style="color: #006699;">step!</span>(l::<span style="color: #6434A3;">Lorenz</span>)
    dx = l.&#963; * (l.y - l.x)
    dy = l.x * (l.&#961; - l.z) - l.y
    dz = l.x * l.y - l.&#946; * l.z
    l.x += l.dt * dx
    l.y += l.dt * dy
    l.z += l.dt * dz
<span style="color: #0000FF;">end</span>

attractor = Lorenz()
</code></pre>
</div>

<pre class="example">
Lorenz(0.02, 10.0, 28.0, 2.6666666666666665, 1.0, 1.0, 1.0)
</pre>


</section>
<section id="slide-org835d2f9-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Initialize a 3D plot with 1 empty series</span>
plt = plot3d(
    1,
    xlim = (-30, 30),
    ylim = (-30, 30),
    zlim = (0, 60),
    title = <span style="color: #008000;">"Lorenz Attractor"</span>,
    legend = <span style="color: #D0372D;">false</span>,
    marker = 2,
)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Build an animated gif by pushing new points to the plot, saving every 10th frame</span>
anim = <span style="color: #808080;">@animate</span> <span style="color: #0000FF;">for</span> i<span style="color: #0000FF;">=</span>1:1500
    step!(attractor)
    push!(plt, attractor.x, attractor.y, attractor.z)
<span style="color: #0000FF;">end</span> every 10
gif(anim, outputdir(<span style="color: #008000;">"lorenz.gif"</span>));
</code></pre>
</div>

<pre class="example">
[ Info: Saved animation to /drive-2/Projects/public/Turing-Workshop/2023-MRC-BSU-and-UKHSA/Part-2-More-Julia-and-some-Bayesian-inference/assets/outputs/more-julia/lorenz.gif
</pre>


</section>
<section id="slide-org835d2f9-split">


<div id="org1136db5" class="figure">
<p><img src="./assets/outputs/more-julia/lorenz.gif" alt="lorenz.gif" /><br />
</p>
</div>

</section>
<section id="slide-org01ebd8a">
<h3 id="org01ebd8a">Ecosystem</h3>
<p>
Plots.jl also has a very nice recipe-system<br />
</p>

<p>
Allows you to define how to plot your own types<br />
</p>

<p>
As a result, packages often define customized plotting recipes for their types<br />
</p>

<p>
<a href="https://docs.juliaplots.org/latest/ecosystem/#Community-packages">https://docs.juliaplots.org/latest/ecosystem/#Community-packages</a><br />
</p>

</section>
<section id="slide-orgfd3853c">
<h3 id="orgfd3853c">StatsPlots.jl</h3>
<p>
For us, <a href="https://github.com/JuliaPlots/StatsPlots.jl">StatsPlots.jl</a> is particularly relevant<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> StatsPlots
</code></pre>
</div>

<p>
It contains custom plotting functionality for dataframes and distibutions<br />
</p>

</section>
<section id="slide-orgfd3853c-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(Normal())
</code></pre>
</div>


<div id="org195d741" class="figure">
<p><img src="assets/outputs/more-julia/348bd16b3b818fcfbedfaf14f50cb941ca1b7ca3.svg" alt="348bd16b3b818fcfbedfaf14f50cb941ca1b7ca3.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-orgfd3853c-split">

<p>
It also contains the macro <code>@df</code> for working with dataframes<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@df</span> data scatter(<span style="color: #D0372D;">:date</span>, <span style="color: #D0372D;">:in_bed</span>, label=<span style="color: #D0372D;">nothing</span>, ylabel=<span style="color: #008000;">"Number of students in bed"</span>)
</code></pre>
</div>


<div id="org454ce5b" class="figure">
<p><img src="assets/outputs/more-julia/1425b863a8661542a4b00f6bce46205730eb2531.svg" alt="1425b863a8661542a4b00f6bce46205730eb2531.svg" class="org-svg" /><br />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org2b761ba">
<h2 id="org2b761ba">DifferentialEquations.jl</h2>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> DifferentialEquations
</code></pre>
</div>

<p>
Everything related to differential equations is provided by <a href="https://docs.sciml.ai/DiffEqDocs/stable/"><code>DifferentialEquations.jl</code></a> and the <a href="https://sciml.ai/">SciML ecosystem</a><br />
</p>

</section>
<section id="slide-org2b761ba-split">

<p>
And I really do mean <a href="https://docs.sciml.ai/DiffEqDocs/stable/"><i>everything</i></a><br />
</p>

<div class="side-by-side">


<div id="org06317e6" class="figure">
<p><img src="assets/attachments/2023-01-19_19-48-23_Screenshot_20230119_194737.png" alt="2023-01-19_19-48-23_Screenshot_20230119_194737.png" /><br />
</p>
</div>


<div id="org33e2848" class="figure">
<p><img src="assets/attachments/2023-01-19_19-48-41_Screenshot_20230119_194838.png" alt="2023-01-19_19-48-41_Screenshot_20230119_194838.png" /><br />
</p>
</div>

</div>


</section>
<section id="slide-org9fe63be">
<h3 id="org9fe63be">Differential equations</h3>
<p>
Suppose we have some function \(f\) which describes how a state \(x\) evolves wrt. \(t\)<br />
</p>
<div>
\begin{equation*}
\frac{\mathrm{d} x}{\mathrm{d} t} = f(x, t)
\end{equation*}

</div>
<p>
which we then need to integrate to obtain the actual state at some time \(t\)<br />
</p>
<div>
\begin{equation*}
x(t) = \int_{0}^{t} \frac{\mathrm{d} x}{\mathrm{d} t} \mathrm{d} t = \int_{0}^{t} f(x, t) \mathrm{d} t
\end{equation*}

</div>

<p>
In many interesting scenarios numerical methods are required to obtain \(x(t)\)<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model">
<h3 id="2023-01-29-16-57-28-Example-SIR-model">Example: SIR model</h3>
<p>
One particular example of an (ordinary) differential equation that you might have seen recently is the <b>SIR model</b> used in epidemiology<br />
</p>


<div id="org24950d9" class="figure">
<p><img src="assets/attachments/2023-01-19_19-56-00_sir_illu.png" alt="2023-01-19_19-56-00_sir_illu.png" /><br />
</p>
<p><span class="figure-number">Figure 2: </span><a href="https://covid19.uclaml.org/model.html">https://covid19.uclaml.org/model.html</a> (2023-01-19)</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
The temporal dynamics of the sizes of each of the compartments are governed by the following system of ODEs:<br />
</p>
<div>
\begin{equation*}
\begin{split}
  \frac{\mathrm{d} S}{\mathrm{d} t} &= - \beta S \frac{I}{N} \\
  \frac{\mathrm{d} I}{\mathrm{d} t} &= \beta S \frac{I}{N} - \gamma I \\
  \frac{\mathrm{d} R}{\mathrm{d} t} &= \gamma I
\end{split}
\end{equation*}

</div>
<p>
where<br />
</p>
<ul>
<li>\(S(t)\) is the number of people susceptible to becoming infected,<br /></li>
<li>\(I(t)\) is the number of people currently infected,<br /></li>
<li>\(R(t)\) is the number of recovered people,<br /></li>
<li>\(β\) is the constant rate of infectious contact between people,<br /></li>
<li>\(\gamma\) the constant recovery rate of infected individuals<br /></li>

</ul>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
Converting this ODE into code is just<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">const</span> N = 763 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">size of population</span>

<span style="color: #0000FF;">function</span> <span style="color: #006699;">SIR!</span>(
    du,  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">buffer for the updated differential equation</span>
    u,   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current state</span>
    p,   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">parameters</span>
    t    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current time</span>
)
    S, I, R = u
    &#946;, &#947; = p

    du[1] = dS = -&#946; * I * S / N
    du[2] = dI = &#946; * I * S / N - &#947; * I
    du[3] = dR = &#947; * I
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
SIR! (generic function with 1 method)
</pre>


<p>
Not too bad!<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
Initial conditions are then<br />
</p>
<div>
\begin{equation*}
\begin{split}
  S(0) &= N - 1 \\
  I(0) &= 1 \\
  R(0) &= 0
\end{split}
\end{equation*}

</div>
<p>
and we want to integrate from \(t = 0\) to \(t = 14\)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Include 0 because that's the initial condition before any observations.</span>
tspan = (0.0, 14.0)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Initial conditions are:</span>
<span style="color: #8D8D84;">#   </span><span style="color: #8D8D84; font-style: italic;">S(0) = N - 1; I(0) = 1; R(0) = 0</span>
u0 = [N - 1, 1, 0.0]
</code></pre>
</div>

<pre class="example">
3-element Vector{Float64}:
 762.0
   1.0
   0.0
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
Now we just need to define the overall problem and we can solve:<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Just to check that everything works, we'll just use some "totally random" values for &#946; and &#947;:</span>
problem_sir = <span style="color: #0000FF;">let</span> &#946; = 2.0, &#947; = 0.6
    ODEProblem(SIR!, u0, tspan, (&#946;, &#947;))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
ODEProblem with uType Vector{Float64} and tType Float64. In-place: true
timespan: (0.0, 14.0)
u0: 3-element Vector{Float64}:
 762.0
   1.0
   0.0
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
Aaaand<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sol = solve(problem_sir)
</code></pre>
</div>

<pre class="example" id="orga09e3a2">
retcode: Success
Interpolation: specialized 4th order "free" interpolation, specialized 2nd order "free" stiffness-aware interpolation
t: 23-element Vector{Float64}:
  0.0
  0.0023558376404244326
  0.025914214044668756
  0.11176872871946908
  0.26714420676761075
  0.47653584778586056
  0.7436981238065388
  1.0701182881347182
  1.4556696154809898
  1.8994815718103506
  2.4015425820305163
  2.9657488203418048
  3.6046024613854746
  4.325611232479916
  5.234036476235002
  6.073132270491685
  7.323851265223563
  8.23100744184026
  9.66046960467715
 11.027717843180652
 12.506967592177675
 13.98890399536329
 14.0
u: 23-element Vector{Vector{Float64}}:
 [762.0, 1.0, 0.0]
 [761.9952867607622, 1.003297407481751, 0.001415831756055325]
 [761.9472927630898, 1.036873767352754, 0.015833469557440357]
 [761.7584189579304, 1.1690001128296739, 0.0725809292398516]
 [761.353498610305, 1.4522140137552049, 0.19428737593979384]
 [760.6490369821046, 1.9447820690728455, 0.4061809488225752]
 [759.3950815454128, 2.8210768113583082, 0.7838416432288186]
 [757.0795798160242, 4.437564277195732, 1.4828559067800167]
 [752.6094742865345, 7.552145919430467, 2.8383797940350495]
 [743.573784947305, 13.823077731564027, 5.603137321131049]
 [724.5575481927715, 26.909267078762316, 11.533184728466205]
 [683.6474029897502, 54.51612001957392, 24.836476990675976]
 [598.1841629858786, 109.41164143668018, 55.40419557744127]
 [450.08652743810205, 192.396449154863, 120.51702340703504]
 [259.11626253270623, 256.9925778114915, 246.89115965580237]
 [148.3573731526537, 240.10301213899098, 374.53961470835543]
 [76.52998017846475, 160.6373332952353, 525.8326865263001]
 [55.70519994004921, 108.7634182279299, 598.531381832021]
 [41.39587834423381, 55.09512088924873, 666.5090007665176]
 [35.87067243374374, 27.821838135708532, 699.3074894305479]
 [33.252184333490774, 13.087185981359177, 716.6606296851502]
 [32.08996839417716, 6.105264616193066, 724.8047669896299]
 [32.08428686823946, 6.070415830241046, 724.8452973015196]
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
We didn't specify a solver<br />
</p>

<p>
DifferentialEquations.jl uses <code>AutoTsit5(Rosenbrock32())</code> by default<br />
</p>

<p>
Which is a composition between<br />
</p>

<ul>
<li><code>Tsit5</code> (4th order Runge-Kutta), and<br /></li>
<li><code>Rosenbrock32</code> (3rd order stiff solver)<br /></li>

</ul>

<p>
with automatic switching between the two<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
<code>AutoTsit5(Rosenbrock32())</code> covers many use-cases well, but see<br />
</p>

<ul>
<li><a href="https://docs.sciml.ai/DiffEqDocs/stable/solvers/ode_solve/">https://docs.sciml.ai/DiffEqDocs/stable/solvers/ode_solve/</a><br /></li>
<li><a href="https://www.stochasticlifestyle.com/comparison-differential-equation-solver-suites-matlab-r-julia-python-c-fortran/">https://www.stochasticlifestyle.com/comparison-differential-equation-solver-suites-matlab-r-julia-python-c-fortran/</a><br /></li>

</ul>

<p>
for more info on choosing a solver<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
This is the resulting solution<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(
    sol,
    linewidth=2, xaxis=<span style="color: #008000;">"Time in days"</span>, label=[<span style="color: #008000;">"Suspectible"</span> <span style="color: #008000;">"Infected"</span> <span style="color: #008000;">"Recovered"</span>],
    alpha=0.5, size=(500, 300)
)
scatter!(1:14, data.in_bed, label=<span style="color: #008000;">"Data"</span>, color=<span style="color: #008000;">"black"</span>)
</code></pre>
</div>


<div id="org32132d2" class="figure">
<p><img src="assets/outputs/more-julia/780e8cc1c00812abcfba1fe711f0a8b7b168b7e7.svg" alt="780e8cc1c00812abcfba1fe711f0a8b7b168b7e7.svg" class="org-svg" /><br />
</p>
</div>

<p>
This doesn't really match the data though; let's do better<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SIR-model-split">

<p>
<b>Approach #1:</b> find optimal values of \(\beta\) and \(\gamma\) by minimizing some loss, e.g. sum-of-squares<br />
</p>

<div>
\begin{equation*}
\ell(\beta, \gamma) = \sum_{i = 1}^{14} \bigg( F(u_0, t_i;\ \beta, \gamma) - y_i \bigg)^2
\end{equation*}

</div>

<p>
where \(\big( y_i \big)_{i = 1}^{14}\) are the observations, \(F\) is the integrated system<br />
</p>

</section>
<section id="slide-orgfa39b50">
<h3 id="orgfa39b50">Optimization.jl</h3>
<p>
In Julia, there are <i>tons</i> of packages for performing all kinds of optimization<br />
</p>

<p>
<a href="https://docs.sciml.ai/Optimization/stable/">Optimization.jl</a> provides a convenient interface to many of them<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Optimization
</code></pre>
</div>


<div id="org602b76d" class="figure">
<p><img src=".more-julia/attachments/2023-09-15_13-06-48_Screenshot_20230915_130639.png" alt="2023-09-15_13-06-48_Screenshot_20230915_130639.png" width="400px" /><br />
</p>
<p><span class="figure-number">Figure 3: </span><a href="https://docs.sciml.ai/Optimization/stable/#Overview-of-the-Optimizers">https://docs.sciml.ai/Optimization/stable/#Overview-of-the-Optimizers</a> (2023-09-15)</p>
</div>


</section>
<section id="slide-orgfa39b50-split">

<div class="small-text">

<p>
Recall we want to solve<br />
</p>

<div>
\begin{equation*}
\min_{\beta, \gamma} \sum_{i = 1}^{14} \bigg( F(u_0, t_i;\ \beta, \gamma) - y_i \bigg)^2
\end{equation*}

</div>

<p>
where \(\big( y_i \big)_{i = 1}^{14}\) are the observations, \(F\) is the integrated system<br />
</p>

</div>

<div class="fragment (appear)">

<p>
First we define the loss<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Define the loss function.</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">loss_sir</span>(problem_orig, p)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`remake` just, well, remakes the `problem` with parameters `p` replaced.</span>
    problem = remake(problem_orig, p=p)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">To ensure we get solutions _exactly_ at the timesteps of interest,</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">i.e. every day we have observations, we use `saveat=1` to tell `solve`</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">to save at every timestep (which is one day).</span>
    sol = solve(problem, saveat=1)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Extract the 2nd state, the (I)infected, for the dates with observations.</span>
    sol_for_observed = sol[2, 2:15]
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Compute the sum-of-squares of the infected vs. data.</span>
    <span style="color: #0000FF;">return</span> sum(abs2.(sol_for_observed - data.in_bed))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
loss_sir (generic function with 1 method)
</pre>


</div>

</section>
<section id="slide-orgfa39b50-split">

<p>
Then we can define our <code>OptimizationProblem</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>opt_problem = OptimizationProblem(
    OptimizationFunction(
        (p,_) -&gt; loss_sir(problem_sir, p), <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">function to minimize</span>
        Optimization.AutoForwardDiff()     <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">use ForwardDiff for automatic differentiation</span>
    ),
    [2.0, 0.5],                            <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">initial values</span>
    lb = [0, 0],                           <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">lower bounds on variables</span>
    ub = [<span style="color: #D0372D;">Inf</span>, <span style="color: #D0372D;">Inf</span>],                       <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">upper bounds on variables</span>
) 
</code></pre>
</div>

<pre class="example">
OptimizationProblem. In-place: true
u0: 2-element Vector{Float64}:
 2.0
 0.5
</pre>


</section>
<section id="slide-orgfa39b50-split">

<p>
And for general <i>deterministic</i> problems, <a href="https://julianlsolvers.github.io/Optim.jl/stable/">Optim.jl</a> is a good choice<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> OptimizationOptimJL
opt = solve(opt_problem, NelderMead())
</code></pre>
</div>

<pre class="example">
u: 2-element Vector{Float64}:
 1.6692320164955483
 0.44348639177622445
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>&#946;, &#955; = opt
&#946;, &#955;
</code></pre>
</div>

<pre class="example">
(1.6692320164955483, 0.44348639177622445)
</pre>


</section>
<section id="slide-orgfa39b50-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Solve the problem with the obtained parameters.</span>
problem_sir = remake(problem_sir, p=(&#946;, &#955;))
sol = solve(problem_sir)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Plot the solution.</span>
plot(sol, linewidth=2, xaxis=<span style="color: #008000;">"Time in days"</span>, label=[<span style="color: #008000;">"Susceptible"</span> <span style="color: #008000;">"Infected"</span> <span style="color: #008000;">"Recovered"</span>], alpha=0.5)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">And the data.</span>
scatter!(1:14, data.in_bed, label=<span style="color: #008000;">"Data"</span>, color=<span style="color: #008000;">"black"</span>)
</code></pre>
</div>


<div id="org2fa09b7" class="figure">
<p><img src="assets/outputs/more-julia/c4a9d9cc8632820164ac0b1c77cded80e46b9a39.svg" alt="c4a9d9cc8632820164ac0b1c77cded80e46b9a39.svg" class="org-svg" /><br />
</p>
</div>

<p>
That's better than our <i>totally</i> "random" guess from earlier!<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Example-SEIR-model">
<h3 id="2023-01-29-16-57-28-Example-SEIR-model">Example: SEIR model</h3>
<p>
Adding another compartment to our SIR model: the <span class="underline">(E)xposed</span> state<br />
</p>

<div>
\begin{equation*}
\begin{split}
  \frac{\mathrm{d} S}{\mathrm{d} t} &= - \beta S \frac{I}{N} \\
  \frac{\mathrm{d} {\color{blue} E}}{\mathrm{d} t} &= \beta S \frac{I}{N} - {\color{orange} \sigma} {\color{blue} E} \\
  \frac{\mathrm{d} I}{\mathrm{d} t} &= {\color{orange} \sigma} {\color{blue} E} - \gamma I \\
  \frac{\mathrm{d} R}{\mathrm{d} t} &= \gamma I
\end{split}
\end{equation*}

</div>

<p>
where we've added a new parameter \({\color{orange} \sigma}\) describing the fraction of people who develop observable symptoms in this time<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia">
<h3 id="2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia"><span class="todo TASK">TASK</span> Solve the SEIR model using Julia</h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">function</span> <span style="color: #006699;">SEIR!</span>(
    du,  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">buffer for the updated differential equation</span>
    u,   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current state</span>
    p,   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">parameters</span>
    t    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current time</span>
)
    N = 763  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">population</span>

    S, E, I, R = u  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">have ourselves an additional state!</span>
    &#946;, &#947;, &#963; = p     <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">and an additional parameter!</span>

    <span style="color: #8D8D84;"># </span><span style="color: #ffa500; font-weight: bold; font-style: italic;">TODO:</span><span style="color: #8D8D84; font-style: italic;"> Implement yah fool!</span>
    du[1] = <span style="color: #D0372D;">nothing</span>
    du[2] = <span style="color: #D0372D;">nothing</span>
    du[3] = <span style="color: #D0372D;">nothing</span>
    du[4] = <span style="color: #D0372D;">nothing</span>
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<p>
<b>BONUS:</b> find minimizers of sum-of-squares<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia">
<h3 id="2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia"><span class="done SOLUTION">SOLUTION</span> Solve the SEIR model using Julia</h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">function</span> <span style="color: #006699;">SEIR!</span>(
    du,  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">buffer for the updated differential equation</span>
    u,   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current state</span>
    p,   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">parameters</span>
    t    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">current time</span>
)
    N = 763  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">population</span>
    S, E, I, R = u  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">have ourselves an additional state!</span>
    &#946;, &#947;, &#963; = p     <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">and an additional parameter!</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Might as well cache these computations.</span>
    &#946;SI = &#946; * S * I / N
    &#963;E = &#963; * E
    &#947;I = &#947; * I

    du[1] = -&#946;SI
    du[2] = &#946;SI - &#963;E
    du[3] = &#963;E - &#947;I
    du[4] = &#947;I
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
SEIR! (generic function with 1 method)
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>problem_seir = <span style="color: #0000FF;">let</span> u0 = [N - 1, 0, 1, 0], &#946; = 2.0, &#947; = 0.6, &#963; = 0.8
    ODEProblem(SEIR!, u0, tspan, (&#946;, &#947;, &#963;))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
ODEProblem with uType Vector{Int64} and tType Float64. In-place: true
timespan: (0.0, 14.0)
u0: 4-element Vector{Int64}:
 762
   0
   1
   0
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sol_seir = solve(problem_seir, saveat=1)
</code></pre>
</div>

<pre class="example" id="org420467a">
retcode: Success
Interpolation: 1st order linear
t: 15-element Vector{Float64}:
  0.0
  1.0
  2.0
  3.0
  4.0
  5.0
  6.0
  7.0
  8.0
  9.0
 10.0
 11.0
 12.0
 13.0
 14.0
u: 15-element Vector{Vector{Float64}}:
 [762.0, 0.0, 1.0, 0.0]
 [760.1497035901518, 1.277915971753478, 1.015887135649055, 0.5564933024456415]
 [757.5476928906271, 2.425869618233348, 1.6850698824327135, 1.341367608706787]
 [753.081189706403, 4.277014534677882, 2.9468385687120784, 2.6949571902067637]
 [745.3234082630842, 7.455598293492681, 5.155811621098982, 5.065181822323939]
 [731.9851682751213, 12.855816151849933, 8.960337047554939, 9.198678525473571]
 [709.5042941973462, 21.77178343781762, 15.384985521594785, 16.338936843241182]
 [672.8733895183619, 35.77263271085456, 25.88133104438007, 28.472646726403138]
 [616.390571176038, 55.9717775696742, 42.09614416178475, 48.54150709250277]
 [536.453596476594, 81.2428045994271, 64.9673325777641, 80.33626634621449]
 [436.43708330634297, 106.04037246704702, 92.9550757379631, 127.56746848864664]
 [329.60092931771436, 121.08020372279418, 120.48402926084937, 191.83483769864185]
 [233.8471941518982, 119.43669383157659, 139.3233304893263, 270.3927815271987]
 [160.88805352426687, 102.7399386960996, 143.3826208089892, 355.98938697064415]
 [111.72261866282292, 79.02493776169311, 132.78384886713565, 439.46859470834806]
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(sol_seir, linewidth=2, xaxis=<span style="color: #008000;">"Time in days"</span>, label=[<span style="color: #008000;">"Susceptible"</span> <span style="color: #008000;">"Exposed"</span> <span style="color: #008000;">"Infected"</span> <span style="color: #008000;">"Recovered"</span>], alpha=0.5)
scatter!(1:14, data.in_bed, label=<span style="color: #008000;">"Data"</span>)
</code></pre>
</div>


<div id="org80f1819" class="figure">
<p><img src="assets/outputs/more-julia/cf61c8af8f10097a63ca84e48ff0b4831f7d8a59.svg" alt="cf61c8af8f10097a63ca84e48ff0b4831f7d8a59.svg" class="org-svg" /><br />
</p>
</div>

<p>
Don't look so good. Let's try Optim.jl again.<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">function</span> <span style="color: #006699;">loss_seir</span>(problem, p)
    problem = remake(problem, p=p)
    sol = solve(problem, saveat=1)
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> 3rd state is now the (I)nfectious compartment!!!</span>
    sol_for_observed = sol[3, 2:15]
    <span style="color: #0000FF;">return</span> sum(abs2.(sol_for_observed - data.in_bed))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
loss_seir (generic function with 1 method)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>opt_problem = OptimizationProblem(
    OptimizationFunction(
        (p,_) -&gt; loss_seir(problem_seir, p), <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">function to minimize</span>
        Optimization.AutoForwardDiff()       <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">use ForwardDiff for automatic differentiation</span>
    ),
    [2.0, 0.5, 0.9],                         <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">initial values</span>
    lb = [0, 0, 0],                          <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">lower bounds on variables</span>
    ub = [<span style="color: #D0372D;">Inf</span>, <span style="color: #D0372D;">Inf</span>, <span style="color: #D0372D;">Inf</span>],                    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">upper bounds on variables</span>
)
</code></pre>
</div>

<pre class="example">
OptimizationProblem. In-place: true
u0: 3-element Vector{Float64}:
 2.0
 0.5
 0.9
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>opt = solve(opt_problem, NelderMead())
</code></pre>
</div>

<pre class="example">
u: 3-element Vector{Float64}:
 4.853892250588215
 0.46714672936112517
 0.8150220601014526
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>&#946;, &#947;, &#963; = opt
</code></pre>
</div>

<pre class="example">
u: 3-element Vector{Float64}:
 4.853892250588215
 0.46714672936112517
 0.8150220601014526
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sol_seir = solve(remake(problem_seir, p=(&#946;, &#947;, &#963;)), saveat=1)
plot(sol_seir, linewidth=2, xaxis=<span style="color: #008000;">"Time in days"</span>, label=[<span style="color: #008000;">"Susceptible"</span> <span style="color: #008000;">"Exposed"</span> <span style="color: #008000;">"Infected"</span> <span style="color: #008000;">"Recovered"</span>], alpha=0.5)
scatter!(1:14, data.in_bed, label=<span style="color: #008000;">"Data"</span>, color=<span style="color: #008000;">"black"</span>)
</code></pre>
</div>


<div id="org0936db5" class="figure">
<p><img src="assets/outputs/more-julia/42df237b1d7d830e89b857e29552483eb45ebc0c.svg" alt="42df237b1d7d830e89b857e29552483eb45ebc0c.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Solve-the-SEIR-model-using-Julia-split">

<blockquote >
<p>
But&#x2026;but these are <span class="underline">point estimates</span>! What about distributions? WHAT ABOUT UNCERTAINTY?!<br />
</p>
</blockquote>

<p>
No, no that's fair.<br />
</p>

<p>
Let's do some Bayesian inference then.<br />
</p>

<p>
BUT FIRST!<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Making-our-future-selves-less-annoyed">
<h3 id="2023-01-29-16-57-28-Making-our-future-selves-less-annoyed">Making our future selves less annoyed</h3>
<p>
It's annoying to have all these different loss-functions for <i>both</i> <code>SIR!</code> and <code>SEIR!</code><br />
</p>

<div class="fragment (appear)">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Abstract type which we can use to dispatch on.</span>
<span style="color: #0000FF;">abstract type</span> <span style="color: #6434A3;">AbstractEpidemicProblem</span> <span style="color: #0000FF;">end</span>

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">SIRProblem</span>{P} &lt;: <span style="color: #6434A3;">AbstractEpidemicProblem</span>
    problem::<span style="color: #6434A3;">P</span>
    N::<span style="color: #6434A3;">Int</span>
<span style="color: #0000FF;">end</span>

<span style="color: #0000FF;">function</span> <span style="color: #006699;">SIRProblem</span>(N::<span style="color: #6434A3;">Int</span>; u0 = [N - 1, 1, 0.], tspan = (0, 14), p = [2.0, 0.6])
    <span style="color: #0000FF;">return</span> SIRProblem(ODEProblem(SIR!, u0, tspan, p), N)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
SIRProblem
</pre>


<p>
Then we can just construct the problem as<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sir = SIRProblem(N);
</code></pre>
</div>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Making-our-future-selves-less-annoyed-split">

<p>
And to make it a bit easier to work with, we add some utility functions<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">General.</span>
<span style="color: #006699;">parameters</span>(prob::<span style="color: #6434A3;">AbstractEpidemicProblem</span>) = prob.problem.p
<span style="color: #006699;">initial_state</span>(prob::<span style="color: #6434A3;">AbstractEpidemicProblem</span>) = prob.problem.u0
<span style="color: #006699;">population</span>(prob::<span style="color: #6434A3;">AbstractEpidemicProblem</span>) = prob.N

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Specializations.</span>
<span style="color: #006699;">susceptible</span>(::<span style="color: #6434A3;">SIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[1, :]
<span style="color: #006699;">infected</span>(::<span style="color: #6434A3;">SIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[2, :]
<span style="color: #006699;">recovered</span>(::<span style="color: #6434A3;">SIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[3, :]
</code></pre>
</div>

<pre class="example">
recovered (generic function with 1 method)
</pre>


<p>
So that once we've solved the problem, we can easily extract the compartment we want, e.g.<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sol = solve(sir.problem, saveat=1)
infected(sir, sol)
</code></pre>
</div>

<pre class="example" id="org7df60ff">
15-element Vector{Float64}:
   1.0
   4.026799533924022
  15.824575905720003
  56.779007685250534
 154.43105799061686
 248.98982384839158
 243.67838619968526
 181.93939659551984
 120.64627375763273
  75.92085282572398
  46.58644927641269
  28.214678599716414
  16.96318676577873
  10.158687874394722
   6.070415830241046
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Implement-SEIRProblem">
<h3 id="2023-01-29-16-57-28-Implement-SEIRProblem"><span class="todo TASK">TASK</span> Implement <code>SEIRProblem</code></h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">SEIRProblem</span> &lt;: <span style="color: #6434A3;">AbstractEpidemicProblem</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">...</span>
<span style="color: #0000FF;">end</span>

<span style="color: #0000FF;">function</span> <span style="color: #006699;">SEIRProblem</span> <span style="color: #0000FF;">end</span>

susceptible
exposed
infected
recovered
</code></pre>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Implement-SEIRProblem">
<h3 id="2023-01-29-16-57-28-Implement-SEIRProblem"><span class="done SOLUTION">SOLUTION</span> Implement <code>SEIRProblem</code></h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">SEIRProblem</span>{P} &lt;: <span style="color: #6434A3;">AbstractEpidemicProblem</span>
    problem::<span style="color: #6434A3;">P</span>
    N::<span style="color: #6434A3;">Int</span>
<span style="color: #0000FF;">end</span>

<span style="color: #0000FF;">function</span> <span style="color: #006699;">SEIRProblem</span>(N::<span style="color: #6434A3;">Int</span>; u0 = [N - 1, 0, 1, 0.], tspan = (0, 14), p = [4.5, 0.45, 0.8])
    <span style="color: #0000FF;">return</span> SEIRProblem(ODEProblem(SEIR!, u0, tspan, p), N)
<span style="color: #0000FF;">end</span>

<span style="color: #006699;">susceptible</span>(::<span style="color: #6434A3;">SEIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[1, :]
<span style="color: #006699;">exposed</span>(::<span style="color: #6434A3;">SEIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[2, :]
<span style="color: #006699;">infected</span>(::<span style="color: #6434A3;">SEIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[3, :]
<span style="color: #006699;">recovered</span>(::<span style="color: #6434A3;">SEIRProblem</span>, u::<span style="color: #6434A3;">AbstractMatrix</span>) = u[4, :]
</code></pre>
</div>

<pre class="example">
recovered (generic function with 2 methods)
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Implement-SEIRProblem-split">

<p>
Now, given a <code>problem</code> and a <code>sol</code>, we can query the <code>sol</code> for the <code>infected</code> state <span class="underline">without explicit handling of which <code>problem</code> we're working with</span><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>seir = SEIRProblem(N);
sol = solve(seir.problem, saveat=1)
infected(seir, sol)
</code></pre>
</div>

<pre class="example" id="orga54e0d2">
15-element Vector{Float64}:
   1.0
   1.9941817088874336
   6.9585823072029
  23.926233517606498
  74.23638542794971
 176.98368495653585
 276.06126059898344
 293.92632518571605
 249.92836195453708
 189.07578975511504
 134.2373192679034
  91.82578430804273
  61.38108478932364
  40.42264366743211
  26.357816296754425
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Same-loss-for-both">
<h3 id="2023-01-29-16-57-28-Same-loss-for-both">Same <code>loss</code> for both!</h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">function</span> <span style="color: #006699;">loss</span>(problem_wrapper::<span style="color: #6434A3;">AbstractEpidemicProblem</span>, p)
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Extract the `problem` from `problem_wrapper`.</span>
    problem = remake(problem_wrapper.problem, p=p)
    sol = solve(problem, saveat=1)
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Now this is completely general!</span>
    sol_for_observed = infected(problem_wrapper, sol)[2:<span style="color: #0000FF;">end</span>]
    <span style="color: #0000FF;">return</span> sum(abs2.(sol_for_observed - data.in_bed))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
loss (generic function with 1 method)
</pre>


<p>
Now we can call the <span class="underline">same <code>loss</code> for both</span> <code>SIR</code> and <code>SEIR</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>loss(SIRProblem(N), [2.0, 0.6])
</code></pre>
</div>

<pre class="example">
50257.839781348805
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>loss(SEIRProblem(N), [2.0, 0.6, 0.8])
</code></pre>
</div>

<pre class="example">
287325.105532706
</pre>

</section>
</section>
<section>
<section id="slide-org490da42">
<h2 id="org490da42">GPU programming</h2>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> CUDA
</code></pre>
</div>

<p>
I'll use <code>CUDA</code> here, but there is also support for other GPU backends<br />
</p>

<p>
For more, see <a href="https://juliagpu.org/">https://juliagpu.org/</a><br />
</p>

</section>
<section id="slide-org490da42-split">

<p>
Because some of you might not have a GPU, we'll use<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>CUDA.has_cuda()
</code></pre>
</div>

<pre class="example">
true
</pre>


<p>
to avoid executing the GPU code in that case<br />
</p>

</section>
<section id="slide-org490da42-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">if</span> CUDA.has_cuda()
    CUDA.versioninfo()
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example" id="org6010276">
CUDA runtime 11.8, artifact installation
CUDA driver 11.4
NVIDIA driver 470.199.2

CUDA libraries: 
- CUBLAS: 11.11.3
- CURAND: 10.3.0
- CUFFT: 10.9.0
- CUSOLVER: 11.4.1
- CUSPARSE: 11.7.5
- CUPTI: 18.0.0
- NVML: 11.0.0+470.199.2

Julia packages: 
- CUDA: 4.4.1
- CUDA_Driver_jll: 0.5.0+1
- CUDA_Runtime_jll: 0.6.0+0

Toolchain:
- Julia: 1.9.3
- LLVM: 14.0.6
- PTX ISA support: 3.2, 4.0, 4.1, 4.2, 4.3, 5.0, 6.0, 6.1, 6.3, 6.4, 6.5, 7.0, 7.1, 7.2, 7.3, 7.4
- Device capability support: sm_35, sm_37, sm_50, sm_52, sm_53, sm_60, sm_61, sm_62, sm_70, sm_72, sm_75, sm_80, sm_86

1 device:
  0: NVIDIA GeForce GTX 1650 with Max-Q Design (sm_75, 3.815 GiB / 3.822 GiB available)
</pre>

</section>
<section id="slide-org490da42-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Array on CPU</span>
xs = rand(2)
</code></pre>
</div>

<pre class="example">
2-element Vector{Float64}:
 0.7911106632038112
 0.7542712130619208
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">if</span> CUDA.has_cuda()
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Array on GPU</span>
    xs_cuda = cu(xs)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
2-element CuArray{Float32, 1, CUDA.Mem.DeviceBuffer}:
 0.79111063
 0.7542712
</pre>


<p>
And that's it!<br />
</p>

</section>
<section id="slide-org490da42-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">if</span> CUDA.has_cuda()
    2 * xs_cuda
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
2-element CuArray{Float32, 1, CUDA.Mem.DeviceBuffer}:
 1.5822213
 1.5085424
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">if</span> CUDA.has_cuda()
    xs_cuda .+ xs_cuda
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
2-element CuArray{Float32, 1, CUDA.Mem.DeviceBuffer}:
 1.5822213
 1.5085424
</pre>


</section>
<section id="slide-org490da42-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">if</span> CUDA.has_cuda()
    X_cuda = xs_cuda * xs_cuda' + 1f-2 * I
    cholesky(X_cuda)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
Cholesky{Float32, CuArray{Float32, 2, CUDA.Mem.DeviceBuffer}}
U factor:
2×2 UpperTriangular{Float32, CuArray{Float32, 2, CUDA.Mem.DeviceBuffer}}:
 0.797406  0.748317
  ⋅        0.137649
</pre>


</section>
<section id="slide-org490da42-split">

<div class="WARNING">
<p>
<b>Important:</b> Turing.jl is <span class="underline">not</span> completely GPU compatible<br />
</p>
</div>

<p>
You can execute all the GPU code you want <i>inside</i> the model<br />
</p>

<p>
But you can't use GPU for the entire computation, <i>yet</i><br />
</p>

<p>
Though some samplers are already GPU compatible<br />
</p>

</section>
</section>
<section>
<section id="slide-2023-01-29-16-57-28-Bayesian-inference">
<h2 id="2023-01-29-16-57-28-Bayesian-inference">Turing.jl</h2>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> Turing
</code></pre>
</div>

<p>
and so we are finally here<br />
</p>

</section>
<section id="slide-orgb135d5d">
<h3 id="orgb135d5d">A simple demo</h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">1. Define the model</span>
<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">2. Instantiate the model, giving it some data.</span>
model = simple_demo(1.5, 2.0)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">3. Sample.</span>
chain = sample(model, NUTS(), 1000);
</code></pre>
</div>

<pre class="example">
┌ Info: Found initial step size
└   ϵ = 0.8
Sampling: 100%|█████████████████████████████████████████| Time: 0:00:00

</pre>


</section>
<section id="slide-orgb135d5d-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain
</code></pre>
</div>

<pre class="example" id="org0ae5a00">
Chains MCMC chain (1000×14×1 Array{Float64, 3}):

Iterations        = 501:1:1500
Number of chains  = 1
Samples per chain = 1000
Wall duration     = 9.12 seconds
Compute duration  = 9.12 seconds
parameters        = s, m
internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size

Summary Statistics
  parameters      mean       std      mcse   ess_bulk   ess_tail      rhat   e ⋯
      Symbol   Float64   Float64   Float64    Float64    Float64   Float64     ⋯

           s    1.9267    1.3645    0.0630   485.6727   577.6553    1.0054     ⋯
           m    1.2265    0.7849    0.0309   674.6064   552.4304    1.0099     ⋯
                                                                1 column omitted

Quantiles
  parameters      2.5%     25.0%     50.0%     75.0%     97.5% 
      Symbol   Float64   Float64   Float64   Float64   Float64 

           s    0.5507    1.0696    1.5418    2.3495    5.1686
           m   -0.2176    0.7099    1.1755    1.6958    2.7835
</pre>

</section>
<section id="slide-orgb135d5d-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(chain)
</code></pre>
</div>


<div id="org48bcc90" class="figure">
<p><img src="assets/outputs/more-julia/1e1f607dc21364143f2f8b67328de490ce367807.svg" alt="1e1f607dc21364143f2f8b67328de490ce367807.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-orgb135d5d-split">


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">1. Define the model</span>
<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">2. Instantiate the model, giving it some data.</span>
model = simple_demo(1.5, 2.0)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">3. Sample.</span>
chain = sample(model, NUTS(), 1000);
</code></pre>
</div>

<blockquote >
<p>
Okay, what is going on here?<br />
</p>
</blockquote>

<p>
Let's break it down<br />
</p>

</section>
<section id="slide-orgb135d5d-split">

<p>
To define a model in Turing.jl, we use the <code>@model</code> macro<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
simple_demo (generic function with 2 methods)
</pre>


<p>
which, as we can see, results in a few <code>simple_demo</code> methods<br />
</p>

<ul class="fragment appear">
<li>One method is for evaluation of the model<br /></li>
<li>The rest (one, here) are for constructing the <code>Model</code><br /></li>

</ul>

<div class="fragment (appear)">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model = simple_demo(1.5, 2.0)
</code></pre>
</div>

<pre class="example">
Model(
  args = (:x, :y)
  defaults = ()
  context = DynamicPPL.DefaultContext()
)
</pre>


</div>

</section>
<section id="slide-orgb135d5d-split">

<p>
In fact, we can call the <code>model</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model()
</code></pre>
</div>

<pre class="example">
2.0
</pre>


<p>
It returns <code>2.0</code> because the last line was<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>y ~ Normal(m, sqrt(s))
</code></pre>
</div>

<p>
where <code>y</code> is conditioned to be <code>2.0</code><br />
</p>

</section>
<section id="slide-orgb135d5d-split">

<p>
We can add an explicit <code>return</code> statement if we want<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This is just standard Julia, so we can put anything in here.</span>
    <span style="color: #0000FF;">return</span> (; s, m, x, y, hello=42)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
simple_demo (generic function with 2 methods)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model = simple_demo(1.5, 2.0)
model()
</code></pre>
</div>

<pre class="example">
(s = 0.9042382869221636, m = -0.4180599286347479, x = 1.5, y = 2.0, hello = 42)
</pre>


<p>
When we call the <code>model</code>, <code>s</code> and <code>m</code> are sampled from the prior<br />
</p>

</section>
<section id="slide-orgb135d5d-split">

<p>
This can be very useful for debugging, e.g.<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> demo_buggy()
    x ~ truncated(Normal(), -10, 0)
    y ~ Normal(0, x)
<span style="color: #0000FF;">end</span>
model_buggy = demo_buggy()
model_buggy()
</code></pre>
</div>

<pre class="example" id="orgc1c8dee">
DomainError with -1.5909802088598057:
Normal: the condition σ &gt;= zero(σ) is not satisfied.

Stacktrace:
  [1] #371
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:37 [inlined]
  [2] check_args
    @ ~/.julia/packages/Distributions/Ufrz2/src/utils.jl:89 [inlined]
  [3] #Normal#370
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:37 [inlined]
  [4] Normal
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:36 [inlined]
  [5] #Normal#373
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:42 [inlined]
  [6] Normal(μ::Int64, σ::Float64)
    @ Distributions ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:42
  [7] macro expansion
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/compiler.jl:555 [inlined]
  [8] demo_buggy(__model__::DynamicPPL.Model{typeof(demo_buggy), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, __varinfo__::DynamicPPL.ThreadSafeVarInfo{DynamicPPL.UntypedVarInfo{DynamicPPL.Metadata{Dict{AbstractPPL.VarName, Int64}, Vector{Distribution}, Vector{AbstractPPL.VarName}, Vector{Real}, Vector{Set{DynamicPPL.Selector}}}, Float64}, Vector{Base.RefValue{Float64}}}, __context__::DynamicPPL.SamplingContext{DynamicPPL.SampleFromPrior, DynamicPPL.DefaultContext, TaskLocalRNG})
    @ Main ./In[144]:3
  [9] _evaluate!!
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:963 [inlined]
 [10] evaluate_threadsafe!!
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:952 [inlined]
 [11] evaluate!!
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:887 [inlined]
 [12] evaluate!! (repeats 2 times)
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:900 [inlined]
 [13] evaluate!!
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:908 [inlined]
 [14] (::DynamicPPL.Model{typeof(demo_buggy), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext})()
    @ DynamicPPL ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:860
 [15] top-level scope
    @ In[144]:6
</pre>

</section>
<section id="slide-orgb135d5d-split">

<p>
Let's insert some good old-fashioned print-statements<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> demo_buggy()
    x ~ truncated(Normal(), -10, 0)
    println(<span style="color: #008000;">"x=$x"</span>)
    y ~ Normal(0, x)
    println(<span style="color: #008000;">"y=$y"</span>)
<span style="color: #0000FF;">end</span>
model_buggy = demo_buggy()
model_buggy()
</code></pre>
</div>

<pre class="example">
x=-0.39059114202501893
</pre>

<pre class="example" id="org492c108">
DomainError with -0.39059114202501893:
Normal: the condition σ &gt;= zero(σ) is not satisfied.

Stacktrace:
  [1] #371
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:37 [inlined]
  [2] check_args
    @ ~/.julia/packages/Distributions/Ufrz2/src/utils.jl:89 [inlined]
  [3] #Normal#370
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:37 [inlined]
  [4] Normal
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:36 [inlined]
  [5] #Normal#373
    @ ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:42 [inlined]
  [6] Normal(μ::Int64, σ::Float64)
    @ Distributions ~/.julia/packages/Distributions/Ufrz2/src/univariate/continuous/normal.jl:42
  [7] demo_buggy(__model__::DynamicPPL.Model{typeof(demo_buggy), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, __varinfo__::DynamicPPL.ThreadSafeVarInfo{DynamicPPL.UntypedVarInfo{DynamicPPL.Metadata{Dict{AbstractPPL.VarName, Int64}, Vector{Distribution}, Vector{AbstractPPL.VarName}, Vector{Real}, Vector{Set{DynamicPPL.Selector}}}, Float64}, Vector{Base.RefValue{Float64}}}, __context__::DynamicPPL.SamplingContext{DynamicPPL.SampleFromPrior, DynamicPPL.DefaultContext, TaskLocalRNG})
    @ Main ./In[145]:4
  [8] _evaluate!!
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:963 [inlined]
  [9] evaluate_threadsafe!!(model::DynamicPPL.Model{typeof(demo_buggy), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, varinfo::DynamicPPL.UntypedVarInfo{DynamicPPL.Metadata{Dict{AbstractPPL.VarName, Int64}, Vector{Distribution}, Vector{AbstractPPL.VarName}, Vector{Real}, Vector{Set{DynamicPPL.Selector}}}, Float64}, context::DynamicPPL.SamplingContext{DynamicPPL.SampleFromPrior, DynamicPPL.DefaultContext, TaskLocalRNG})
    @ DynamicPPL ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:952
 [10] evaluate!!(model::DynamicPPL.Model{typeof(demo_buggy), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}, varinfo::DynamicPPL.UntypedVarInfo{DynamicPPL.Metadata{Dict{AbstractPPL.VarName, Int64}, Vector{Distribution}, Vector{AbstractPPL.VarName}, Vector{Real}, Vector{Set{DynamicPPL.Selector}}}, Float64}, context::DynamicPPL.SamplingContext{DynamicPPL.SampleFromPrior, DynamicPPL.DefaultContext, TaskLocalRNG})
    @ DynamicPPL ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:887
 [11] evaluate!! (repeats 2 times)
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:900 [inlined]
 [12] evaluate!!
    @ ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:908 [inlined]
 [13] (::DynamicPPL.Model{typeof(demo_buggy), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext})()
    @ DynamicPPL ~/.julia/packages/DynamicPPL/m0PXI/src/model.jl:860
 [14] top-level scope
    @ In[145]:8
</pre>

</section>
<section id="slide-orgb135d5d-split">

<p>
<code>x</code> is negative ⟶ let's fix that<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> demo_buggy()
    x ~ truncated(Normal(), 0, 10)
    println(<span style="color: #008000;">"x=$x"</span>)
    y ~ Normal(0, x)
    println(<span style="color: #008000;">"y=$y"</span>)
<span style="color: #0000FF;">end</span>
model_buggy = demo_buggy()
model_buggy()
</code></pre>
</div>

<pre class="example">
x=0.7899722982041668
y=0.4623970224585408
</pre>


<p>
It works!<br />
</p>

</section>
<section id="slide-orgb135d5d-split">

<p>
But let's get back to our <code>simple_demo</code> example<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>


<div class="fragment (appear)"
<p>
We've seen a <code>function</code> before, so that part isn't new<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo(x)
    ...
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<p>
Roughly, <code>@model</code> "transforms" the function <code>simple_demo</code> in a "certain way"<br />
</p>
</div>

<div class="x-small-text">

<div class="fragment (appear)">

<p>
If you <i>really</i> want to have a look, you can execute the following code block<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@macroexpand</span> <span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> demo()
    x ~ Normal()
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">nothing</span>
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<p>
to see the actual code being generated<br />
</p>

</div>

</div>

</section>
<section id="slide-orgb135d5d-split">

<p>
Then we have the "tilde-statements"<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>s ~ InverseGamma(2, 3)
m ~ Normal(0, sqrt(s))

x ~ Normal(m, sqrt(s))
y ~ Normal(m, sqrt(s))
</code></pre>
</div>

<div class="fragment (appear)">
<p>
<span class="underline">Important:</span> only lines of the form <code>LEFT ~ RIGHT</code> are touched by <code>@model</code><br />
</p>
</div>

<div class="fragment (appear)">
<p>
⟹ Everything that is <span class="underline">not</span> of the form <code>LEFT ~ RIGHT</code> is <span class="underline">not</span> touched by <code>@model</code><br />
</p>

<blockquote >
<p>
If it's valid Julia code, it's valid inside a <code>@model</code> block<br />
</p>
</blockquote>

</div>

</section>
<section id="slide-orgb135d5d-split">

<p>
But in our simple demo model, <code>s</code> and <code>m</code> are treated differently than <code>x</code> and <code>y</code><br />
</p>

<p>
<code>s</code> and <code>m</code> are considered as random variables to be inferred<br />
</p>

<p>
<code>x</code> and <code>y</code> are considered as data / conditioned<br />
</p>

<div class="fragment (appear)">

<p>
Basically, <code>L ~ R</code> is considered a <i>conditioned</i> variable if either<br />
</p>
<ol>
<li><code>L</code> is present in the arguments of the function defining the model, or<br /></li>
<li><code>L</code> is <i>conditioned</i> using <code>model | (L9 = ..., )</code> or similar.<br /></li>
<li><code>L</code> is a <i>literal</i>, e.g. <code>1.5 ~ Normal()</code>.<br /></li>

</ol>

<p>
<span class="underline">Otherwise</span>, <code>L</code> is considered a random variable<br />
</p>

</div>

</section>
<section id="slide-orgb135d5d-split">

<p>
The following are all equivalent<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">(1): using the arguments of the function</span>
<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo_v1(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
model_v1 = simple_demo_v1(1.5, 2.0)
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">(2): using the `|` operator / `condition`</span>
<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo_v2()
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
model_v2 = simple_demo_v2() | (x = 1.5, y = 2.0)
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">(3): when `L` is a literal</span>
<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo_v3()
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    1.5 ~ Normal(m, sqrt(s))
    2.0 ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
model_v3 = simple_demo_v3()
</code></pre>
</div>

</section>
<section id="slide-orgb135d5d-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>with_logger(NullLogger()) <span style="color: #0000FF;">do</span>  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">just surpressing the log output for presentation</span>
    chain_v1 = sample(model_v1, NUTS(), 1000; progress=<span style="color: #D0372D;">false</span>)
    chain_v2 = sample(model_v2, NUTS(), 1000; progress=<span style="color: #D0372D;">false</span>)
    chain_v3 = sample(model_v3, NUTS(), 1000; progress=<span style="color: #D0372D;">false</span>)
    plot(chainscat(chain_v1, chain_v2, chain_v3))
<span style="color: #0000FF;">end</span>
</code></pre>
</div>


<div id="org52ea4a5" class="figure">
<p><img src="assets/outputs/more-julia/ce69f397ca10a9e2661b065d19ad1468ed77de9a.svg" alt="ce69f397ca10a9e2661b065d19ad1468ed77de9a.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-orgb135d5d-split">

<p>
One thing that Turing.jl cannot handle is the following<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo_v1_failure(x, y)
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Used to be: y ~ Normal(m, sqrt(s))</span>
    z = y
    z ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>

model_v1_failure = simple_demo_v1_failure(1.5, 2.0)
model_v1_failure() <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`y` is treated as a random variable!!!</span>
</code></pre>
</div>

<pre class="example">
-1.6045141567134922
</pre>


<p>
Turing.jl performs no analysis of the code ⟹ don't know that <code>y</code> is constant<br />
</p>

</section>
<section id="slide-orgb135d5d-split">

<p>
<code>decondition</code> can be used to "undo" the conditioning of a variable<br />
</p>

<div class="fragment (appear)"
<p>
For <span class="underline">argument-based conditioning</span>, we need to replace it with <code>missing</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model_v1_decondition = simple_demo_v1(1.5, <span style="color: #D0372D;">missing</span>)
model_v1_decondition()  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`y` is now a random variable</span>
</code></pre>
</div>

<pre class="example">
0.011085659616252741
</pre>


</div>

<div class="fragment (appear)"
<p>
For <span class="underline">|-based conditioning</span>, we can just call <code>decondition</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model_v2_decondition = DynamicPPL.decondition(model_v2, <span style="color: #808080;">@varname</span>(y))
model_v2_decondition()  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`y` is now a random variable!</span>
</code></pre>
</div>

<pre class="example">
0.3154944722541396
</pre>

</div>

<div class="fragment (appear)"
<p>
For <span class="underline">literal-based conditioning</span>, <code>y</code> is hard-coded, so deconditioning is not possible<br />
</p>
</div>

</section>
<section id="slide-orgb135d5d-split">

<p>
Overall, |-based conditioning is preferred, i.e.<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> simple_demo_v2()
    s ~ InverseGamma(2, 3)
    m ~ Normal(0, sqrt(s))

    x ~ Normal(m, sqrt(s))
    y ~ Normal(m, sqrt(s))
<span style="color: #0000FF;">end</span>
model_v2 = simple_demo_v2() | (x = 1.5, y = 2.0)
</code></pre>
</div>

<p>
But you will also encounter the other two approaches in the wild<br />
</p>

</section>
<section id="slide-org2512cea">
<h3 id="org2512cea">Other actions on a <code>Model</code></h3>
</section>
<section id="slide-org2512cea-split">

<p>
<b>Computing probabilities</b><br />
</p>

<div class="fragment (appear)">
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>logprior(model, (s = 1, m = 1))
</code></pre>
</div>

<pre class="example">
-2.221713955868453
</pre>

</div>

<div class="fragment (appear)">
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>loglikelihood(model, (s = 1, m = 1))
</code></pre>
</div>

<pre class="example">
-2.4628770664093453
</pre>

</div>

<div class="fragment (appear)">
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>logjoint(model, (s = 1, m = 1))
</code></pre>
</div>

<pre class="example">
-4.6845910222777984
</pre>

</div>

</section>
<section id="slide-org2512cea-split">

<p>
<b>Conditioning and fixing</b><br />
</p>

<div class="fragment (appear)">
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Condition a variable to be a value</span>
model_with_condition = Turing.condition(model, s=1.0)  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">equivalent to `|` operator</span>
model_with_condition()
</code></pre>
</div>

<pre class="example">
(s = 1.0, m = 0.31819749773509765, x = 1.5, y = 2.0, hello = 42)
</pre>

</div>

<div class="fragment (appear)">
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Fix a variable to a value</span>
model_with_fixed = Turing.fix(model, s=1.0)
model_with_fixed()
</code></pre>
</div>

<pre class="example">
(s = 1.0, m = -1.662009914303139, x = 1.5, y = 2.0, hello = 42)
</pre>

</div>

<div class="fragment (appear)">
<p>
Difference between conditioning and fixing<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>logjoint(model_with_condition, (m=1,)), logjoint(model_with_fixed, (m=1,))
</code></pre>
</div>

<pre class="example">
(-4.6845910222777984, -3.881815599614018)
</pre>


<p>
A <code>fixed</code> variable is <span class="underline">not</span> included in the log-probability<br />
</p>
</div>

</section>
<section id="slide-org2512cea-split">

<p>
And can query the model about these things<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DynamicPPL.observations(model_with_condition)
</code></pre>
</div>

<pre class="example">
(s = 1.0,)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DynamicPPL.fixed(model_with_fixed)
</code></pre>
</div>

<pre class="example">
(s = 1.0,)
</pre>


<p>
<a href="https://turinglang.org/library/DynamicPPL/stable/api/">And much more&#x2026;</a><br />
</p>

</section>
<section id="slide-org33622d6">
<h3 id="org33622d6">Back to our working example: S(E)IR model</h3>
</section>
<section id="slide-org33622d6-split">

<p>
We'll use the following model<br />
</p>
<div>
\begin{equation*}
\begin{split}
  \beta &\sim \mathcal{N}_{ + }(2, 1) \\
  \gamma &\sim \mathcal{N}_{ + }(0.4, 0.5) \\
  \phi^{-1} &\sim \mathrm{Exponential}(1/5) \\
   y_i &\sim \mathrm{NegativeBinomial2}\big(F(u_0, t_i;\ \beta, \gamma), \phi \big)
\end{split}
\end{equation*}

</div>
<p>
where<br />
</p>
<ul>
<li>\(\big( y_i \big)_{i = 1}^{14}\) are the observations,<br /></li>
<li>\(F\) is the integrated system, and<br /></li>
<li>\(\phi\) is the over-dispersion parameter.<br /></li>

</ul>

</section>
<section id="slide-org33622d6-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(
    plot(truncated(Normal(2, 1); lower=0), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#946;"</span>),
    plot(truncated(Normal(0.4, 0.5); lower=0), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#947;"</span>),
    plot(Exponential(1/5), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#981;&#8315;&#185;"</span>),
    layout=(3, 1)
)
</code></pre>
</div>


<div id="org94c17e6" class="figure">
<p><img src="assets/outputs/more-julia/80c76ad5d3151ec0f3e044a075b2a5b88956d14b.svg" alt="80c76ad5d3151ec0f3e044a075b2a5b88956d14b.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-org33622d6-split">

<p>
<code>NegativeBinomial(r, p)</code> represents the number of trials to achieve \(r\) successes, where each trial has a probability \(p\) of success<br />
</p>

<p>
<code>NegativeBinomial2(μ, ϕ)</code> is parameterized by mean \(μ\) and <i>dispersion</i> \(\phi\)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`NegativeBinomial` already exists, so let's just make an alternative constructor instead.</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">NegativeBinomial2</span>(&#956;, &#981;)
    p = 1/(1 + &#956;/&#981;)
    r = &#981;
    <span style="color: #0000FF;">return</span> NegativeBinomial(r, p)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
NegativeBinomial2 (generic function with 1 method)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Let's just make sure we didn't do something stupid.</span>
&#956; = 2; &#981; = 3;
dist = NegativeBinomial2(&#956;, &#981;)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Source: https://mc-stan.org/docs/2_20/functions-reference/nbalt.html</span>
mean(dist) &#8776; &#956; &amp;&amp; var(dist) &#8776; &#956; + &#956;^2 / &#981;
</code></pre>
</div>

<pre class="example">
true
</pre>


</section>
<section id="slide-org33622d6-split">

<p>
And here's the full model<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> sir_model(
    num_days;                                  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Number of days to model</span>
    tspan = (0.0, float(num_days)),            <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Timespan to model</span>
    u0 = [N - 1, 1, 0.0],                      <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Initial state</span>
    p0 = [2.0, 0.6],                           <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Placeholder parameters</span>
    problem = ODEProblem(SIR!, u0, tspan, p0)  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create problem once so we can `remake`.</span>
)
    &#946; ~ truncated(Normal(2, 1); lower=0)
    &#947; ~ truncated(Normal(0.4, 0.5); lower=0)
    &#981;&#8315;&#185; ~ Exponential(1/5)
    &#981; = inv(&#981;&#8315;&#185;)

    problem_new = remake(problem, p=[&#946;, &#947;])  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Replace parameters `p`.</span>
    sol = solve(problem_new, saveat=1)       <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Solve!</span>

    sol_for_observed = sol[2, 2:num_days + 1]  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Timesteps we have observations for.</span>
    in_bed = Vector{Int}(<span style="color: #D0372D;">undef</span>, num_days)
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">=</span> 1:length(sol_for_observed)
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Add a small constant to `sol_for_observed` to make things more stable.</span>
        in_bed[i] ~ NegativeBinomial2(sol_for_observed[i] + 1e-5, &#981;)
    <span style="color: #0000FF;">end</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Some quantities we might be interested in.</span>
    <span style="color: #0000FF;">return</span> (R0 = &#946; / &#947;, recovery_time = 1 / &#947;, infected = sol_for_observed)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
sir_model (generic function with 2 methods)
</pre>


<p>
It's break-down time<br />
</p>

</section>
<section id="slide-org33622d6-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">function</span> <span style="color: #006699;">sir_model</span>(
    num_days;                                  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Number of days to model</span>
    tspan = (0.0, float(num_days)),            <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Timespan to model</span>
    u0 = [N - 1, 1, 0.0],                      <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Initial state</span>
    p0 = [2.0, 0.6],                           <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Placeholder parameters</span>
    problem = ODEProblem(SIR!, u0, tspan, p0)  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Create problem once so we can `remake`.</span>
)
    ...
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

</section>
<section id="slide-org33622d6-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>&#946; ~ truncated(Normal(2, 1); lower=0)
&#947; ~ truncated(Normal(0.4, 0.5); lower=0)
&#981;&#8315;&#185; ~ Exponential(1/5)
&#981; = inv(&#981;&#8315;&#185;)
</code></pre>
</div>

<p>
defines our prior<br />
</p>

<p>
<code>truncated</code> is just a way of restricting the domain of the distribution you pass it<br />
</p>

</section>
<section id="slide-org33622d6-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>problem_new = remake(problem, p=[&#946;, &#947;])  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Replace parameters `p`.</span>
sol = solve(problem_new, saveat=1)       <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Solve!</span>
</code></pre>
</div>

<p>
We then remake the problem, now with the parameters <code>[β, γ]</code> sampled above<br />
</p>

<p>
<code>saveat = 1</code> gets us the solution at the timesteps <code>[0, 1, 2, ..., 14]</code><br />
</p>

</section>
<section id="slide-org33622d6-split">

<p>
Then we extract the timesteps we have observations for<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sol_for_observed = sol[2, 2:num_days + 1]  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Timesteps we have observations for.</span>
</code></pre>
</div>

<p>
and define what's going to be a likelihood (once we add observations)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>in_bed = Vector{Int}(<span style="color: #D0372D;">undef</span>, num_days)
<span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">=</span> 1:length(sol_for_observed)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Add a small constant to `sol_for_observed` to make things more stable.</span>
    in_bed[i] ~ NegativeBinomial2(sol_for_observed[i] + 1e-5, &#981;)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

</section>
<section id="slide-org33622d6-split">

<p>
Finally we return some values that might be of interest<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Some quantities we might be interested in.</span>
<span style="color: #0000FF;">return</span> (R0 = &#946; / &#947;, recovery_time = 1 / &#947;, infected = sol_for_observed)
</code></pre>
</div>

<p>
This is useful for a post-sampling diagnostics, debugging, etc.<br />
</p>

</section>
<section id="slide-org33622d6-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model = sir_model(length(data.in_bed))
</code></pre>
</div>

<pre class="example">
Model(
  args = (:num_days,)
  defaults = (:tspan, :u0, :p0, :problem)
  context = DynamicPPL.DefaultContext()
)
</pre>


<p>
The model is just another function, so we can call it to check that it works<br />
</p>

<div class="fragment (appear)">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model().infected
</code></pre>
</div>

<pre class="example" id="org4ce3c90">
14-element Vector{Float64}:
   7.245479773214603
  46.940917072935044
 175.06842724268554
 218.33349924642326
 135.9699709916868
  67.18345574595645
  30.7778031212463
  13.708529913965242
   6.037403608626295
   2.646112937992608
   1.1574372086041416
   0.5058188715354062
   0.22097215001835135
   0.09654724443857109
</pre>

<p>
Hey, it does!<br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable">
<h3 id="2023-01-29-16-57-28-Is-the-prior-reasonable">Is the prior reasonable?</h3>
<p>
Before we do any inference, we should check if the prior is reasonable<br />
</p>

<p>
From domain knowledge we know that (for influenza at least)<br />
</p>
<ul>
<li class="fragment appear">\(R_0\) is typically between 1 and 2<br /></li>
<li class="fragment appear"><code>recovery_time</code> (\(1 / \gamma\)) is usually ~1 week<br /></li>

</ul>

<div class="fragment (appear)">

<p>
We want to make sure that your prior belief reflects this knowledge while still being flexible enough to accommodate the observations<br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable-split">

<p>
To check this we'll just simulate some draws from our prior model, i.e. the model <i>without</i> conditioning on <code>in_bed</code><br />
</p>

<p>
There are two ways to sample form the prior<br />
</p>

<div class="fragment (appear)">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">1. By just calling the `model`, which returns a `NamedTuple` containing the quantities of interest</span>
print(model())
</code></pre>
</div>

<pre class="example">
(R0 = 3.421935966345707, recovery_time = 1.0862660411734395, infected = [9.113559456088096, 70.63033985892632, 239.93016676827358, 232.25038629413262, 130.1989796907194, 62.916178149981135, 29.018913772921493, 13.152593290124099, 5.918461197786946, 2.6551129148637975, 1.1895164910507834, 0.532615267682943, 0.238423148128917, 0.10672170534563777])
</pre>


</div>

<div class="fragment (appear)">

<p>
Or by just calling <code>sample</code> using <code>Prior</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Sample from prior.</span>
chain_prior = sample(model, Prior(), 10_000);
</code></pre>
</div>

<pre class="example">
Sampling: 100%|█████████████████████████████████████████| Time: 0:00:00

</pre>


</div>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable-split">

<p>
Let's have a look at the prior predictive<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>p = plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300))
plot_trajectories!(p, group(chain_prior, <span style="color: #D0372D;">:in_bed</span>); n = 1000)
hline!([N], color=<span style="color: #008000;">"red"</span>)
</code></pre>
</div>


<div id="orgfbee3c9" class="figure">
<p><img src="assets/outputs/more-julia/f110b08ba2b09629fd9d3c498a45a8ab21e0915a.svg" alt="f110b08ba2b09629fd9d3c498a45a8ab21e0915a.svg" class="org-svg" /><br />
</p>
</div>

<p class="fragment (appear)">
For certain values we get number of infected <i>larger</i> than the actual population<br />
</p>

<p class="fragment (appear)">
But this is includes the randomness from <code>NegativeBinomial2</code> likelihood<br />
</p>

<p class="fragment (appear)">
Maybe more useful to inspect the (I)nfected state from the ODE solution?<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable-split">

<p>
We can also look at the <code>generated_quantities</code>, i.e. the values from the <code>return</code> statement in our model<br />
</p>

<div class="fragment (appear)">
<p>
Our <code>return</code> looked like this<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Some quantities we might be interested in.</span>
<span style="color: #0000FF;">return</span> (R0 = &#946; / &#947;, recovery_time = 1 / &#947;, infected = sol_for_observed)
</code></pre>
</div>

</div>

<div class="fragment (appear)">
<p>
and so <code>generated_quantities</code> (conditioned on <code>chain_prior</code>) gives us<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>quantities_prior = generated_quantities(model, chain_prior)
print(quantities_prior[1])
</code></pre>
</div>

<pre class="example">
(R0 = 2.204935947161777, recovery_time = 1.876174703727979, infected = [1.8956442506599653, 3.580784916960343, 6.719169194301077, 12.45349236430635, 22.56926177862657, 39.32277667182724, 64.20929976637757, 95.1804136876868, 124.39989367504738, 141.63232495725526, 141.78069289388353, 127.90160667286129, 106.85701946772551, 84.60953676844156])
</pre>


</div>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable-split">

<p>
We can convert it into a <code>Chains</code> using a utility function of mine<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Convert to `Chains`.</span>
chain_quantities_prior = to_chains(quantities_prior);

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Plot.</span>
p = plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300))
plot_trajectories!(p, group(chain_quantities_prior, <span style="color: #D0372D;">:infected</span>); n = 1000)
hline!([N], color=<span style="color: #008000;">"red"</span>)
</code></pre>
</div>


<div id="org59170c2" class="figure">
<p><img src="assets/outputs/more-julia/a1b75cd5d378febc7029c1ed63db2831e09ab9ee.svg" alt="a1b75cd5d378febc7029c1ed63db2831e09ab9ee.svg" class="org-svg" /><br />
</p>
</div>

<div class="x-small-text">

<p>
<b>NOTE:</b> <code>to_chains</code> is not part of "official" Turing.jl because the <code>return</code> can contain <i>whatever</i> you want, and so it's not always possible to convert into a <code>Chains</code><br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable-split">

<p>
And the quantiles for the trajectories<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>p = plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300))
plot_trajectory_quantiles!(p, group(chain_quantities_prior, <span style="color: #D0372D;">:infected</span>))
hline!(p, [N], color=<span style="color: #008000;">"red"</span>)
</code></pre>
</div>


<div id="orgb50d0e8" class="figure">
<p><img src="assets/outputs/more-julia/3f7598c6f0df5f376d9f89161504465787bacf25.svg" alt="3f7598c6f0df5f376d9f89161504465787bacf25.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Is-the-prior-reasonable-split">


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(quantile(chain_quantities_prior[:, [<span style="color: #D0372D;">:R0</span>, <span style="color: #D0372D;">:recovery_time</span>], :]))
</code></pre>
</div>

<pre class="example">
2×6 DataFrame
 Row │ parameters     2.5%      25.0%    50.0%    75.0%    97.5%   
     │ Symbol         Float64   Float64  Float64  Float64  Float64 
─────┼─────────────────────────────────────────────────────────────
   1 │ R0             0.534892  2.09785  3.71417  7.36482  59.3506
   2 │ recovery_time  0.709748  1.20969  1.88343  3.54966  27.4522
</pre>


<p>
Compare to our prior knowledge of \(R_0 \in [1, 2]\) and \((1/\gamma) \approx 1\) for influenza<br />
</p>

<p>
Do we really need probability mass on \(R_0 \ge 10\)?<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-s-wrong-with-the-current-prior">
<h3 id="2023-01-29-16-57-28-What-s-wrong-with-the-current-prior"><span class="todo TASK">TASK</span> Can we improve the current prior?</h3>
<div class="side-by-side">

<div style="margin: auto;">

<p>
The SIR model<br />
</p>

<div>
\begin{equation*}
\begin{split}
  \frac{\mathrm{d} S}{\mathrm{d} t} &= - \beta S \frac{I}{N} \\
  \frac{\mathrm{d} I}{\mathrm{d} t} &= \beta S \frac{I}{N} - \gamma I \\
  \frac{\mathrm{d} R}{\mathrm{d} t} &= \gamma I
\end{split}
\end{equation*}

</div>

</div>

<div>

<p>
And here's the current priors<br />
</p>

<div class="x-small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(
    plot(truncated(Normal(2, 1); lower=0), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#946;"</span>),
    plot(truncated(Normal(0.4, 0.5); lower=0), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#947;"</span>),
    plot(Exponential(1/5), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#981;&#8315;&#185;"</span>),
    layout=(3, 1)
)
</code></pre>
</div>


<div id="orgef9c2ef" class="figure">
<p><img src="assets/outputs/more-julia/80c76ad5d3151ec0f3e044a075b2a5b88956d14b.svg" alt="80c76ad5d3151ec0f3e044a075b2a5b88956d14b.svg" class="org-svg" /><br />
</p>
</div>

</div>

</div>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Recovery-time-shouldn-t-be-several-years">
<h3 id="2023-01-29-16-57-28-Recovery-time-shouldn-t-be-several-years"><span class="done SOLUTION">SOLUTION</span> Recovery time shouldn't be several years</h3>
<p>
We mentioned that <code>recovery_time</code>, which is expressed as \(1 / \gamma\), is ~1 week<br />
</p>

<p>
We're clearly putting high probability on regions near 0, i.e. <i>long</i> recovery times<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(truncated(Normal(0.4, 0.5); lower=0), label=<span style="color: #D0372D;">nothing</span>, title=<span style="color: #008000;">"&#947;"</span>, size=(500, 300))
</code></pre>
</div>


<div id="org8b9d0e6" class="figure">
<p><img src="assets/outputs/more-julia/ed3058dc552f72dbe5151feb938d103b75251f63.svg" alt="ed3058dc552f72dbe5151feb938d103b75251f63.svg" class="org-svg" /><br />
</p>
</div>

<p>
<span class="underline">Should probably be putting less probability mass near 0</span><br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N">
<h3 id="2023-01-29-16-57-28-What-if-color-red-beta-N"><span class="done SOLUTION">SOLUTION</span> What if \({\color{red} \beta} > N\)?</h3>
<p>
Then for \(t = 0\) we have<br />
</p>
<div>
\begin{equation*}
\frac{\mathrm{d} S}{\mathrm{d} t} \bigg|_{t = 0} = - {\color{red} \beta} S \frac{I}{N} > - N (N - 1) \frac{1}{N} = - (N - 1)
\end{equation*}

</div>

<p>
i.e. we <i>immediately</i> infect everyone on the very first time-step<br />
</p>

<p>
Also doesn't seem very realistic<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
<i>But</i> under our current prior does this matter?<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">&#8473;(&#946; &gt; N) = 1 - &#8473;(&#946; &#8804; N)</span>
1 - cdf(truncated(Normal(2, 1); lower=0), N)
</code></pre>
</div>

<pre class="example">
0.0
</pre>


<p>
Better yet<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>quantile(truncated(Normal(2, 1); lower=0), 0.95)
</code></pre>
</div>

<pre class="example">
3.6559843567138275
</pre>


<p>
i.e. 95% of the probability mass falls below ~3.65<br />
</p>

<p>
⟹ <span class="underline">Current prior for \(\beta\) seems fine (✓)</span><br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
Before we change the prior, let's also make it a bit easier to change the prior using <code>@submodel</code><br />
</p>

<div class="fragment (appear)">

<p>
<code>@submodel</code> allows you call models within models, e.g.<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> ModelA()
    x_hidden_from_B ~ Normal()
    x = x_hidden_from_B + 100
    <span style="color: #0000FF;">return</span> x
<span style="color: #0000FF;">end</span>

<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> ModelB()
    <span style="color: #808080;">@submodel</span> x = ModelA()
    y ~ Normal(x, 1)

    <span style="color: #0000FF;">return</span> (; x, y)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
ModelB (generic function with 2 methods)
</pre>


</div>

<div class="fragment (appear)">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">So if we call `B` we only see `x` and `y`</span>
println(ModelB()())
</code></pre>
</div>

<pre class="example">
(x = 101.64055653138922, y = 100.7647417887675)
</pre>


</div>

<div class="fragment (appear)">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">While if we sample from `B` we get the latent variables</span>
println(rand(ModelB()))
</code></pre>
</div>

<pre class="example">
(x_hidden_from_B = -0.1589429806607626, y = 98.49097210754098)
</pre>


</div>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
To avoid clashes of variable-names, we can specify a <code>prefix</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> ModelA() = (x ~ Normal(); <span style="color: #0000FF;">return</span> x + 100)

<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> ModelB()
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Given it a prefix to use for the variables in `A`.</span>
    <span style="color: #808080;">@submodel</span> prefix=<span style="color: #D0372D;">:inner</span> x_inner = ModelA()
    x ~ Normal(x_inner, 1)

    <span style="color: #0000FF;">return</span> (; x_inner, x)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
ModelB (generic function with 2 methods)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>print(rand(ModelB()))
</code></pre>
</div>

<pre class="example">
(var"inner.x" = 1.152744983322086, x = 101.51855299222316)
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
<code>@submodel</code> is useful as it allows you to:<br />
</p>
<ol>
<li>Easy to swap out certain parts of your model.<br /></li>
<li>Can re-use models across projects and packages.<br /></li>

</ol>

<p>
When working on larger projects, this really shines<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
Equipped with <code>@submodel</code> we can replace<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>&#946; ~ truncated(Normal(2, 1); lower=0)
&#947; ~ truncated(Normal(0.4, 0.5); lower=0)
</code></pre>
</div>

<p>
with<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@submodel</span> p = prior(problem_wrapper)
</code></pre>
</div>

<div class="fragment (appear)">

<p>
where <code>prior</code> can be something like<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> prior_original(problem_wrapper::<span style="color: #6434A3;">SIRProblem</span>)
    &#946; ~ truncated(Normal(2, 1); lower=0)
    &#947; ~ truncated(Normal(0.4, 0.5); lower=0)

    <span style="color: #0000FF;">return</span> [&#946;, &#947;]
<span style="color: #0000FF;">end</span>

<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> prior_improved(problem_wrapper::<span style="color: #6434A3;">SIRProblem</span>)
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Should probably also lower mean for `&#946;` since</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">more probability mass on small `&#947;` &#10233; `R0 =  &#946; / &#947;` grows.</span>
    &#946; ~ truncated(Normal(1, 1); lower=0)
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> New prior for `&#947;`.</span>
    &#947; ~ Beta(2, 5)

    <span style="color: #0000FF;">return</span> [&#946;, &#947;]
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
prior_improved (generic function with 2 methods)
</pre>


</div>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> epidemic_model(
    problem_wrapper::<span style="color: #6434A3;">AbstractEpidemicProblem</span>,
    prior  <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> now we just pass the prior as an argument</span>
)
    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> And use `@submodel` to embed the `prior` in our model.</span>
    <span style="color: #808080;">@submodel</span> p = prior(problem_wrapper)

    &#981;&#8315;&#185; ~ Exponential(1/5)
    &#981; = inv(&#981;&#8315;&#185;)

    problem_new = remake(problem_wrapper.problem, p=p)  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Replace parameters `p`.</span>
    sol = solve(problem_new, saveat=1)                  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Solve!</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Extract the `infected`.</span>
    sol_for_observed = infected(problem_wrapper, sol)[2:<span style="color: #0000FF;">end</span>]

    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> `product_distribution` is faster for larger dimensional problems,</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">and it does not require explicit allocation of the vector.</span>
    in_bed ~ product_distribution(NegativeBinomial2.(sol_for_observed .+ 1e-5, &#981;))

    &#946;, &#947; = p[1:2]
    <span style="color: #0000FF;">return</span> (R0 = &#946; / &#947;, recovery_time = 1 / &#947;, infected = sol_for_observed)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
epidemic_model (generic function with 2 methods)
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<div class="x-small-text">

<p>
Another neat trick is to return early if integration fail<br />
</p>

</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> epidemic_model(
    problem_wrapper::<span style="color: #6434A3;">AbstractEpidemicProblem</span>,
    prior  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">now we just pass the prior as an argument</span>
)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">And use `@submodel` to embed the `prior` in our model.</span>
    <span style="color: #808080;">@submodel</span> p = prior(problem_wrapper)

    &#981;&#8315;&#185; ~ Exponential(1/5)
    &#981; = inv(&#981;&#8315;&#185;)

    problem_new = remake(problem_wrapper.problem, p=p)  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Replace parameters `p`.</span>
    sol = solve(problem_new, saveat=1)                  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Solve!</span>

    <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Return early if integration failed.</span>
    <span style="color: #0000FF;">if</span> !Part2.issuccess(sol)
        Turing.<span style="color: #808080;">@addlogprob!</span> -<span style="color: #D0372D;">Inf</span>  <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Causes automatic rejection.</span>
        <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">nothing</span>
    <span style="color: #0000FF;">end</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Extract the `infected`.</span>
    sol_for_observed = infected(problem_wrapper, sol)[2:<span style="color: #0000FF;">end</span>]

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">`product_distribution` is faster for larger dimensional problems,</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">and it does not require explicit allocation of the vector.</span>
    in_bed ~ product_distribution(NegativeBinomial2.(sol_for_observed .+ 1e-5, &#981;))

    &#946;, &#947; = p[1:2]
    <span style="color: #0000FF;">return</span> (R0 = &#946; / &#947;, recovery_time = 1 / &#947;, infected = sol_for_observed)
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
epidemic_model (generic function with 2 methods)
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
Equipped with this we can now easily construct <i>two</i> models using different priors<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>sir = SIRProblem(N);
model_original = epidemic_model(sir, prior_original);
model_improved = epidemic_model(sir, prior_improved);
</code></pre>
</div>

<p>
but using the same underlying <code>epidemic_model</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain_prior_original = sample(model_original, Prior(), 10_000; progress=<span style="color: #D0372D;">false</span>);
chain_prior_improved = sample(model_improved, Prior(), 10_000; progress=<span style="color: #D0372D;">false</span>);
</code></pre>
</div>

<p>
Let's compare the resulting priors over some of the quantities of interest<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
Let's compare the <code>generated_quantities</code>, e.g. \(R_0\)<br />
</p>

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain_quantities_original = to_chains(
    generated_quantities(
        model_original,
        chain_prior_original
    );
);

chain_quantities_improved = to_chains(
    generated_quantities(
        model_improved,
        chain_prior_improved
    );
);
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>p = plot(; legend=<span style="color: #D0372D;">false</span>, size=(500, 200))
plot_trajectories!(p, group(chain_quantities_original, <span style="color: #D0372D;">:infected</span>); n = 100, trajectory_color=<span style="color: #008000;">"red"</span>)
plot_trajectories!(p, group(chain_quantities_improved, <span style="color: #D0372D;">:infected</span>); n = 100, trajectory_color=<span style="color: #008000;">"blue"</span>)
hline!([N], color=<span style="color: #008000;">"red"</span>, linestyle=<span style="color: #D0372D;">:dash</span>)
</code></pre>
</div>


<div id="org4d8f05d" class="figure">
<p><img src="assets/outputs/more-julia/2e1579a71c4072534cabe41a233cd283543874e6.svg" alt="2e1579a71c4072534cabe41a233cd283543874e6.svg" class="org-svg" /><br />
</p>
</div>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plt1 = plot(legend=<span style="color: #D0372D;">false</span>)
plot_trajectory_quantiles!(plt1, group(chain_quantities_original, <span style="color: #D0372D;">:infected</span>))
hline!(plt1, [N], color=<span style="color: #008000;">"red"</span>, linestyle=<span style="color: #D0372D;">:dash</span>)

plt2 = plot(legend=<span style="color: #D0372D;">false</span>)
plot_trajectory_quantiles!(plt2, group(chain_quantities_improved, <span style="color: #D0372D;">:infected</span>))
hline!(plt2, [N], color=<span style="color: #008000;">"red"</span>, linestyle=<span style="color: #D0372D;">:dash</span>)

plot(plt1, plt2, layout=(2, 1))
</code></pre>
</div>


<div id="org1d2bbd2" class="figure">
<p><img src="assets/outputs/more-julia/cffea7a80541e6f61fd182de85cb18bc8520b0b4.svg" alt="cffea7a80541e6f61fd182de85cb18bc8520b0b4.svg" class="org-svg" /><br />
</p>
</div>

</div>

<p>
This makes sense: if half of the population is immediately infected ⟹ number of infected tapers wrt. time as they recover<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-What-if-color-red-beta-N-split">

<p>
For <code>model_improved</code> we then have<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(quantile(chain_quantities_improved[:, [<span style="color: #D0372D;">:R0</span>, <span style="color: #D0372D;">:recovery_time</span>], :]))
</code></pre>
</div>

<pre class="example">
2×6 DataFrame
 Row │ parameters     2.5%      25.0%    50.0%    75.0%    97.5%   
     │ Symbol         Float64   Float64  Float64  Float64  Float64 
─────┼─────────────────────────────────────────────────────────────
   1 │ R0             0.311812  2.28184  4.43501  8.35226  34.1911
   2 │ recovery_time  1.56854   2.54757  3.75472  6.21961  22.6241
</pre>


<p>
Compare to <code>model_original</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(quantile(chain_quantities_original[:, [<span style="color: #D0372D;">:R0</span>, <span style="color: #D0372D;">:recovery_time</span>], :]))
</code></pre>
</div>

<pre class="example">
2×6 DataFrame
 Row │ parameters     2.5%      25.0%    50.0%    75.0%    97.5%   
     │ Symbol         Float64   Float64  Float64  Float64  Float64 
─────┼─────────────────────────────────────────────────────────────
   1 │ R0             0.528003  2.10801  3.77232  7.34902  73.5875
   2 │ recovery_time  0.707391  1.22814  1.89126  3.54464  33.5939
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Make-epidemic-model-work-for-SEIRProblem">
<h3 id="2023-01-29-16-57-28-Make-epidemic-model-work-for-SEIRProblem"><span class="todo TASK">TASK</span> Make <code>epidemic_model</code> work for <code>SEIRProblem</code></h3>
<ol>
<li class="off"><code>[&#xa0;]</code> Implement a prior which also includes \(\sigma\) and execute<br />
<code>epidemic_model</code> with it<br /></li>
<li class="off"><code>[&#xa0;]</code> Can we make a better prior for \(\sigma\)? Do we even need one?<br /></li>

</ol>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> prior_original(problem_wrapper::<span style="color: #6434A3;">SEIRProblem</span>)
    <span style="color: #8D8D84;"># </span><span style="color: #ffa500; font-weight: bold; font-style: italic;">TODO:</span><span style="color: #8D8D84; font-style: italic;"> Implement</span>
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-">
<h3 id="2023-01-29-16-57-28-">SOLUTION</h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> prior_original(problem_wrapper::<span style="color: #6434A3;">SEIRProblem</span>)
    &#946; ~ truncated(Normal(2, 1); lower=0)
    &#947; ~ truncated(Normal(0.4, 0.5); lower=0)
    &#963; ~ truncated(Normal(0.8, 0.5); lower=0)

    <span style="color: #0000FF;">return</span> [&#946;, &#947;, &#963;]
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
prior_original (generic function with 4 methods)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model_seir = epidemic_model(SEIRProblem(N), prior_original)
print(model_seir())
</code></pre>
</div>

<pre class="example">
(R0 = 1.1047986187921068, recovery_time = 0.9906676968248809, infected = [0.5602452665531149, 0.5136476859462638, 0.5266355538208665, 0.5493052805718489, 0.5741884446928026, 0.6001760717397501, 0.6271154531635528, 0.6549950994966428, 0.683772907797617, 0.7135447417415389, 0.744111701180274, 0.775785089897001, 0.8083022220361633, 0.8416712774662599])
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Consult-with-domain-experts">
<h3 id="2023-01-29-16-57-28-Consult-with-domain-experts"><span class="todo WARNING">WARNING</span> Consult with domain experts</h3>
<p>
This guy should <span class="underline">not</span> be the one setting your priors!<br />
</p>


<div id="orgba2010e" class="figure">
<p><img src="assets/attachments/2023-01-18_14-49-24_471337_3317365246956_1262712540_o.jpg" alt="2023-01-18_14-49-24_471337_3317365246956_1262712540_o.jpg" height="400px" /><br />
</p>
</div>

<p>
Get an actual scientist to do that&#x2026;<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Condition">
<h3 id="2023-01-29-16-57-28-Condition">Condition</h3>
<p>
Now let's actually involve the data<br />
</p>

<div class="fragment (appear)">

<p>
We can condition a <code>Model</code> as so<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Condition on the observations.</span>
model = epidemic_model(SIRProblem(N), prior_improved)
model_conditioned = model | (in_bed = data.in_bed,)
</code></pre>
</div>

<pre class="example">
Model(
  args = (:problem_wrapper, :prior)
  defaults = ()
  context = ConditionContext((in_bed = [3, 8, 26, 76, 225, 298, 258, 233, 189, 128, 68, 29, 14, 4],), DynamicPPL.DefaultContext())
)
</pre>


</div>

<div class="fragment (appear)">

<p>
You know what time it is: <i>inference time</i>!<br />
</p>

</div>


</section>
<section id="slide-2023-01-29-16-57-28-Metropolis-Hastings--MH">
<h3 id="2023-01-29-16-57-28-Metropolis-Hastings--MH">Metropolis-Hastings (MH)</h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain_mh = sample(model_conditioned, MH(), MCMCThreads(), 10_000, 4; discard_initial=5_000);
</code></pre>
</div>

<p>
Rhat is <i>okay-ish</i> but not great, and ESS is pretty low innit?<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Metropolis-Hastings--MH-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(chain_mh; size=(800, 500))
</code></pre>
</div>


<div id="orgb52ff47" class="figure">
<p><img src="assets/outputs/more-julia/7763ba1e7b6bb223fde4d453cab14cbcf723b75a.svg" alt="7763ba1e7b6bb223fde4d453cab14cbcf723b75a.svg" class="org-svg" /><br />
</p>
</div>

<p>
Eeehh doesn't look the greatest<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Metropolis-Hastings--MH-split">

<p>
Difficult to trust these results, but let's check if it at least did <i>something</i> useful<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">We're using the unconditioned model!</span>
predictions_mh = predict(model, chain_mh)
</code></pre>
</div>

<pre class="example" id="org14118b7">
Chains MCMC chain (10000×14×4 Array{Float64, 3}):

Iterations        = 1:1:10000
Number of chains  = 4
Samples per chain = 10000
parameters        = in_bed[1], in_bed[2], in_bed[3], in_bed[4], in_bed[5], in_bed[6], in_bed[7], in_bed[8], in_bed[9], in_bed[10], in_bed[11], in_bed[12], in_bed[13], in_bed[14]
internals         = 

Summary Statistics
  parameters       mean       std      mcse     ess_bulk     ess_tail      rha ⋯
      Symbol    Float64   Float64   Float64      Float64      Float64   Float6 ⋯

   in_bed[1]     3.3496    2.2548    0.0143   28844.0197   24663.7952    1.000 ⋯
   in_bed[2]    11.0049    5.6044    0.1124    2485.6291    4471.3269    1.001 ⋯
   in_bed[3]    34.8531   16.6902    0.5174     993.2220    2136.9653    1.004 ⋯
   in_bed[4]    95.1006   43.6147    1.5454     739.0583    1949.4236    1.005 ⋯
   in_bed[5]   190.1128   82.0691    2.5249     951.7581    2492.6706    1.003 ⋯
   in_bed[6]   250.7661   99.5104    1.9748    2134.3829    2956.1255    1.001 ⋯
   in_bed[7]   237.7858   92.0707    1.1639    5027.4189    3758.1239    1.002 ⋯
   in_bed[8]   186.2204   73.3891    1.1480    3683.3975    2930.1316    1.003 ⋯
   in_bed[9]   131.9364   52.5514    1.1589    1980.6418    2853.4127    1.003 ⋯
  in_bed[10]    89.4755   36.8751    0.9178    1551.2900    2489.5252    1.004 ⋯
  in_bed[11]    59.3121   25.7064    0.7421    1164.8430    2155.1517    1.005 ⋯
  in_bed[12]    38.8393   17.4595    0.5330    1041.9480    2363.9809    1.007 ⋯
  in_bed[13]    25.2249   12.1044    0.4070     897.4136    1677.4979    1.009 ⋯
  in_bed[14]    16.2789    8.3131    0.2775     896.9420    1922.5588    1.009 ⋯
                                                               2 columns omitted

Quantiles
  parameters      2.5%      25.0%      50.0%      75.0%      97.5% 
      Symbol   Float64    Float64    Float64    Float64    Float64 

   in_bed[1]    0.0000     2.0000     3.0000     5.0000     9.0000
   in_bed[2]    2.0000     7.0000    10.0000    14.0000    24.0000
   in_bed[3]   11.0000    24.0000    32.0000    43.0000    73.0000
   in_bed[4]   31.0000    66.0000    88.0000   116.0000   199.0000
   in_bed[5]   66.0000   135.0000   179.0000   230.0000   386.0000
   in_bed[6]   92.0000   183.0000   240.0000   303.0000   480.0000
   in_bed[7]   88.0000   176.0000   228.0000   287.0000   448.0250
   in_bed[8]   69.0000   137.0000   178.0000   225.0000   354.0000
   in_bed[9]   47.0000    96.0000   126.0000   160.0000   254.0000
  in_bed[10]   31.0000    65.0000    85.0000   109.0000   176.0000
  in_bed[11]   19.0000    42.0000    56.0000    73.0000   119.0000
  in_bed[12]   12.0000    27.0000    37.0000    48.0000    80.0000
  in_bed[13]    7.0000    17.0000    24.0000    31.0000    54.0000
  in_bed[14]    4.0000    10.0000    15.0000    21.0000    36.0000
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Metropolis-Hastings--MH-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot_trajectories!(plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300)), predictions_mh; data=data)
</code></pre>
</div>


<div id="org81469cb" class="figure">
<p><img src="assets/outputs/more-julia/53d5bcefafe0e9c29e4ee0f560bc2648d8b43118.svg" alt="53d5bcefafe0e9c29e4ee0f560bc2648d8b43118.svg" class="org-svg" /><br />
</p>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot_trajectory_quantiles!(plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300)), predictions_mh; data=data)
</code></pre>
</div>


<div id="org1fb4c85" class="figure">
<p><img src="assets/outputs/more-julia/0d84524cc352ba3471bf66156dda0a8cfd1e66b9.svg" alt="0d84524cc352ba3471bf66156dda0a8cfd1e66b9.svg" class="org-svg" /><br />
</p>
</div>

<p>
Okay, it's not <i>completely</i> useless, but my trust-issues are still present.<br />
</p>

<p>
Metropolis-Hastings have disappointed me one too many times before.<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-So-instead-let-s-go-NUTS">
<h3 id="2023-01-29-16-57-28-So-instead-let-s-go-NUTS">So instead, let's go <code>NUTS</code></h3>
<p>
That's right, we're reaching for the <b>No U-Turn sampler (NUTS)</b><br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-" data-background-iframe="file:///home/tor/Projects/public/mcmc-demo/app.html?closeControls=true&amp;algorithm=HamiltonianMH&amp;target=standard&amp;seed=1&amp;autoplay=true&amp;histBins=100" data-background-interactive>
<div style="">
<h4 id="2023-01-29-16-57-28-"></h4>
<p class="fragment (appear)">
<a href="https://chi-feng.github.io/mcmc-demo/app.html" class="fragment (appear)">https://chi-feng.github.io/mcmc-demo/app.html</a><br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-">
<h3 id="2023-01-29-16-57-28-"></h3>
<blockquote >
<p>
Wooaah there! <code>NUTS</code> requires gradient information!<br />
</p>

<p>
How are you going to get that through that <code>solve</code>?<br />
</p>
</blockquote>

<p>
Good question, voice in my head<br />
</p>

<p class="fragment (appear)">
I'm obviously not going to it myself<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Automatic-differentiation--AD--in-Julia">
<h3 id="2023-01-29-16-57-28-Automatic-differentiation--AD--in-Julia">Automatic differentiation (AD) in Julia</h3>
<ul>
<li><a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a>: forward-mode AD <i>(default in Turing.jl)</i><br /></li>
<li><a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a>: tape-based reverse-mode AD<br /></li>
<li><a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a>: source-to-source reverse-mode AD<br /></li>
<li>And more&#x2026;<br /></li>

</ul>

<div class="fragment (appear)">

<p>
Up-and-coming<br />
</p>

<ul>
<li><a href="https://github.com/EnzymeAD/Enzyme.jl">Enzyme.jl</a>: Julia bindings for <a href="https://github.com/EnzymeAD/Enzyme.jl">Enzyme</a> which ADs LLVM (low-level)<br /></li>
<li><a href="https://github.com/JuliaDiff/Diffractor.jl">Diffractor.jl</a>: experimental mixed-mode AD meant to replace Zygote.jl<br /></li>

</ul>

</div>

<div class="fragment (appear)">

<p>
Of importance<br />
</p>
<ul>
<li><a href="https://github.com/JuliaDiff/ChainRulesCore.jl">ChainRulesCore.jl</a>: light-weight package for defining rules, compatible with many of the above<br /></li>

</ul>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Automatic-differentiation--AD--in-Julia-split">

<p>
<b>Important</b><br />
</p>

<blockquote >
<p>
When you write code, you don't have to make a choice which one you want to use!<br />
</p>
</blockquote>

<p>
All the (stable) ones, will (mostly) work<br />
</p>

<p>
<i>But</i> how you write code will affect performance characteristics<br />
</p>

<p>
Takes a bit of know-how + a bit of digging to go properly "vroom!"<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Differentiating-through-solve">
<h3 id="2023-01-29-16-57-28-Differentiating-through-solve">Differentiating through <code>solve</code></h3>
<p>
With that being said, differentiating through numerical <code>solve</code> is not necessarily trivial to do efficiently<br />
</p>

<p>
There are numerous ways of approaching this problem<br />
</p>


<div id="orgbadd9af" class="figure">
<p><img src="assets/attachments/2023-01-22_12-30-07_Screenshot_20230122_122936.png" alt="2023-01-22_12-30-07_Screenshot_20230122_122936.png" width="400px" /><br />
</p>
</div>

<p>
<a href="https://arxiv.org/abs/1812.01892">https://arxiv.org/abs/1812.01892</a> is <i>great</i> resource<br />
</p>

<div class="fragment (appear)">

<p>
But this is why we have <a href="https://github.com/SciML/SciMLSensitivity.jl"><code>SciMLSensitivity.jl</code></a><br />
</p>

<p>
<a href="https://docs.sciml.ai/SciMLSensitivity/stable/manual/differential_equation_sensitivities/#Choosing-a-Sensitivity-Algorithm">SciMLSensitivity.jl docs</a> also provides a great overview of different approaches<br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Differentiating-through-solve-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> SciMLSensitivity
</code></pre>
</div>

<p>
It offers<br />
</p>

<ol>
<li><i>Discrete sensitivity analysis</i> or the <i>"Direct" method</i>: just use<br />
<code>ForwardDiff.Dual</code> in the <code>solve</code>.<br /></li>
<li><i>Continuous local sensitivity analysis (CSA)</i>: extends the original<br />
system such that the <code>solve</code> gives you both the solution and the the<br />
gradient simultaenously.<br /></li>
<li><i>Adjoint methods</i>: construct a backwards system whose solution gives<br />
us the gradient.<br /></li>

</ol>

<p>
Just do <code>solve(problem, solver, sensealg = ...)</code><br />
</p>

</section>
<section id="slide-back-to-being-nuts">
<h3 id="back-to-being-nuts">Back to being <code>NUTS</code></h3>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain = sample(model_conditioned, NUTS(0.8), MCMCThreads(), 1000, 4);
</code></pre>
</div>

<pre class="example" id="org4c9f12c">
┌ Info: Found initial step size
└   ϵ = 0.025
┌ Info: Found initial step size
└   ϵ = 0.0125
┌ Info: Found initial step size
└   ϵ = 0.05
┌ Info: Found initial step size
└   ϵ = 0.8
┌ Warning: Instability detected. Aborting
└ @ SciMLBase ~/.julia/packages/SciMLBase/szsYq/src/integrator_interface.jl:606
</pre>

</section>
<section id="slide-back-to-being-nuts-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain
</code></pre>
</div>

<pre class="example" id="orgc93c55d">
Chains MCMC chain (1000×15×4 Array{Float64, 3}):

Iterations        = 501:1:1500
Number of chains  = 4
Samples per chain = 1000
Wall duration     = 27.18 seconds
Compute duration  = 108.0 seconds
parameters        = β, γ, ϕ⁻¹
internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size

Summary Statistics
  parameters      mean       std      mcse    ess_bulk    ess_tail      rhat   ⋯
      Symbol   Float64   Float64   Float64     Float64     Float64   Float64   ⋯

           β    1.7305    0.0542    0.0010   2794.5077   2357.1357    1.0008   ⋯
           γ    0.5297    0.0439    0.0009   2349.9049   2086.4939    1.0010   ⋯
         ϕ⁻¹    0.1379    0.0749    0.0016   1948.2556   1937.4531    0.9999   ⋯
                                                                1 column omitted

Quantiles
  parameters      2.5%     25.0%     50.0%     75.0%     97.5% 
      Symbol   Float64   Float64   Float64   Float64   Float64 

           β    1.6305    1.6948    1.7282    1.7644    1.8434
           γ    0.4407    0.5026    0.5288    0.5570    0.6182
         ϕ⁻¹    0.0447    0.0862    0.1212    0.1709    0.3336
</pre>

<p>
Muuuch better! Both ESS and Rhat is looking good<br />
</p>

</section>
<section id="slide-back-to-being-nuts-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot(chain; size=(800, 500))
</code></pre>
</div>


<div id="orge3c9274" class="figure">
<p><img src="assets/outputs/more-julia/ba6a57881c744560992e6aeb0ff47cfb9aaf9238.svg" alt="ba6a57881c744560992e6aeb0ff47cfb9aaf9238.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-back-to-being-nuts-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Predict using the results from NUTS.</span>
predictions = predict(model, chain)
</code></pre>
</div>

<pre class="example" id="orge678d76">
Chains MCMC chain (1000×14×4 Array{Float64, 3}):

Iterations        = 1:1:1000
Number of chains  = 4
Samples per chain = 1000
parameters        = in_bed[1], in_bed[2], in_bed[3], in_bed[4], in_bed[5], in_bed[6], in_bed[7], in_bed[8], in_bed[9], in_bed[10], in_bed[11], in_bed[12], in_bed[13], in_bed[14]
internals         = 

Summary Statistics
  parameters       mean        std      mcse    ess_bulk    ess_tail      rhat ⋯
      Symbol    Float64    Float64   Float64     Float64     Float64   Float64 ⋯

   in_bed[1]     3.3200     2.2872    0.0367   3869.0113   3757.5599    1.0004 ⋯
   in_bed[2]    10.8800     5.4558    0.0884   3760.4499   3840.4952    1.0010 ⋯
   in_bed[3]    34.3910    16.2547    0.2673   3950.1408   3297.1476    0.9999 ⋯
   in_bed[4]    92.7687    44.5892    0.7711   3360.5024   3226.8261    1.0002 ⋯
   in_bed[5]   185.6832    79.4009    1.3986   3298.6495   3442.5850    1.0013 ⋯
   in_bed[6]   247.6912   100.4472    1.6388   3716.0238   3738.6149    1.0002 ⋯
   in_bed[7]   235.3295    91.1449    1.5092   3657.6049   3748.3664    1.0010 ⋯
   in_bed[8]   182.7982    70.6465    1.1247   3939.1717   3967.9279    1.0002 ⋯
   in_bed[9]   131.7473    52.3558    0.8474   3857.4942   3845.1358    1.0004 ⋯
  in_bed[10]    89.3732    36.8920    0.6141   3756.4616   3366.1403    1.0016 ⋯
  in_bed[11]    59.0973    25.0144    0.4067   3855.0060   3928.0521    0.9997 ⋯
  in_bed[12]    38.8780    16.8736    0.2787   3674.5558   3612.8610    1.0000 ⋯
  in_bed[13]    25.1333    11.9396    0.1968   3686.2674   3575.0453    1.0015 ⋯
  in_bed[14]    16.1432     8.0709    0.1342   3629.5783   3442.4297    0.9997 ⋯
                                                                1 column omitted

Quantiles
  parameters      2.5%      25.0%      50.0%      75.0%      97.5% 
      Symbol   Float64    Float64    Float64    Float64    Float64 

   in_bed[1]    0.0000     2.0000     3.0000     5.0000     9.0000
   in_bed[2]    3.0000     7.0000    10.0000    14.0000    24.0000
   in_bed[3]   10.0000    23.0000    32.0000    43.0000    73.0000
   in_bed[4]   30.9750    63.0000    85.0000   112.0000   201.0000
   in_bed[5]   67.0000   131.0000   174.0000   225.0000   374.0000
   in_bed[6]   90.0000   179.0000   235.0000   299.0000   477.0000
   in_bed[7]   88.0000   174.0000   226.0000   282.0000   441.0000
   in_bed[8]   68.9750   135.0000   175.0000   221.0000   341.0250
   in_bed[9]   52.0000    96.0000   125.0000   159.0000   255.0000
  in_bed[10]   31.0000    65.0000    84.0000   109.0000   175.0000
  in_bed[11]   21.0000    42.0000    56.0000    72.0000   119.0250
  in_bed[12]   13.0000    27.0000    37.0000    48.0000    81.0000
  in_bed[13]    7.0000    17.0000    23.0000    31.0000    52.0000
  in_bed[14]    4.0000    10.0000    15.0000    21.0000    35.0000
</pre>

</section>
<section id="slide-back-to-being-nuts-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot_trajectories!(plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300)), predictions; n = 1000, data=data)
</code></pre>
</div>


<div id="orgd487e51" class="figure">
<p><img src="assets/outputs/more-julia/870b8fafd890396444043fd96c7d303fb7722627.svg" alt="870b8fafd890396444043fd96c7d303fb7722627.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-back-to-being-nuts-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>plot_trajectory_quantiles!(plot(legend=<span style="color: #D0372D;">false</span>, size=(600, 300)), predictions; data=data)
</code></pre>
</div>


<div id="org42fac8f" class="figure">
<p><img src="assets/outputs/more-julia/145ba1245ad3196f9bb3001254df5b3cf451e778.svg" alt="145ba1245ad3196f9bb3001254df5b3cf451e778.svg" class="org-svg" /><br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Simulation-based-calibration--SBC--https-arxiv-dot-org-abs-1804-dot-06788-Talts-et-dot-al-dot--2018">
<h3 id="2023-01-29-16-57-28-Simulation-based-calibration--SBC--https-arxiv-dot-org-abs-1804-dot-06788-Talts-et-dot-al-dot--2018">Simulation-based calibration (SBC) <a href="https://arxiv.org/abs/1804.06788">Talts et. al. (2018)</a></h3>
<ol>
<li>Sample from prior \(\theta_1, \dots, \theta_n \sim p(\theta)\).<br /></li>
<li>Sample datasets \(\mathcal{D}_i \sim p(\cdot \mid \theta_i)\) for \(i = 1, \dots, n\).<br /></li>
<li>Obtain (approximate) \(p(\theta \mid \mathcal{D}_i)\) for \(i = 1, \dots, n\).<br /></li>

</ol>

<p>
For large enough (n), the "combination" of the posteriors should recover the prior!<br />
</p>

<p>
"Combination" here usually means computing some statistic and comparing against what it should be<br />
</p>


<div id="org6bc62e2" class="figure">
<p><img src="assets/attachments/2023-01-22_12-09-24_Screenshot_20230122_120848.png" alt="2023-01-22_12-09-24_Screenshot_20230122_120848.png" width="800px" /><br />
<p><img src=".more-julia/attachments/2023-01-22_12-09-24_Screenshot_20230122_120848.png" alt="2023-01-22_12-09-24_Screenshot_20230122_120848.png" width="800px" /><br />
</p>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Simulation-based-calibration--SBC--https-arxiv-dot-org-abs-1804-dot-06788-Talts-et-dot-al-dot--2018-split">

<p>
That's very expensive → in practice we just do this once or twice<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Sample from the conditioned model so we don't get the `in_bed` variables too</span>
<span style="color: #0000FF;">using</span> Random  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Just making sure the numbers of somewhat interesting</span>
rng = MersenneTwister(43);
test_values = rand(rng, NamedTuple, model_conditioned)
</code></pre>
</div>

<pre class="example">
(β = 1.2254566808077714, γ = 0.27594266205681933, ϕ⁻¹ = 0.13984179162984164)
</pre>


<p>
Now we condition on those values and run once to generate data<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model_test = model | test_values
</code></pre>
</div>

<pre class="example">
Model(
  args = (:problem_wrapper, :prior)
  defaults = ()
  context = ConditionContext((β = 1.2254566808077714, γ = 0.27594266205681933, ϕ⁻¹ = 0.13984179162984164), DynamicPPL.DefaultContext())
)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>in_best_test = rand(rng, model_test).in_bed;
</code></pre>
</div>

</section>
<section id="slide-2023-01-29-16-57-28-Simulation-based-calibration--SBC--https-arxiv-dot-org-abs-1804-dot-06788-Talts-et-dot-al-dot--2018-split">

<p>
Next, inference!<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model_test_conditioned = model | (in_bed = in_best_test,)
</code></pre>
</div>

<pre class="example">
Model(
  args = (:problem_wrapper, :prior)
  defaults = ()
  context = ConditionContext((in_bed = [1, 9, 11, 45, 159, 136, 270, 123, 463, 376, 231, 148, 99, 162],), DynamicPPL.DefaultContext())
)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Let's just do a single chain here.</span>
chain_test = sample(model_test_conditioned, NUTS(0.8), 1000);
</code></pre>
</div>

<pre class="example">
┌ Info: Found initial step size
└   ϵ = 0.025
Sampling: 100%|█████████████████████████████████████████| Time: 0:00:00

</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Simulation-based-calibration--SBC--https-arxiv-dot-org-abs-1804-dot-06788-Talts-et-dot-al-dot--2018-split">

<p>
Did we recover the parameters?<br />
</p>

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>ps = []
<span style="color: #0000FF;">for</span> sym <span style="color: #0000FF;">in</span> [<span style="color: #D0372D;">:&#946;</span>, <span style="color: #D0372D;">:&#947;</span>, <span style="color: #D0372D;">:&#981;&#8315;&#185;</span>]
    p = density(chain_test[:, [sym], :])
    vline!([test_values[sym]])
    push!(ps, p)
<span style="color: #0000FF;">end</span>
plot(ps..., layout=(3, 1), size=(600, 400))
</code></pre>
</div>


<div id="orga02e600" class="figure">
<p><img src="assets/outputs/more-julia/be1c12fbb76e6f039cc149b75842d8ee461b8f89.svg" alt="be1c12fbb76e6f039cc149b75842d8ee461b8f89.svg" class="org-svg" /><br />
</p>
</div>

</div>

<p>
Yay!<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Samplers-in-Turing-dot-jl">
<h3 id="2023-01-29-16-57-28-Samplers-in-Turing-dot-jl">Samplers in Turing.jl</h3>
<ul>
<li>Metropolis-Hastings, MALA, emcee (<a href="https://github.com/TuringLang/AdvancedMH.jl">AdvancedMH.jl</a>)<br /></li>
<li>Hamiltonian Monte Carlo, NUTS (<a href="https://github.com/TuringLang/AdvancedMH.jl">AdvancedHMC.jl</a>)<br /></li>
<li>SMC (<a href="https://github.com/TuringLang/AdvancedPS.jl">AdvancedPS.jl</a>)<br /></li>
<li>Elliptical Slice Sampling (<a href="https://github.com/TuringLang/EllipticalSliceSampling.jl">EllipticalSliceSampling.jl</a>)<br /></li>
<li>Nested sampling (<a href="https://github.com/TuringLang/NestedSamplers.jl">NestedSamplers.jl</a>)<br /></li>
<li>(Experimental) Tempered sampling (<a href="https://github.com/Julia-Tempering/Pigeons.jl">Pigeons.jl</a> and <a href="https://github.com/TuringLang/MCMCTempering.jl">MCMCTempering.jl</a>)<br /></li>

</ul>

</section>
<section id="slide-2023-01-29-16-57-28-Samplers-in-Turing-dot-jl-split">

<p>
You can also combine some of these in Turing.jl<br />
</p>

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> LinearAlgebra: I

<span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> linear_regression(X)
    num_params = size(X, 1)
    &#946; ~ MvNormal(ones(num_params))
    &#963;&#178; ~ InverseGamma(2, 3)
    y ~ MvNormal(vec(&#946;' * X), &#963;&#178; * I)
<span style="color: #0000FF;">end</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Generate some dummy data.</span>
X = randn(2, 1_000); lin_reg = linear_regression(X); true_vals = rand(lin_reg)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Condition.</span>
lin_reg_conditioned = lin_reg | (y = true_vals.y,);
</code></pre>
</div>

<p>
We can then do <code>Gibbs</code> but sampling \(β\) using <code>ESS</code> and \(\sigma^2\) using <code>HMC</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain_ess_hmc = sample(lin_reg_conditioned, Gibbs(ESS(<span style="color: #D0372D;">:&#946;</span>), HMC(1e-3, 16, <span style="color: #D0372D;">:&#963;&#178;</span>)), 1_000);
</code></pre>
</div>

<pre class="example">
Sampling: 100%|█████████████████████████████████████████| Time: 0:00:00

</pre>


</div>

</section>
<section id="slide-2023-01-29-16-57-28-Samplers-in-Turing-dot-jl-split">

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chain_ess_hmc
</code></pre>
</div>

<pre class="example" id="orgb6b730d">
Chains MCMC chain (1000×4×1 Array{Float64, 3}):

Iterations        = 1:1:1000
Number of chains  = 1
Samples per chain = 1000
Wall duration     = 13.28 seconds
Compute duration  = 13.28 seconds
parameters        = β[1], β[2], σ²
internals         = lp

Summary Statistics
  parameters      mean       std      mcse   ess_bulk   ess_tail      rhat   e ⋯
      Symbol   Float64   Float64   Float64    Float64    Float64   Float64     ⋯

        β[1]    0.2368    0.0377    0.0021   303.6277   312.7163    1.0020     ⋯
        β[2]   -0.4866    0.0367    0.0017   368.4395   359.5562    0.9992     ⋯
          σ²    0.9832    0.0579    0.0168    12.1798    77.1990    1.1376     ⋯
                                                                1 column omitted

Quantiles
  parameters      2.5%     25.0%     50.0%     75.0%     97.5% 
      Symbol   Float64   Float64   Float64   Float64   Float64 

        β[1]    0.1636    0.2152    0.2359    0.2575    0.2987
        β[2]   -0.5474   -0.5090   -0.4879   -0.4627   -0.4245
          σ²    0.8816    0.9409    0.9804    1.0215    1.0941
</pre>

<p>
Could potentially lead to improvements<br />
</p>

<p>
<b>NOTE:</b> Usually <i>very</i> difficult to choose sampler parameters in this case<br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Samplers-in-Turing-dot-jl-split">

<p>
Means one can also mix discrete and continuous<br />
</p>

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@model</span> <span style="color: #0000FF;">function</span> mixture(n)
    cluster ~ filldist(Categorical([0.25, 0.75]), n)
    &#956; ~ MvNormal([-10.0, 10.0], I)
    x ~ product_distribution(Normal.(&#956;[cluster], 1))
<span style="color: #0000FF;">end</span>

model_mixture = mixture(10)
fake_values_mixture = rand(model_mixture)
model_mixture_conditioned = model_mixture | (x = fake_values_mixture.x, )
chain_discrete = sample(
    model_mixture_conditioned, Gibbs(PG(10, <span style="color: #D0372D;">:cluster</span>), HMC(1e-3, 16, <span style="color: #D0372D;">:&#956;</span>)), MCMCThreads(), 1_000, 4
)
</code></pre>
</div>

<pre class="example" id="org98fb360">
Chains MCMC chain (1000×13×4 Array{Float64, 3}):

Iterations        = 1:1:1000
Number of chains  = 4
Samples per chain = 1000
Wall duration     = 36.46 seconds
Compute duration  = 144.91 seconds
parameters        = cluster[1], cluster[2], cluster[3], cluster[4], cluster[5], cluster[6], cluster[7], cluster[8], cluster[9], cluster[10], μ[1], μ[2]
internals         = lp

Summary Statistics
   parameters      mean       std      mcse    ess_bulk   ess_tail      rhat   ⋯
       Symbol   Float64   Float64   Float64     Float64    Float64   Float64   ⋯

   cluster[1]    2.0000    0.0000       NaN         NaN        NaN       NaN   ⋯
   cluster[2]    1.0163    0.1265    0.0137     85.5708    85.5708    1.0281   ⋯
   cluster[3]    1.0285    0.1664    0.0222     56.1096    56.1096    1.0695   ⋯
   cluster[4]    1.0085    0.0918    0.0076    147.7564   147.7564    1.0148   ⋯
   cluster[5]    2.0000    0.0000       NaN         NaN        NaN       NaN   ⋯
   cluster[6]    2.0000    0.0000       NaN         NaN        NaN       NaN   ⋯
   cluster[7]    1.9990    0.0316    0.0007   2002.5842        NaN    1.0007   ⋯
   cluster[8]    2.0000    0.0000       NaN         NaN        NaN       NaN   ⋯
   cluster[9]    2.0000    0.0000       NaN         NaN        NaN       NaN   ⋯
  cluster[10]    1.9937    0.0788    0.0056    197.6402        NaN    1.0250   ⋯
         μ[1]   -9.3065    0.3103    0.1036     10.0162    38.6601    2.0981   ⋯
         μ[2]    9.7775    0.8181    0.2839      8.5007    14.8574    3.7783   ⋯
                                                                1 column omitted

Quantiles
   parameters      2.5%     25.0%     50.0%     75.0%     97.5% 
       Symbol   Float64   Float64   Float64   Float64   Float64 

   cluster[1]    2.0000    2.0000    2.0000    2.0000    2.0000
   cluster[2]    1.0000    1.0000    1.0000    1.0000    1.0000
   cluster[3]    1.0000    1.0000    1.0000    1.0000    2.0000
   cluster[4]    1.0000    1.0000    1.0000    1.0000    1.0000
   cluster[5]    2.0000    2.0000    2.0000    2.0000    2.0000
   cluster[6]    2.0000    2.0000    2.0000    2.0000    2.0000
   cluster[7]    2.0000    2.0000    2.0000    2.0000    2.0000
   cluster[8]    2.0000    2.0000    2.0000    2.0000    2.0000
   cluster[9]    2.0000    2.0000    2.0000    2.0000    2.0000
  cluster[10]    2.0000    2.0000    2.0000    2.0000    2.0000
         μ[1]   -9.9258   -9.5774   -9.2221   -9.0471   -8.8829
         μ[2]    7.9865    9.2653    9.7118   10.4310   11.0571
</pre>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Samplers-in-Turing-dot-jl-split">

<div class="x-small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>ps = []
<span style="color: #0000FF;">for</span> (i, realizations) <span style="color: #0000FF;">in</span> enumerate(eachcol(Array(group(chain_discrete, <span style="color: #D0372D;">:cluster</span>))))
    p = density(
        realizations,
        legend=<span style="color: #D0372D;">false</span>,
        ticks=<span style="color: #D0372D;">false</span>,
        border=<span style="color: #D0372D;">:none</span>
    )
    vline!(p, [fake_values_mixture.cluster[i]])
    push!(ps, p)
<span style="color: #0000FF;">end</span>
plot(ps..., layout=(length(ps) &#247; 2, 2), size=(600, 40 * length(ps)))
</code></pre>
</div>


<div id="orga525e8d" class="figure">
<p><img src="assets/outputs/more-julia/d49b052ee893e7410f4c67e9ca34a5e5faee8850.svg" alt="d49b052ee893e7410f4c67e9ca34a5e5faee8850.svg" class="org-svg" /><br />
</p>
</div>

</div>

<p>
Again, this is difficult to get to work properly on non-trivial examples<br />
</p>

<p>
<span class="underline">But</span> it is possible<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Other-utilities-for-Turing-dot-jl">
<h3 id="2023-01-29-16-57-28-Other-utilities-for-Turing-dot-jl">Other utilities for Turing.jl</h3>
<ul>
<li><a href="https://github.com/TuringLang/TuringGLM.jl">TuringGLM.jl</a>: GLMs using the formula-syntax from R but using Turing.jl under the hood<br /></li>
<li><a href="https://github.com/TuringLang/TuringBenchmarking.jl">TuringBenchmarking.jl</a>: useful for benchmarking Turing.jl models<br /></li>
<li><a href="https://github.com/TuringLang/TuringCallbacks.jl">TuringCallbacks.jl</a>: on-the-fly visualizations using <code>tensorboard</code><br /></li>

</ul>

</section>
<section id="slide-orgc83a190">
<h4 id="orgc83a190">TuringGLM.jl</h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> TuringGLM
</code></pre>
</div>

</section>
<section id="slide-orgc83a190-split">

<p>
We'll use the KidIQ dataset for a quick example<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>register(DataDep(
    <span style="color: #008000;">"kidiq"</span>,
    <span style="color: #008000;">"Survey of adult American women and their respective children from 2007"</span>,
    <span style="color: #008000;">"https://raw.githubusercontent.com/TuringLang/TuringGLM.jl/bbc9129fc2d1ff7a1026fe2189b6580303d5c9f5/data/kidiq.csv"</span>,
))
</code></pre>
</div>

<pre class="example">
DataDep("kidiq", "https://raw.githubusercontent.com/TuringLang/TuringGLM.jl/bbc9129fc2d1ff7a1026fe2189b6580303d5c9f5/data/kidiq.csv", nothing, DataDeps.fetch_default, identity, "Survey of adult American women and their respective children from 2007")
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>fname = joinpath(datadep<span style="color: #008000;">"kidiq"</span>, <span style="color: #008000;">"kidiq.csv"</span>)
kidiq = DataFrame(CSV.File(fname))
</code></pre>
</div>

<pre class="example" id="orge199fba">
434×4 DataFrame
 Row │ kid_score  mom_hs  mom_iq    mom_age 
     │ Int64      Int64   Float64   Int64   
─────┼──────────────────────────────────────
   1 │        65       1  121.118        27
   2 │        98       1   89.3619       25
   3 │        85       1  115.443        27
   4 │        83       1   99.4496       25
   5 │       115       1   92.7457       27
   6 │        98       0  107.902        18
   7 │        69       1  138.893        20
   8 │       106       1  125.145        23
   9 │       102       1   81.6195       24
  10 │        95       1   95.0731       19
  11 │        91       1   88.577        23
  ⋮  │     ⋮        ⋮        ⋮         ⋮
 425 │        42       1   78.2446       27
 426 │       102       1  127.676        29
 427 │       104       1  124.515        23
 428 │        59       0   80.464        21
 429 │        93       0   74.8607       25
 430 │        94       0   84.8774       21
 431 │        76       1   92.9904       23
 432 │        50       0   94.8597       24
 433 │        88       1   96.8566       21
 434 │        70       1   91.2533       25
                            413 rows omitted
</pre>

</section>
<section id="slide-orgc83a190-split">

<p>
Now we can create the formula<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>fm = <span style="color: #808080;">@formula</span>(kid_score ~ mom_hs * mom_iq)
</code></pre>
</div>

<pre class="example">
FormulaTerm
Response:
  kid_score(unknown)
Predictors:
  mom_hs(unknown)
  mom_iq(unknown)
  mom_hs(unknown) &amp; mom_iq(unknown)
</pre>


<p>
which can then easily be converted into a Turing.jl-model<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model = turing_model(fm, kidiq);
</code></pre>
</div>

<p>
And then we can use our standard Turing.jl workflow:<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>chns = sample(model, NUTS(), 1000)
</code></pre>
</div>

<pre class="example">
┌ Info: Found initial step size
└   ϵ = 0.0015625
Sampling: 100%|█████████████████████████████████████████| Time: 0:00:02

</pre>

<pre class="example" id="org4d23704">
Chains MCMC chain (1000×17×1 Array{Float64, 3}):

Iterations        = 501:1:1500
Number of chains  = 1
Samples per chain = 1000
Wall duration     = 17.79 seconds
Compute duration  = 17.79 seconds
parameters        = α, β[1], β[2], β[3], σ
internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size

Summary Statistics
  parameters      mean       std      mcse   ess_bulk   ess_tail      rhat   e ⋯
      Symbol   Float64   Float64   Float64    Float64    Float64   Float64     ⋯

           α   31.3384    6.4780    0.3341   373.7576   549.8589    0.9991     ⋯
        β[1]    0.5098    2.3878    0.1392   506.3722   195.9589    1.0006     ⋯
        β[2]    0.5107    0.0714    0.0037   374.7500   463.9428    0.9991     ⋯
        β[3]    0.0498    0.0333    0.0018   415.5495   215.4668    1.0050     ⋯
           σ   18.2205    0.6039    0.0229   705.3081   654.7311    1.0041     ⋯
                                                                1 column omitted

Quantiles
  parameters      2.5%     25.0%     50.0%     75.0%     97.5% 
      Symbol   Float64   Float64   Float64   Float64   Float64 

           α   19.1674   27.0275   30.8933   36.0974   43.9800
        β[1]   -2.8269   -0.5578    0.2158    1.0697    7.1574
        β[2]    0.3667    0.4572    0.5153    0.5602    0.6489
        β[3]   -0.0235    0.0319    0.0522    0.0718    0.1083
           σ   17.1135   17.8058   18.1929   18.6014   19.4824
</pre>



</section>
<section id="slide-orga0f24ba">
<h4 id="orga0f24ba">TuringCallbacks.jl</h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> TuringCallbacks
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>model = simple_demo(1.5, 2.0);
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>logdir = mktempdir()
</code></pre>
</div>

<pre class="example">
"/tmp/jl_uVazSd"
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>callback = TensorBoardCallback(joinpath(logdir, <span style="color: #008000;">"logs"</span>); include_hyperparams=<span style="color: #D0372D;">true</span>)
chain = sample(model, NUTS(0.8), 1000; callback=callback);
</code></pre>
</div>

<pre class="example">
┌ Info: Found initial step size
└   ϵ = 0.40625
</pre>


</section>
<section id="slide-orga0f24ba-split">

<p>
If you have <code>tensorboard</code> installed, you can then run<br />
</p>

<div class="org-src-container">

<pre  class="src src-sh"   ><code trim>python3 -m tensorboard.main --logdir /tmp/jl_uVazSd
</code></pre>
</div>


<div id="orga4ef2fb" class="figure">
<p><img src="assets/attachments/2023-01-25_20-50-11_tensorboard_demo_histograms_screen.png" alt="2023-01-25_20-50-11_tensorboard_demo_histograms_screen.png" width="800px" /><br />
</p>
</div>

</section>
<section id="slide-orga0f24ba-split">

<p>
Can inspect hyperparameters, e.g. target acceptance rate for <code>NUTS</code><br />
</p>


<div id="orga3f8772" class="figure">
<p><img src=".more-julia/attachments/2023-09-19_21-36-15_Screenshot_20230919_213557.png" alt="2023-09-19_21-36-15_Screenshot_20230919_213557.png" /><br />
</p>
</div>


</section>
<section id="slide-2023-01-29-16-57-28-Downsides-of-using-Turing-dot-jl">
<h3 id="2023-01-29-16-57-28-Downsides-of-using-Turing-dot-jl">Downsides of using Turing.jl</h3>
<ul>
<li class="fragment appear">\({\color{red} \times}\) No depedency-extraction of the model<br />
<ul>
<li>⟹ can't do things like automatic marginalization<br /></li>
<li><i>But</i> it's not impossible; just a matter of development effort<br /></li>
<li>\({\color{green} \checkmark}\) And we have JuliaBUGS now!<br /></li>

</ul></li>
<li class="fragment appear">\({\color{red} \times}\) NUTS performance is at the mercy of AD in Julia<br /></li>
<li class="fragment appear">\({\color{green} \checkmark}\) You <span class="underline">can</span> put anything in a model<br /></li>
<li class="fragment appear">\({\color{red} \times}\) Whether you <span class="underline">should</span> put anything in a model is a another matter<br /></li>

</ul>


</section>
</section>
<section>
<section id="slide-orgbe4a3ed">
<h2 id="orgbe4a3ed">Setting up a project environment</h2>
<p>
Now we're going to do some live-coding!<br />
</p>

</section>
<section id="slide-org39b6430">
<h3 id="org39b6430">What we're doing</h3>
<ol>
<li>Create project.<br />
<ul>
<li>What does that mean?<br /></li>

</ul></li>
<li>Add dependencies.<br />
<ul>
<li>Project.toml and Manifest.toml<br /></li>
<li>Dependencies we need<br /></li>

</ul></li>
<li>Get our S(?)IR implementation into the project.<br /></li>
<li>Run some experiments.<br />
<ul>
<li>Use Pluto.jl notebook to get started<br /></li>
<li>Move into a script if we have time<br /></li>

</ul></li>

</ol>

</section>
</section>
<section>
<section id="slide-org42d5ad3">
<h2 id="org42d5ad3">Case study</h2>
<p>
It's time to do a case study!<br />
</p>

<p>
But on which dataset?<br />
</p>

<p>
<b>You're own!</b><br />
</p>

</section>
<section id="slide-org42d5ad3-split">

<p>
But if you don't have one, here are some alternatives:<br />
</p>
<ol>
<li>Lotka-Volterra model for snowhoe hares and Canadian lynxes<br />
<ul>
<li>A classic example of predator-prey dynamics<br /></li>

</ul></li>
<li>Cockroaches in residential buildings throughout New York<br />
<ul>
<li>Become your landlord's favorite tenant by minimizing cockroach complaints in residential buildings while keeping costs low<br /></li>

</ul></li>
<li>Synthetic time-series model<br />
<ul>
<li>A syncthetic time-series with periodic behavior<br /></li>

</ul></li>
<li>S(?)IR modeling of influenza<br />
<ul>
<li>You already have the data; go knock yourself out!<br /></li>

</ul></li>
<li>Pick one from RDatasets.jl<br /></li>

</ol>

<p>
Go to the next slides for more details<br />
</p>

</section>
<section id="slide-org401655e">
<h3 id="org401655e">1. Lotka-Volterra Predator-Prey model</h3>
<div class="small-text">

<div class="side-by-side">

<div>
<p>
The species of interest in this case study are:<br />
</p>
<ul>
<li>Snowshoe hares, an hervivorous cousin of rabbits<br /></li>
<li>Canadian lynxes, a feline predator whose diet consists largely of snowshoe hares<br /></li>

</ul>
</div>

<div>
<p>
Use Lotka-Volterra equations to model the population dynamics<br />
</p>
<div>
\begin{equation*}
\begin{aligned}
\frac{dH}{dt} &= \alpha H - \beta H L \\
\frac{dL}{dt} &= \delta H L - \gamma L
\end{aligned}
\end{equation*}

</div>

</div>

</div>

<p>
Use Turing.jl to infer the parameters<br />
</p>
<ul>
<li>\(\alpha\): growth rate of the prey population<br /></li>
<li>\(\beta\): rate of shrinkage of the prey population<br /></li>
<li>\(\delta\): rate of growth of the predator population<br /></li>
<li>\(\gamma\): rate of shrinkage of the predator population<br /></li>

</ul>

<p>
<a href="https://mc-stan.org/users/documentation/case-studies/lotka-volterra-predator-prey.html">Source (but don't look!)</a><br />
</p>

</div>

</section>
<section id="slide-org401655e-split">

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>register(DataDep(
    <span style="color: #008000;">"hares-and-lynxes"</span>,
    <span style="color: #008000;">"Numerical data for the number of pelts collected by the Hudson&#8217;s Bay Company in the years 1900-1920."</span>,
    <span style="color: #008000;">"https://raw.githubusercontent.com/stan-dev/example-models/master/knitr/lotka-volterra/hudson-bay-lynx-hare.csv"</span>,
))
</code></pre>
</div>


<p>
And then we can load it<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>df = DataFrame(
    CSV.File(
        joinpath(datadep<span style="color: #008000;">"hares-and-lynxes"</span>, <span style="color: #008000;">"hudson-bay-lynx-hare.csv"</span>),
        skipto=4,
        header=3
    )
)
</code></pre>
</div>

<pre class="example" id="org845a8b1">
21×3 DataFrame
 Row │ Year    Lynx     Hare   
     │ Int64  Float64  Float64 
─────┼─────────────────────────
   1 │  1900      4.0     30.0
   2 │  1901      6.1     47.2
   3 │  1902      9.8     70.2
   4 │  1903     35.2     77.4
   5 │  1904     59.4     36.3
   6 │  1905     41.7     20.6
   7 │  1906     19.0     18.1
   8 │  1907     13.0     21.4
   9 │  1908      8.3     22.0
  10 │  1909      9.1     25.4
  11 │  1910      7.4     27.1
  12 │  1911      8.0     40.3
  13 │  1912     12.3     57.0
  14 │  1913     19.5     76.6
  15 │  1914     45.7     52.3
  16 │  1915     51.1     19.5
  17 │  1916     29.7     11.2
  18 │  1917     15.8      7.6
  19 │  1918      9.7     14.6
  20 │  1919     10.1     16.2
  21 │  1920      8.6     24.7
</pre>

</div>

</section>
<section id="slide-org499a342">
<h3 id="org499a342">2. Cockroaches in New York</h3>
<div class="x-small-text">

<blockquote >
<p>
Imagine that you are a statistician or data scientist working as an independent contractor. One of your clients is a company that owns many residential buildings throughout New York City. The property manager explains that they are concerned about the number of cockroach complaints that they receive from their buildings. Previously the company has offered monthly visits from a pest inspector as a solution to this problem. While this is the default solution of many property managers in NYC, the tenants are rarely home when the inspector visits, and so the manager reasons that this is a relatively expensive solution that is currently not very effective.<br />
</p>

<p>
One alternative to this problem is to deploy long term bait stations. In this alternative, child and pet safe bait stations are installed throughout the apartment building. Cockroaches obtain quick acting poison from these stations and distribute it throughout the colony. The manufacturer of these bait stations provides some indication of the space-to-bait efficacy, but the manager suspects that this guidance was not calculated with NYC roaches in mind. NYC roaches, the manager rationalizes, have more hustle than traditional roaches; and NYC buildings are built differently than other common residential buildings in the US. This is particularly important as the unit cost for each bait station per year is quite high.<br />
</p>
</blockquote>

<p>
<a href="https://github.com/jgabry/stancon2018helsinki_intro">Source #1</a> and <a href="https://github.com/jgabry/stancon2018helsinki_intro">Source #2</a>  <span class="underline">(but don't look!)</span><br />
</p>

</div>

</section>
<section id="slide-org499a342-split">

<div class="x-small-text">

<p>
The manager wishes to employ your services to help them to find the optimal number of roach bait stations they should place in each of their buildings in order to minimize the number of cockroach complaints while also keeping expenditure on pest control affordable.<br />
</p>

<p>
A subset of the company's buildings have been randomly selected for an experiment:<br />
</p>
<ul>
<li>At the beginning of each month, a pest inspector randomly places a number of bait stations throughout the building, without knowledge of the current cockroach levels in the building<br /></li>
<li>At the end of the month, the manager records the total number of cockroach complaints in that building.<br /></li>
<li>The manager would like to determine the optimal number of traps (<code>traps</code>) that balances the lost revenue (<code>R</code>) such that complaints (<code>complaints</code>) generate with the all-in cost of maintaining the traps (<code>TC</code>).<br /></li>

</ul>

<p>
Formally, we are interested in finding<br />
</p>
<div>
\begin{equation*}
\arg \max_{\mathrm{traps} \in \mathbb{N}} \mathbb{E}_{\mathrm{complaints}} \big[ R \big( \mathrm{complaints}(\mathrm{traps}) \big) - \mathrm{TC}(\mathrm{traps}) \big]
\end{equation*}

</div>

<p>
The property manager would also, if possible, like to learn how these results generalize to buildings they haven't treated so they can understand the potential costs of pest control at buildings they are acquiring as well as for the rest of their building portfolio.<br />
</p>

<p>
As the property manager has complete control over the number of traps set, the random variable contributing to this expectation is the number of complaints given the number of traps. We will model the number of complaints as a function of the number of traps.<br />
</p>

</div>

</section>
<section id="slide-org499a342-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(CSV.File(joinpath(<span style="color: #008000;">"data"</span>, <span style="color: #008000;">"pest_data.csv"</span>)))
</code></pre>
</div>

<pre class="example" id="org4d678e2">
120×14 DataFrame
 Row │ mus        building_id  wk_ind  date        traps    floors   sq_footag ⋯
     │ Float64    Int64        Int64   Date        Float64  Float64  Float64   ⋯
─────┼──────────────────────────────────────────────────────────────────────────
   1 │ 0.369134            37       1  2017-01-15      8.0      8.0            ⋯
   2 │ 0.359355            37       2  2017-02-14      8.0      8.0
   3 │ 0.281783            37       3  2017-03-16      9.0      8.0
   4 │ 0.129254            37       4  2017-04-15     10.0      8.0
   5 │ 0.452041            37       5  2017-05-15     11.0      8.0            ⋯
   6 │ 0.44213             37       6  2017-06-14     11.0      8.0
   7 │ 0.990865            37       7  2017-07-14     10.0      8.0
   8 │ 0.785977            37       8  2017-08-13     10.0      8.0
   9 │ 0.691797            37       9  2017-09-12      9.0      8.0            ⋯
  10 │ 0.480696            37      10  2017-10-12      9.0      8.0
  11 │ 0.562431            37      11  2017-11-11      8.0      8.0
  ⋮  │     ⋮           ⋮         ⋮         ⋮          ⋮        ⋮             ⋮ ⋱
 111 │ 0.542095            98       3  2017-03-16      7.0     13.0
 112 │ 0.866334            98       4  2017-04-15      6.0     13.0            ⋯
 113 │ 1.40571             98       5  2017-05-15      6.0     13.0
 114 │ 1.65598             98       6  2017-06-14      5.0     13.0
 115 │ 2.2483              98       7  2017-07-14      4.0     13.0
 116 │ 2.30359             98       8  2017-08-13      3.0     13.0            ⋯
 117 │ 2.253               98       9  2017-09-12      2.0     13.0
 118 │ 2.0419              98      10  2017-10-12      2.0     13.0
 119 │ 1.90705             98      11  2017-11-11      2.0     13.0
 120 │ 2.10317             98      12  2017-12-11      1.0     13.0            ⋯
                                                   8 columns and 99 rows omitted
</pre>

</section>
<section id="slide-org1c2a1da">
<h3 id="org1c2a1da">3. Synthetic time-series</h3>
<p>
Or you can have a go at this synthetic time-series example<br />
</p>

<div class="side-by-side small-text">

<div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(CSV.File(
    joinpath(<span style="color: #008000;">"data"</span>, <span style="color: #008000;">"time-series.csv"</span>)
))
</code></pre>
</div>

<pre class="example" id="org483e282">
67×2 DataFrame
 Row │ t          y         
     │ Float64    Float64   
─────┼──────────────────────
   1 │ 0.0        -19.3009
   2 │ 0.0151515  -18.2195
   3 │ 0.030303   -17.931
   4 │ 0.0454545  -18.5562
   5 │ 0.0606061  -19.2006
   6 │ 0.0757576  -18.7376
   7 │ 0.0909091  -16.4586
   8 │ 0.106061   -15.0723
   9 │ 0.121212   -12.6583
  10 │ 0.136364   -11.1347
  11 │ 0.151515   -10.9626
  ⋮  │     ⋮          ⋮
  58 │ 0.863636    -6.70737
  59 │ 0.878788    -6.59501
  60 │ 0.893939    -7.91087
  61 │ 0.909091    -8.78053
  62 │ 0.924242    -9.81755
  63 │ 0.939394    -9.06206
  64 │ 0.954545    -7.48517
  65 │ 0.969697    -4.72118
  66 │ 0.984848    -1.85908
  67 │ 1.0          0.0
             46 rows omitted
</pre>

</div>

<div class="center">


<div id="org9718204" class="figure">
<p><img src="./assets/attachments/synthetic-timeseries-data.png" alt="synthetic-timeseries-data.png" /><br />
</p>
</div>

</div>

</div>

</section>
<section id="slide-orgb742813">
<h3 id="orgb742813">4. Influenza at British boarding school (same as before)</h3>
<p>
An outbreak of influenza A (H1N1) in 1978 at a British boarding school<br />
</p>

<ul>
<li>763 male students -&gt; 512 of which became ill<br /></li>
<li>Reported that one infected boy started the epidemic<br /></li>
<li>Observations are number of boys in bed over 14 days<br /></li>

</ul>

<p>
Data are freely available in the R package <code>outbreaks</code>, maintained as part of the <a href="http://www.repidemicsconsortium.org/">R Epidemics Consortium</a><br />
</p>

</section>
<section id="slide-orgb742813-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim>DataFrame(CSV.File(joinpath(<span style="color: #008000;">"data"</span>, <span style="color: #008000;">"influenza_england_1978_school.csv"</span>)))
</code></pre>
</div>

<pre class="example" id="org073d5d1">
14×4 DataFrame
 Row │ Column1  date        in_bed  convalescent 
     │ Int64    Date        Int64   Int64        
─────┼───────────────────────────────────────────
   1 │       1  1978-01-22       3             0
   2 │       2  1978-01-23       8             0
   3 │       3  1978-01-24      26             0
   4 │       4  1978-01-25      76             0
   5 │       5  1978-01-26     225             9
   6 │       6  1978-01-27     298            17
   7 │       7  1978-01-28     258           105
   8 │       8  1978-01-29     233           162
   9 │       9  1978-01-30     189           176
  10 │      10  1978-01-31     128           166
  11 │      11  1978-02-01      68           150
  12 │      12  1978-02-02      29            85
  13 │      13  1978-02-03      14            47
  14 │      14  1978-02-04       4            20
</pre>

</section>
<section id="slide-orgae533f7">
<h3 id="orgae533f7">5. Anything from <code>RDatasets.jl</code></h3>
<p>
Or you can just do <code>]add RDatasets</code> and knock yourself out<br />
</p>

<p>
<a href="https://github.com/JuliaStats/RDatasets.jl">https://github.com/JuliaStats/RDatasets.jl</a><br />
</p>

</section>
</section>
<section>
<section id="slide-2023-01-29-16-57-28-Julia-The-Good-the-Bad-and-the-Ugly">
<h2 id="2023-01-29-16-57-28-Julia-The-Good-the-Bad-and-the-Ugly">Julia: The Good, the Bad, and the Ugly</h2>
<p>
An honest take from a little 27-year old Norwegian boy<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-The-Good">
<h4 id="2023-01-29-16-57-28-The-Good">The Good</h4>
<ul>
<li>Speed<br /></li>
<li>Composability (thank you multiple dispatch)<br /></li>
<li>No need to tie yourself to an underlying computational framework<br /></li>
<li>Interactive<br /></li>
<li>Transparency<br /></li>
<li>Very easy to call into other languages<br /></li>

</ul>

</section>
<section id="slide-2023-01-29-16-57-28-Speed">
<h4 id="2023-01-29-16-57-28-Speed">Speed</h4>
<p>
I think you got this already&#x2026;<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Composability">
<h4 id="2023-01-29-16-57-28-Composability">Composability</h4>
<p>
We've seen some of that<br />
</p>

<p>
Defining <code>infected(problem_wrapper, u)</code> allowed us to abstract away how to extract the compartment of interest<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Transparency">
<h4 id="2023-01-29-16-57-28-Transparency">Transparency</h4>
<p>
For starters, almost all the code you'll end up using is pure Julia<br />
</p>

<p>
Hence, you can always look at the code<br />
</p>

<p>
You can find the implementation by using <code>@which</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Without arguments</span>
<span style="color: #808080;">@which</span> sum
</code></pre>
</div>

<pre class="example">
Base
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">With arguments</span>
<span style="color: #808080;">@which</span> sum([1.0])
</code></pre>
</div>

<pre class="example">
sum(a::AbstractArray; dims, kw...)
     @ Base reducedim.jl:994
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Transparency-split">

<p>
And yeah, you can even look into the macros<br />
</p>

<div class="small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@macroexpand</span> <span style="color: #808080;">@model</span> f() = x ~ Normal()
</code></pre>
</div>

<pre class="example" id="orge4a2853">
quote
    function f(__model__::DynamicPPL.Model, __varinfo__::DynamicPPL.AbstractVarInfo, __context__::AbstractPPL.AbstractContext; )
        #= In[245]:1 =#
        begin
            var"##dist#7280" = Normal()
            var"##vn#7277" = (DynamicPPL.resolve_varnames)((AbstractPPL.VarName){:x}(), var"##dist#7280")
            var"##isassumption#7278" = begin
                    if (DynamicPPL.contextual_isassumption)(__context__, var"##vn#7277")
                        if !((DynamicPPL.inargnames)(var"##vn#7277", __model__)) || (DynamicPPL.inmissings)(var"##vn#7277", __model__)
                            true
                        else
                            x === missing
                        end
                    else
                        false
                    end
                end
            begin
                #= /home/tor/.julia/packages/DynamicPPL/m0PXI/src/compiler.jl:555 =#
                var"##retval#7282" = if (DynamicPPL.contextual_isfixed)(__context__, var"##vn#7277")
                        x = (DynamicPPL.getfixed_nested)(__context__, var"##vn#7277")
                    elseif var"##isassumption#7278"
                        begin
                            (var"##value#7281", __varinfo__) = (DynamicPPL.tilde_assume!!)(__context__, (DynamicPPL.unwrap_right_vn)((DynamicPPL.check_tilde_rhs)(var"##dist#7280"), var"##vn#7277")..., __varinfo__)
                            x = var"##value#7281"
                            var"##value#7281"
                        end
                    else
                        if !((DynamicPPL.inargnames)(var"##vn#7277", __model__))
                            x = (DynamicPPL.getconditioned_nested)(__context__, var"##vn#7277")
                        end
                        (var"##value#7279", __varinfo__) = (DynamicPPL.tilde_observe!!)(__context__, (DynamicPPL.check_tilde_rhs)(var"##dist#7280"), x, var"##vn#7277", __varinfo__)
                        var"##value#7279"
                    end
                #= /home/tor/.julia/packages/DynamicPPL/m0PXI/src/compiler.jl:556 =#
                return (var"##retval#7282", __varinfo__)
            end
        end
    end
    begin
        $(Expr(:meta, :doc))
        function f(; )
            #= In[245]:1 =#
            return (DynamicPPL.Model)(f, NamedTuple{()}(()); )
        end
    end
end
</pre>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Transparency-split">

<p>
I told you didn't want to see that.<br />
</p>

<p>
Can make it <i>a bit</i> cleaner by removing linenums:<br />
</p>

<div class="x-small-text">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@macroexpand</span>(<span style="color: #808080;">@model</span> f() = x ~ Normal()) |&gt; Base.remove_linenums!
</code></pre>
</div>

<pre class="example" id="orgf35e95f">
quote
    function f(__model__::DynamicPPL.Model, __varinfo__::DynamicPPL.AbstractVarInfo, __context__::AbstractPPL.AbstractContext; )
        begin
            var"##dist#7286" = Normal()
            var"##vn#7283" = (DynamicPPL.resolve_varnames)((AbstractPPL.VarName){:x}(), var"##dist#7286")
            var"##isassumption#7284" = begin
                    if (DynamicPPL.contextual_isassumption)(__context__, var"##vn#7283")
                        if !((DynamicPPL.inargnames)(var"##vn#7283", __model__)) || (DynamicPPL.inmissings)(var"##vn#7283", __model__)
                            true
                        else
                            x === missing
                        end
                    else
                        false
                    end
                end
            begin
                var"##retval#7288" = if (DynamicPPL.contextual_isfixed)(__context__, var"##vn#7283")
                        x = (DynamicPPL.getfixed_nested)(__context__, var"##vn#7283")
                    elseif var"##isassumption#7284"
                        begin
                            (var"##value#7287", __varinfo__) = (DynamicPPL.tilde_assume!!)(__context__, (DynamicPPL.unwrap_right_vn)((DynamicPPL.check_tilde_rhs)(var"##dist#7286"), var"##vn#7283")..., __varinfo__)
                            x = var"##value#7287"
                            var"##value#7287"
                        end
                    else
                        if !((DynamicPPL.inargnames)(var"##vn#7283", __model__))
                            x = (DynamicPPL.getconditioned_nested)(__context__, var"##vn#7283")
                        end
                        (var"##value#7285", __varinfo__) = (DynamicPPL.tilde_observe!!)(__context__, (DynamicPPL.check_tilde_rhs)(var"##dist#7286"), x, var"##vn#7283", __varinfo__)
                        var"##value#7285"
                    end
                return (var"##retval#7288", __varinfo__)
            end
        end
    end
    begin
        $(Expr(:meta, :doc))
        function f(; )
            return (DynamicPPL.Model)(f, NamedTuple{()}(()); )
        end
    end
end
</pre>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Transparency-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #006699;">f</span>(x) = 2x
</code></pre>
</div>

<pre class="example">
f (generic function with 1 method)
</pre>


<p>
You can inspect the type-inferred and lowered code<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@code_typed</span> f(1)
</code></pre>
</div>

<pre class="example">
CodeInfo(
1 ─ %1 = Base.mul_int(2, x)::Int64
└──      return %1
) =&gt; Int64
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Transparency-split">

<p>
You can inspect the LLVM code<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@code_llvm</span> f(1)
</code></pre>
</div>

<pre class="example">
;  @ In[247]:1 within `f`
define i64 @julia_f_40807(i64 signext %0) #0 {
top:
; ┌ @ int.jl:88 within `*`
   %1 = shl i64 %0, 1
; └
  ret i64 %1
}
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Transparency-split">

<p>
And even the resulting machine code<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@code_native</span> f(1)
</code></pre>
</div>

<pre class="example" id="org54ca9d4">
	.text
	.file	"f"
	.globl	julia_f_40844                   # -- Begin function julia_f_40844
	.p2align	4, 0x90
	.type	julia_f_40844,@function
julia_f_40844:                          # @julia_f_40844
; ┌ @ In[247]:1 within `f`
	.cfi_startproc
# %bb.0:                                # %top
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset %rbp, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register %rbp
; │┌ @ int.jl:88 within `*`
	leaq	(%rdi,%rdi), %rax
; │└
	popq	%rbp
	.cfi_def_cfa %rsp, 8
	retq
.Lfunc_end0:
	.size	julia_f_40844, .Lfunc_end0-julia_f_40844
	.cfi_endproc
; └
                                        # -- End function
	.section	".note.GNU-stack","",@progbits
</pre>

<p>
It really just depends on which level of "I hate my life" you're currently at<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Calling-into-other-languages">
<h4 id="2023-01-29-16-57-28-Calling-into-other-languages">Calling into other languages</h4>
<ul>
<li><a href="https://docs.julialang.org/en/v1/manual/calling-c-and-fortran-code/">C and Fortran comes built-in stdlib</a><br /></li>
<li><a href="https://juliainterop.github.io/RCall.jl/stable/">RCall.jl</a>: call into <code>R</code><br /></li>
<li><a href="https://github.com/JuliaPy/PyCall.jl">PyCall.jl</a>: call into <code>python</code><br /></li>
<li>Etc.<br /></li>

</ul>

<p>
When working with <code>Array</code>, etc. memory is usually shared ⟹ fairly low overhead<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-C-and-Fortran">
<h4 id="2023-01-29-16-57-28-C-and-Fortran">C and Fortran</h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Define the Julia function</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">mycompare</span>(a, b)::<span style="color: #6434A3;">Cint</span>
    println(<span style="color: #008000;">"mycompare($a, $b)"</span>)  <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Let's look at the comparisons made.</span>
    <span style="color: #0000FF;">return</span> (a &lt; b) <span style="color: #0000FF;">?</span> -1 : ((a &gt; b) ? +1 <span style="color: #0000FF;">:</span> 0)
<span style="color: #0000FF;">end</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Get the corresponding C function pointer.</span>
mycompare_c = <span style="color: #808080;">@cfunction</span>(mycompare, Cint, (Ref{Cdouble}, Ref{Cdouble}))

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Array to sort.</span>
arr = [1.3, -2.7, 4.4, 3.1];

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Call in-place quicksort.</span>
<span style="color: #006FE0;">ccall</span>(<span style="color: #D0372D;">:qsort</span>, <span style="color: #D0372D;">Cvoid</span>, (Ptr{Cdouble}, Csize_t, Csize_t, Ptr{<span style="color: #D0372D;">Cvoid</span>}),
      arr, length(arr), sizeof(eltype(arr)), mycompare_c)
</code></pre>
</div>

<pre class="example">
mycompare(1.3, -2.7)
mycompare(4.4, 3.1)
mycompare(-2.7, 3.1)
mycompare(1.3, 3.1)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">All sorted!</span>
arr
</code></pre>
</div>

<pre class="example">
4-element Vector{Float64}:
 -2.7
  1.3
  3.1
  4.4
</pre>


<p>
<a href="https://docs.julialang.org/en/v1/manual/calling-c-and-fortran-code/#Creating-C-Compatible-Julia-Function-Pointers">Example is from Julia docs</a><br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-The-Bad">
<h4 id="2023-01-29-16-57-28-The-Bad">The Bad</h4>
<p>
Sometimes<br />
</p>
<ul>
<li>your code might just slow down without a seemingly good reason,<br /></li>
<li>someone did bad, and Julia can't tell which method to call, or<br /></li>
<li>someone forces the Julia compiler to compile insane amounts of code<br /></li>

</ul>

</section>
<section id="slide-2023-01-29-16-57-28-Why-is-my-code-suddenly-slow">
<h4 id="2023-01-29-16-57-28-Why-is-my-code-suddenly-slow">"Why is my code suddenly slow?"</h4>
<p>
One word: <b>type-instability</b><br />
</p>

<p>
Sometimes the Julia compiler can't quite infer what types fully<br />
</p>

<div class="fragment (appear)">

<p>
<b>Result:</b> python-like performance (for those particular function calls)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> this is NOT `const`, and so it could become some other type</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">at any given point without `my_func` knowing about it!</span>
global_variable = 1
<span style="color: #006699;">my_func_unstable</span>(x) = global_variable * x
</code></pre>
</div>

<pre class="example">
my_func_unstable (generic function with 1 method)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> BenchmarkTools
<span style="color: #808080;">@btime</span> my_func_unstable(2.0);
</code></pre>
</div>

<pre class="example">
19.901 ns (2 allocations: 32 bytes)
</pre>


</div>

</section>
<section id="slide-2023-01-29-16-57-28-Why-is-my-code-suddenly-slow-split">

<p>
Luckily there are tools for inspecting this<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@code_warntype</span> my_func_unstable(2.0)
</code></pre>
</div>

<pre class="example" id="orga8230ad">
MethodInstance for my_func_unstable(::Float64)
  from my_func_unstable(x) @ Main In[253]:4
Arguments
  #self#::Core.Const(my_func_unstable)
  x::Float64
Body::Any
1 ─ %1 = (Main.global_variable * x)::Any
└──      return %1
</pre>

<p>
See that <code>Any</code> there? <span class="underline">'tis a big no-no!</span><br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Why-is-my-code-suddenly-slow-split">

<p>
Once discovered, it can be fixed<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">const</span> constant_global_variable = 1
<span style="color: #006699;">my_func_fixed</span>(x) = constant_global_variable * x
<span style="color: #808080;">@code_warntype</span> my_func_fixed(2.0)
</code></pre>
</div>

<pre class="example">
MethodInstance for my_func_fixed(::Float64)
  from my_func_fixed(x) @ Main In[257]:2
Arguments
  #self#::Core.Const(my_func_fixed)
  x::Float64
Body::Float64
1 ─ %1 = (Main.constant_global_variable * x)::Float64
└──      return %1

</pre>


<p>
So long Python performance!<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@btime</span> my_func_fixed(2.0);
</code></pre>
</div>

<pre class="example">
1.238 ns (0 allocations: 0 bytes)
</pre>



</section>
<section id="slide-2023-01-29-16-57-28-Why-is-my-code-suddenly-slow-split">

<p>
<i>But</i> this is not always so easy to discover (though this is generally rare)<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #D0372D; font-weight: bold; font-style: italic;">HACK:</span><span style="color: #8D8D84; font-style: italic;"> Here we explicitly tell Julia what type `my_func_unstable`</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">returns. This is _very_ rarely a good idea because it just hides</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">the underlying problem from `@code_warntype`!</span>
<span style="color: #006699;">my_func_forced</span>(x) = my_func_unstable(x)::<span style="color: #6434A3;">typeof</span>(x)
<span style="color: #808080;">@code_warntype</span> my_func_forced(2.0)
</code></pre>
</div>

<pre class="example" id="org9ede0a1">
MethodInstance for my_func_forced(::Float64)
  from my_func_forced(x) @ Main In[259]:4
Arguments
  #self#::Core.Const(my_func_forced)
  x::Float64
Body::Float64
1 ─ %1 = Main.my_func_unstable(x)::Any
│   %2 = Main.typeof(x)::Core.Const(Float64)
│   %3 = Core.typeassert(%1, %2)::Float64
└──      return %3
</pre>

<p>
We can still see the <code>Any</code> in there, but on a first glance it looks like <code>my_func_forced</code> is type-stable<br />
</p>

<p>
There are more natural cases where this might occur, e.g. unfortunate closures deep in your callstack<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Why-is-my-code-suddenly-slow-split">

<p>
To discovery these there are a couple of more advanced tools:<br />
</p>
<ul>
<li><a href="https://github.com/JuliaDebug/Cthulhu.jl">Cthulhu.jl</a>: Allows you to step through your code like a debugger and perform <code>@code_warntype</code><br /></li>
<li><a href="https://github.com/aviatesk/JET.jl">JET.jl</a>: Experimental package which attempts to automate the process<br /></li>

</ul>

<p>
And even simpler: profile using <a href="https://github.com/timholy/ProfileView.jl">ProfileView.jl</a> and look for code-paths that <i>should</i> be fast but take up a lot of the runtime<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Why-is-my-code-suddenly-slow-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">using</span> ProfileView
</code></pre>
</div>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@profview</span> foreach(_ -&gt; my_func_unstable(2.0), 1_000_000)
</code></pre>
</div>


<div id="org5f651fa" class="figure">
<p><img src="assets/attachments/2023-01-25_01-16-13_Screenshot_20230125_011603.png" alt="2023-01-25_01-16-13_Screenshot_20230125_011603.png" height="350px" /><br />
</p>
</div>

<p>
Note that there's no sign of multiplication here<br />
</p>

<p>
But most of the runtime is the <code>./reflection.jl</code> at the top there<br />
</p>

<p>
That's Julia looking up the type at runtime<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Method-ambiguity">
<h4 id="2023-01-29-16-57-28-Method-ambiguity">Method ambiguity</h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #006699;">ambiguous_function</span>(x, y::<span style="color: #6434A3;">Int</span>) = y
<span style="color: #006699;">ambiguous_function</span>(x::<span style="color: #6434A3;">Int</span>, y) = x

<span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> Here we have `ambiguous_function(x::Int, y::Int)`</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which one should we hit?!</span>
ambiguous_function(1, 2)
</code></pre>
</div>

<pre class="example" id="org802e42b">
MethodError: ambiguous_function(::Int64, ::Int64) is ambiguous.

Candidates:
  ambiguous_function(x, y::Int64)
    @ Main In[261]:1
  ambiguous_function(x::Int64, y)
    @ Main In[261]:2

Possible fix, define
  ambiguous_function(::Int64, ::Int64)


Stacktrace:
 [1] top-level scope
   @ In[261]:6
</pre>

<p>
But here Julia warns us, and so we can fix this by just doing as it says: define <code>ambiguous_function(::Int64, ::Int64)</code><br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #006699;">ambiguous_function</span>(::<span style="color: #6434A3;">Int64</span>, ::<span style="color: #6434A3;">Int64</span>) = <span style="color: #008000;">"neato"</span>
ambiguous_function(1, 2)
</code></pre>
</div>

<pre class="example">
"neato"
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Long-compilation-times">
<h4 id="2023-01-29-16-57-28-Long-compilation-times">Long compilation times</h4>
<p>
In Julia, for better or worse, we can generate code<br />
</p>

<p>
<b>Problem:</b> it can be <i>lots</i> of code of we really want to<br />
</p>

<p>
<b>Result:</b> first execution can be <i>slow</i><br />
</p>

<div class="fragment (appear)">

<p>
<b>Time to first plot (TTFP)</b> is Julia's worst enemy<br />
</p>

<p>
But things are always improving<br />
</p>


<div id="orgaf8f5cf" class="figure">
<p><img src="assets/attachments/2023-01-25_01-29-05_Screenshot_20230125_012853.png" alt="2023-01-25_01-29-05_Screenshot_20230125_012853.png" /><br />
</p>
</div>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Another-example-mis-use-of-generated">
<h4 id="2023-01-29-16-57-28-Another-example-mis-use-of-generated">Another example: mis-use of <code>@generated</code></h4>
<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> `@generated` only has access to static information, e.g. types of arguments.</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Here I'm using the special type `Val` to make a number `N` static.</span>
<span style="color: #808080;">@generated</span> <span style="color: #0000FF;">function</span> unrolled_addition(::<span style="color: #6434A3;">Val</span>{N}) <span style="color: #0000FF;">where</span> {N}
    expr = Expr(<span style="color: #D0372D;">:block</span>)
    push!(expr.args, :(x = 0))
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">=</span> 1:N
        push!(expr.args, :(x += $(3.14 * i)))
    <span style="color: #0000FF;">end</span>

    <span style="color: #0000FF;">return</span> expr
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
unrolled_addition (generic function with 1 method)
</pre>


<p>
When I call this with some <code>Val(N)</code>, Julia will execute this <i>at compile-time</i>!<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> At runtime, it then just returns the result immediately</span>
<span style="color: #808080;">@code_typed</span> unrolled_addition(Val(10))
</code></pre>
</div>

<pre class="example">
CodeInfo(
1 ─     return 172.70000000000002
) =&gt; Float64
</pre>


<p>
But if I just change the value <code>10</code> to <code>11</code>, it's a <i>completely</i> different type!<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Another-example-mis-use-of-generated-split">

<p>
So Julia has to compile <code>unrolled_addition</code> from scratch<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@time</span> <span style="color: #808080;">@eval</span> unrolled_addition(Val(11));
</code></pre>
</div>

<pre class="example">
0.008437 seconds (10.35 k allocations: 620.520 KiB)
</pre>


<p>
Or a bit crazier<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@time</span> <span style="color: #808080;">@eval</span> unrolled_addition(Val(10_001));
</code></pre>
</div>

<pre class="example">
0.269772 seconds (782.52 k allocations: 37.372 MiB, 9.83% gc time)
</pre>


<p>
Here it took ~0.4s, of which 99.95% was compilation time<br />
</p>

<p>
I think you get the idea<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Another-example-mis-use-of-generated-split">

<p>
But boy is it fast to run!<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@btime</span> unrolled_addition(Val(10_001));
</code></pre>
</div>

<pre class="example">
1.080 ns (0 allocations: 0 bytes)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #0000FF;">function</span> <span style="color: #006699;">not_unrolled_addition</span>(N)
    x = 0
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">=</span> 1:N
        x += 3.14 * i
    <span style="color: #0000FF;">end</span>

    <span style="color: #0000FF;">return</span> x
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
not_unrolled_addition (generic function with 1 method)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@btime</span> not_unrolled_addition(10_001);
</code></pre>
</div>

<pre class="example">
8.522 μs (0 allocations: 0 bytes)
</pre>


</section>
<section id="slide-2023-01-29-16-57-28-Another-example-mis-use-of-generated-split">

<p>
<b>Funny side-note:</b> at first I did the following<br />
</p>

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@generated</span> <span style="color: #0000FF;">function</span> unrolled_addition_old(::<span style="color: #6434A3;">Val</span>{N}) <span style="color: #0000FF;">where</span> {N}
    expr = Expr(<span style="color: #D0372D;">:block</span>)
    push!(expr.args, :(x = 0))
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">=</span> 1:N
        push!(expr.args, :(x += <span style="color: #D0372D;">$i</span>))  <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> No 3.14!</span>
    <span style="color: #0000FF;">end</span>
    <span style="color: #0000FF;">return</span> expr
<span style="color: #0000FF;">end</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">not_unrolled_addition_old</span>(N)
    x = 0
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">=</span> 1:N
        x += i  <span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> No 3.14!</span>
    <span style="color: #0000FF;">end</span>
    <span style="color: #0000FF;">return</span> x
<span style="color: #0000FF;">end</span>
</code></pre>
</div>

<pre class="example">
not_unrolled_addition_old (generic function with 1 method)
</pre>


<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #808080;">@btime</span> unrolled_addition_old(Val(10_001));
<span style="color: #808080;">@btime</span> not_unrolled_addition_old(10_001);
</code></pre>
</div>

<pre class="example">
1.080 ns (0 allocations: 0 bytes)
2.227 ns (0 allocations: 0 bytes)
</pre>


<p>
LLVM probably recognized the pattern of <code>not_unrolled_addition_old</code> and unrolls it for us<br />
</p>

<p>
Let's check!<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Another-example-mis-use-of-generated-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> The one LLVM failed to unroll</span>
<span style="color: #808080;">@code_llvm</span> not_unrolled_addition(10_001)
</code></pre>
</div>

<pre class="example" id="org8ae80e3">
;  @ In[268]:1 within `not_unrolled_addition`
define { {}*, i8 } @julia_not_unrolled_addition_41667([8 x i8]* noalias nocapture noundef nonnull align 8 dereferenceable(8) %0, i64 signext %1) #0 {
top:
;  @ In[268]:3 within `not_unrolled_addition`
; ┌ @ range.jl:5 within `Colon`
; │┌ @ range.jl:397 within `UnitRange`
; ││┌ @ range.jl:404 within `unitrange_last`
     %.inv = icmp sgt i64 %1, 0
     %. = select i1 %.inv, i64 %1, i64 0
; └└└
  br i1 %.inv, label %L17.preheader, label %union_move16

L17.preheader:                                    ; preds = %top
;  @ In[268]:5 within `not_unrolled_addition`
; ┌ @ range.jl:891 within `iterate`
; │┌ @ promotion.jl:499 within `==`
    %.not30 = icmp eq i64 %., 1
; └└
  br i1 %.not30, label %union_move, label %L48

L48:                                              ; preds = %L48, %L17.preheader
  %value_phi1032 = phi double [ %value_phi10, %L48 ], [ 3.140000e+00, %L17.preheader ]
  %value_phi431 = phi i64 [ %2, %L48 ], [ 1, %L17.preheader ]
; ┌ @ range.jl:891 within `iterate`
   %2 = add i64 %value_phi431, 1
; └
;  @ In[268]:4 within `not_unrolled_addition`
; ┌ @ promotion.jl:411 within `*`
; │┌ @ promotion.jl:381 within `promote`
; ││┌ @ promotion.jl:358 within `_promote`
; │││┌ @ number.jl:7 within `convert`
; ││││┌ @ float.jl:159 within `Float64`
       %3 = sitofp i64 %2 to double
; │└└└└
; │ @ promotion.jl:411 within `*` @ float.jl:410
   %4 = fmul double %3, 3.140000e+00
; └
;  @ In[268] within `not_unrolled_addition`
  %value_phi10 = fadd double %value_phi1032, %4
;  @ In[268]:5 within `not_unrolled_addition`
; ┌ @ range.jl:891 within `iterate`
; │┌ @ promotion.jl:499 within `==`
    %.not = icmp eq i64 %2, %.
; └└
  br i1 %.not, label %L17.union_move_crit_edge, label %L48

post_union_move:                                  ; preds = %union_move16, %union_move
  %tindex_phi1429 = phi i8 [ 2, %union_move16 ], [ 1, %union_move ]
;  @ In[268]:7 within `not_unrolled_addition`
  %5 = insertvalue { {}*, i8 } { {}* null, i8 undef }, i8 %tindex_phi1429, 1
  ret { {}*, i8 } %5

L17.union_move_crit_edge:                         ; preds = %L48
;  @ In[268]:5 within `not_unrolled_addition`
  %phi.cast = bitcast double %value_phi10 to i64
  br label %union_move

union_move:                                       ; preds = %L17.union_move_crit_edge, %L17.preheader
  %value_phi10.lcssa = phi i64 [ %phi.cast, %L17.union_move_crit_edge ], [ 4614253070214989087, %L17.preheader ]
;  @ In[268]:7 within `not_unrolled_addition`
  %6 = bitcast [8 x i8]* %0 to i64*
  store i64 %value_phi10.lcssa, i64* %6, align 8
  br label %post_union_move

union_move16:                                     ; preds = %top
  %7 = bitcast [8 x i8]* %0 to i64*
  store i64 0, i64* %7, align 8
  br label %post_union_move
}
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-Another-example-mis-use-of-generated-split">

<div class="org-src-container">

<pre  class="src src-julia"   ><code trim><span style="color: #8D8D84;"># </span><span style="color: #00ff00; font-weight: bold; font-style: italic;">NOTE:</span><span style="color: #8D8D84; font-style: italic;"> The one LLVM seems to have unrolled.</span>
<span style="color: #808080;">@code_llvm</span> not_unrolled_addition_old(10_001)
</code></pre>
</div>

<pre class="example" id="org6f43908">
;  @ In[270]:9 within `not_unrolled_addition_old`
define i64 @julia_not_unrolled_addition_old_41669(i64 signext %0) #0 {
top:
;  @ In[270]:11 within `not_unrolled_addition_old`
; ┌ @ range.jl:5 within `Colon`
; │┌ @ range.jl:397 within `UnitRange`
; ││┌ @ range.jl:404 within `unitrange_last`
     %.inv = icmp sgt i64 %0, 0
     %. = select i1 %.inv, i64 %0, i64 0
; └└└
  br i1 %.inv, label %L17.preheader, label %L32

L17.preheader:                                    ; preds = %top
;  @ In[270]:13 within `not_unrolled_addition_old`
  %1 = shl nuw i64 %., 1
  %2 = add nsw i64 %., -1
  %3 = zext i64 %2 to i65
  %4 = add nsw i64 %., -2
  %5 = zext i64 %4 to i65
  %6 = mul i65 %3, %5
  %7 = lshr i65 %6, 1
  %8 = trunc i65 %7 to i64
  %9 = add i64 %1, %8
  %10 = add i64 %9, -1
;  @ In[270]:14 within `not_unrolled_addition_old`
  br label %L32

L32:                                              ; preds = %L17.preheader, %top
  %value_phi10 = phi i64 [ 0, %top ], [ %10, %L17.preheader ]
  ret i64 %value_phi10
}
</pre>

</section>
<section id="slide-2023-01-29-16-57-28-The-Ugly">
<h4 id="2023-01-29-16-57-28-The-Ugly">The Ugly</h4>
</section>
<section id="slide-2023-01-29-16-57-28-The-Ugly-split">

<p>
<span class="underline"><b>Reverse-mode automatic differentiation</b></span><br />
</p>

<p>
ForwardDiff.jl is a pure joy, but slows down as dimensionality grows<br />
</p>

<p>
Then one should reach for ReverseDiff.jl or Zygote.jl<br />
</p>

<div class="fragment (appear)">
<p>
Most of the time it works really well, but sometimes you hit a real sharp edge<br />
</p>

<p>
And sharp edges cut; they cut <i>deep</i><br />
</p>

<p>
Like <span class="underline">"16X slower when the function is implemented more efficiently"-deep</span><br />
</p>


<div id="org478f639" class="figure">
<p><img src="assets/attachments/2023-01-25_01-01-31_Screenshot_20230125_010111.png" alt="2023-01-25_01-01-31_Screenshot_20230125_010111.png" /><br />
</p>
</div>

</div>

<div class="fragment (appear)">

<p>
If you want to see a man in pain, you can find the full issue <a href="https://github.com/TuringLang/Turing.jl/issues/1934">here</a><br />
</p>

<p>
On the flip-side, once addressed (a type-instability), it's <a href="https://github.com/TuringLang/DistributionsAD.jl/pull/231">3X faster than before</a><br />
</p>

</div>

</section>
<section id="slide-2023-01-29-16-57-28-Overall">
<h4 id="2023-01-29-16-57-28-Overall">Overall</h4>
<p>
Julia is pretty darn awesome<br />
</p>

<p>
Easy to get going, and you can always make it faster by just optimizing <span class="underline">Julia</span> code<br />
</p>

<p>
No need to drop down to C++<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Overall-split">
<p>
Buuuut it can't beat Python at deep learning<br />
</p>

</section>
<section id="slide-2023-01-29-16-57-28-Overall-split">
<p>
Otherwise, it's worth a try<br />
</p>

<p>
Godspeed to you<br />
</p>

</section>
</section>
<section>
<section id="slide-orgbc2a34b">
<h2 id="orgbc2a34b">Fin</h2>
</section>
</section>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.1.0/reveal.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.1.0/plugin/markdown/markdown.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.1.0/plugin/zoom/zoom.js"></script>


<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
plugins: [RevealMarkdown, RevealZoom],
slideNumber:true
});

</script>
</body>
</html>
